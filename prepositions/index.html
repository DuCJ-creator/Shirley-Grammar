<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>Shirley's Grammar | Prepositions Masterclass</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,500;0,700;1,500&family=Inter:wght@400;500;600&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    :root {
      /* --- æ ¸å¿ƒé…è‰² --- */
      --primary-tone: #3a5a40; /* æ£®æ—æ·±ç¶  */
      --secondary-tone: #c9a972; /* å¾©å¤é‡‘ */
      --text-main: #333333;
      --bg-cream: #faf8f2;
      --highlight-bg: #f0eadd;
      
      /* --- å°ºå¯¸è®Šæ•¸ --- */
      --node-size: 115px; 
      --center-size: 200px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Inter', 'Noto Sans TC', sans-serif;
      background-color: var(--bg-cream);
      color: var(--text-main);
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      position: relative;
    }

    /* === 1. èƒŒæ™¯æ¼‚æµ®ä»‹ä¿‚è© === */
    .floating-objects {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none; z-index: 0; overflow: hidden;
    }
    .float-item {
      position: absolute; opacity: 0.08;
      font-family: 'Playfair Display', serif; font-weight: 700;
      color: var(--primary-tone);
      animation: floatUp 25s infinite linear;
      white-space: nowrap;
    }
    @keyframes floatUp {
      0% { transform: translateY(110vh) rotate(0deg); }
      100% { transform: translateY(-20vh) rotate(360deg); }
    }

    /* === 2. Mind Map èˆå° === */
    .mindmap-stage {
      position: relative; width: 100%; height: 100%;
      display: flex; justify-content: center; align-items: center;
      z-index: 10;
    }
    .connections {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none; z-index: 1;
    }
    .connection-line {
      stroke: var(--secondary-tone); stroke-width: 2;
      stroke-dasharray: 6, 6; opacity: 0.4;
    }

    /* æ ¸å¿ƒ Core */
    .core-node {
      width: var(--center-size); height: var(--center-size);
      background: var(--primary-tone); color: white;
      border-radius: 50%;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      text-align: center; z-index: 5;
      box-shadow: 0 0 0 12px rgba(58, 90, 64, 0.08), 0 25px 50px rgba(0,0,0,0.25);
      animation: corePulse 5s infinite ease-in-out; cursor: default;
    }
    .core-title { font-family: 'Playfair Display', serif; font-size: 1.8rem; font-weight: 700; line-height: 1.1; }
    .core-sub { font-size: 0.75rem; letter-spacing: 2px; text-transform: uppercase; margin-top: 8px; color: var(--secondary-tone); }

    @keyframes corePulse {
      0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); }
    }

    /* å­ç¯€é» Satellite */
    .satellite {
      position: absolute; width: var(--node-size); height: var(--node-size);
      border-radius: 50%; background: white;
      border: 2px solid var(--primary-tone);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      text-align: center; cursor: pointer; z-index: 5;
      box-shadow: 0 10px 25px rgba(58, 90, 64, 0.1);
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      font-family: 'Playfair Display', serif; font-weight: 600;
      font-size: 0.85rem; color: var(--primary-tone); padding: 5px;
    }
    .satellite:hover {
      transform: scale(1.15); background: var(--primary-tone);
      color: white; border-color: var(--secondary-tone);
      box-shadow: 0 15px 35px rgba(58, 90, 64, 0.3); z-index: 10;
    }

    .step-badge {
      position: absolute; top: -5px; left: 50%; transform: translateX(-50%);
      background: var(--secondary-tone); color: white;
      font-family: 'Inter', sans-serif; font-size: 0.8rem; font-weight: 700;
      width: 24px; height: 24px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    /* ç‰¹æ®Šç¯€é»ï¼šVisual Lab (å¼·èª¿è‰²) */
    .satellite.visual-node { border-color: #00897b; color: #00695c; }
    .satellite.visual-node .step-badge { background: #00897b; }
    .satellite.visual-node:hover { background: #00897b; color: white; }

    /* ç‰¹æ®Šç¯€é»ï¼šQuiz */
    .satellite.quiz-node { border-color: var(--secondary-tone); background: #fffcf5; }
    .satellite.quiz-node .step-badge { background: #d32f2f; }

    /* === 3. Modal å…§å®¹å€ === */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(250, 248, 242, 0.95); backdrop-filter: blur(5px);
      z-index: 100; opacity: 0; pointer-events: none;
      transition: opacity 0.3s ease;
      display: flex; justify-content: center; align-items: center;
    }
    .modal-overlay.active { opacity: 1; pointer-events: auto; }

    .modal-content {
      width: 90%; max-width: 950px; max-height: 85vh;
      background: white; border-radius: 16px;
      box-shadow: 0 25px 60px rgba(0,0,0,0.2);
      border-top: 6px solid var(--primary-tone);
      overflow-y: auto; padding: 40px;
      display: none; animation: slideUp 0.4s ease-out;
    }
    @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    .close-btn {
      position: absolute; top: 20px; right: 20px;
      width: 40px; height: 40px; border-radius: 50%; border: none;
      background: #f4f4f4; color: var(--text-main); font-size: 1.5rem;
      cursor: pointer; transition: all 0.2s; z-index: 20;
    }
    .close-btn:hover { background: var(--secondary-tone); color: white; }

    /* å…§å®¹æ’ç‰ˆ */
    h2 { font-family: 'Playfair Display', serif; font-size: 2rem; color: var(--primary-tone); margin-bottom: 20px; border-bottom: 2px solid var(--secondary-tone); padding-bottom: 10px; }
    h3 { font-family: 'Playfair Display', serif; font-size: 1.3rem; color: var(--primary-tone); margin: 30px 0 15px; border-left: 4px solid var(--secondary-tone); padding-left: 12px; }
    
    .bilingual-box { display: flex; gap: 20px; background: #fbfbf9; padding: 25px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 20px; }
    .highlight { background: var(--highlight-bg); padding: 2px 6px; border-radius: 4px; color: var(--primary-tone); font-weight: 600; }
    
    /* Table */
    .table-responsive { overflow-x: auto; margin: 20px 0; border: 1px solid #e8e4d9; border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th { background: #f4f1ea; color: var(--primary-tone); padding: 15px; text-align: left; font-family: 'Playfair Display', serif; border-bottom: 2px solid #e8e4d9; white-space: nowrap; }
    td { padding: 14px; border-bottom: 1px solid #eee; }
    tr:nth-child(even) { background-color: #fcfcfc; }

    /* Canvas Lab Style */
    .canvas-wrapper {
      width: 100%; height: 350px; background: #fdfdfd; 
      border: 2px solid #eee; border-radius: 12px; 
      position: relative; margin-bottom: 20px;
      overflow: hidden;
    }
    canvas { width: 100%; height: 100%; }
    .scene-controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
    .scene-btn {
      padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 50px; cursor: pointer; font-size: 0.9rem; transition: 0.2s;
    }
    .scene-btn.active, .scene-btn:hover { background: var(--primary-tone); color: white; border-color: var(--primary-tone); }

    /* Quiz Styling */
    .quiz-progress { text-align: right; color: var(--secondary-tone); font-weight: 700; margin-bottom: 15px; }
    .quiz-question-box { background: #fff; padding: 25px; border-radius: 12px; border: 1px solid #eee; box-shadow: 0 4px 15px rgba(0,0,0,0.03); margin-bottom: 20px; }
    .quiz-q-text { font-size: 1.2rem; font-weight: 600; color: var(--primary-tone); margin-bottom: 20px; }
    .quiz-opt { display: block; width: 100%; padding: 15px 20px; margin-bottom: 10px; border: 2px solid #f0f0f0; border-radius: 8px; background: white; text-align: left; cursor: pointer; transition: all 0.2s; font-size: 1rem; }
    .quiz-opt:hover:not(:disabled) { border-color: var(--secondary-tone); background: #fffbf5; }
    .quiz-opt.correct { background: #e8f5e9; border-color: #4caf50; color: #2e7d32; }
    .quiz-opt.incorrect { background: #ffebee; border-color: #ef5350; color: #c62828; }
    
    .explanation { margin-top: 20px; padding: 15px; background: #faf8f2; border-left: 4px solid var(--secondary-tone); display: none; }
    .explanation.show { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
    
    .result-card { text-align: center; padding: 40px; display: none; }
    .result-score { font-size: 4rem; font-family: 'Playfair Display', serif; color: var(--primary-tone); font-weight: 700; }
    
    .btn-cta { background: var(--secondary-tone); color: white; padding: 12px 30px; border-radius: 50px; border: none; font-size: 1rem; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; transition: 0.3s; font-weight: 600; margin-top: 15px; }
    .btn-cta:hover { background: var(--primary-tone); transform: translateY(-2px); }

    /* RWD */
    @media (max-width: 768px) {
      body { overflow-y: auto; height: auto; }
      .floating-objects { height: 100vh; position: fixed; }
      .mindmap-stage { flex-direction: column; height: auto; padding: 50px 20px; }
      .connections { display: none; }
      .core-node { margin-bottom: 40px; width: 160px; height: 160px; }
      .satellite { 
        position: relative; top: auto !important; left: auto !important; transform: none !important;
        width: 100%; min-height: 70px; margin-bottom: 12px; flex-direction: row; 
        justify-content: flex-start; text-align: left; gap: 20px; padding: 15px 25px;
      }
      .satellite:hover { transform: translateY(-3px) !important; }
      .step-badge { position: static; transform: none; margin-right: 0; min-width: 24px; }
      .modal-content { padding: 25px; width: 95%; max-height: 90vh; }
      .bilingual-box { flex-direction: column; }
    }
  </style>
</head>
<body>

  <div class="floating-objects" id="floatingBg"></div>

  <div class="mindmap-stage" id="stage">
    <svg class="connections" id="svgLines"></svg>

    <div class="core-node">
      <div class="core-title">Shirley's<br>Preps.</div>
      <div class="core-sub">Complete Guide</div>
    </div>

    <div class="satellite" data-target="pyramid-modal">
      <div class="step-badge">1</div>
      <div>The Pyramid<br>å€’ä¸‰è§’æ³•å‰‡</div>
    </div>
    
    <div class="satellite" data-target="position-modal">
      <div class="step-badge">2</div>
      <div>Position<br>ç©ºé–“ä½ç½®</div>
    </div>
    
    <div class="satellite" data-target="motion-modal">
      <div class="step-badge">3</div>
      <div>Motion<br>å‹•æ…‹è·¯å¾‘</div>
    </div>
    
    <div class="satellite" data-target="trans-modal">
      <div class="step-badge">4</div>
      <div>Transport<br>äº¤é€šå·¥å…·</div>
    </div>

    <div class="satellite visual-node" data-target="visual-modal">
      <div class="step-badge">5</div>
      <div>Visual Lab<br>å‹•æ…‹å¯¦é©—å®¤</div>
    </div>

    <div class="satellite" data-target="phrase-modal">
      <div class="step-badge">6</div>
      <div>Phrases<br>å‹•è©ç‰‡èª</div>
    </div>

    <div class="satellite" data-target="mistake-modal">
      <div class="step-badge">7</div>
      <div>Mistakes<br>æ˜“éŒ¯æé†’</div>
    </div>
    
    <div class="satellite quiz-node" data-target="quiz-modal">
      <div class="step-badge">8</div>
      <div>Quiz<br>20é¡ŒæŒ‘æˆ°</div>
    </div>
  </div>

  <div class="modal-overlay" id="modalOverlay">
    <button class="close-btn" onclick="closeModal()">âœ•</button>

    <div id="pyramid-modal" class="modal-content">
      <h2>1. The Pyramid Rule å€’ä¸‰è§’æ³•å‰‡</h2>
      <p>é€™æ˜¯è¨˜æ†¶æ™‚é–“ (Time) èˆ‡åœ°é» (Place) æœ€å¼·å¤§çš„è¦å‰‡ã€‚æƒ³åƒä¸€å€‹å€’ä¸‰è§’å½¢ï¼š</p>
      
      <div class="bilingual-box">
        <div style="flex:1">
          <h3 style="color:#2980b9; margin-top:0;">IN (æœ€ä¸Šé¢/æœ€å¯¬)</h3>
          <p><strong>æ¦‚å¿µï¼š</strong> å¤§ç¯„åœã€é•·æ™‚é–“ã€å®¹å™¨å…§éƒ¨ã€‚</p>
          <ul>
            <li><strong>Time:</strong> Centuries, Years, Months (in 1995, in July)</li>
            <li><strong>Place:</strong> Countries, Cities, Rooms (in Taiwan, in the box)</li>
          </ul>
        </div>
        <div style="flex:1">
          <h3 style="color:#27ae60; margin-top:0;">ON (ä¸­é–“)</h3>
          <p><strong>æ¦‚å¿µï¼š</strong> ç‰¹å®šæ—¥å­ã€æ¥è§¸è¡¨é¢ã€‚</p>
          <ul>
            <li><strong>Time:</strong> Days, Dates (on Sunday, on May 1st)</li>
            <li><strong>Place:</strong> Streets, Surfaces (on the road, on the table)</li>
          </ul>
        </div>
        <div style="flex:1">
          <h3 style="color:#c0392b; margin-top:0;">AT (æœ€ä¸‹é¢/å°–ç«¯)</h3>
          <p><strong>æ¦‚å¿µï¼š</strong> ç²¾ç¢ºçš„æ™‚é–“é»ã€åœ°æ¨™ã€‚</p>
          <ul>
            <li><strong>Time:</strong> Clock time (at 5:00 PM, at noon)</li>
            <li><strong>Place:</strong> Specific points (at the bus stop, at home)</li>
          </ul>
        </div>
      </div>
      <div style="text-align:center; margin-top:10px;">
        <button class="btn-cta" onclick="openVisualLab('pyramid')">ğŸ¥ å‰å¾€å¯¦é©—å®¤è§€çœ‹å‹•ç•«</button>
      </div>
    </div>

    <div id="position-modal" class="modal-content">
      <h2>2. Position Prepositions ç©ºé–“ä½ç½®</h2>
      <div class="table-responsive">
        <table>
          <tr><th>Prep.</th><th>Meaning</th><th>Example</th></tr>
          <tr><td><strong>above / over</strong></td><td>åœ¨...ä¸Šæ–¹</td><td>The bird flew <strong>over</strong> the tree.</td></tr>
          <tr><td><strong>under / below</strong></td><td>åœ¨...ä¸‹æ–¹</td><td>The cat is <strong>under</strong> the table.</td></tr>
          <tr><td><strong>between</strong></td><td>åœ¨...ä¹‹é–“ (å…©è€…)</td><td>Sitting <strong>between</strong> Mom and Dad.</td></tr>
          <tr><td><strong>among</strong></td><td>åœ¨...ä¹‹ä¸­ (ä¸‰è€…ä»¥ä¸Š)</td><td>A house hidden <strong>among</strong> the trees.</td></tr>
          <tr><td><strong>in front of</strong></td><td>åœ¨...å‰é¢</td><td>The car is <strong>in front of</strong> the house.</td></tr>
          <tr><td><strong>behind</strong></td><td>åœ¨...å¾Œé¢</td><td>Who is standing <strong>behind</strong> you?</td></tr>
        </table>
      </div>
    </div>

    <div id="motion-modal" class="modal-content">
      <h2>3. Motion Prepositions å‹•æ…‹è·¯å¾‘</h2>
      <div class="bilingual-box">
        <div style="flex:1">
          <h3>Through vs Across</h3>
          <p><strong>Through:</strong> ç©¿éç«‹é«”ç©ºé–“å…§éƒ¨ (å¦‚éš§é“ã€æ£®æ—)ã€‚<br><em>The train went <strong>through</strong> the tunnel.</em></p>
          <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
          <p><strong>Across:</strong> æ©«è¶Šå¹³é¢è¡¨é¢ (å¦‚é¦¬è·¯ã€æ²³æµ)ã€‚<br><em>He walked <strong>across</strong> the street.</em></p>
        </div>
        <div style="flex:1">
          <h3>To vs Towards</h3>
          <p><strong>To:</strong> ç›®çš„åœ° (å¼·èª¿åˆ°é”)ã€‚<br><em>I am going <strong>to</strong> school.</em></p>
          <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
          <p><strong>Towards:</strong> æœå‘...æ–¹å‘ (ä¸ä¸€å®šåˆ°é”)ã€‚<br><em>She walked <strong>towards</strong> the door.</em></p>
        </div>
      </div>
      <div style="text-align:center;">
        <button class="btn-cta" onclick="openVisualLab('motion_through')">ğŸ¥ è§€çœ‹ Through/Across å‹•ç•«</button>
      </div>
    </div>

    <div id="trans-modal" class="modal-content">
      <h2>4. Transport: IN or ON?</h2>
      <div class="bilingual-box">
        <div style="flex:1">
          <h3 style="color:#d35400;">ON (Platform)</h3>
          <p><strong>è¦å‰‡ï¼š</strong> å¯ä»¥ç«™ç«‹èµ°å‹•ã€æœ‰ç”²æ¿çš„äº¤é€šå·¥å…·ã€‚</p>
          <ul>
            <li>on the bus</li>
            <li>on the train</li>
            <li>on the plane</li>
            <li>on a ship</li>
            <li>on a bike (é¨åœ¨ä¸Šé¢)</li>
          </ul>
        </div>
        <div style="flex:1">
          <h3 style="color:#2c3e50;">IN (Container)</h3>
          <p><strong>è¦å‰‡ï¼š</strong> å¿…é ˆå½è…°åé€²å»ã€åƒå°å®¹å™¨çš„ã€‚</p>
          <ul>
            <li>in a car</li>
            <li>in a taxi</li>
            <li>in a helicopter</li>
            <li>in a boat (å°èˆ¹)</li>
          </ul>
        </div>
      </div>
      <div style="text-align:center;">
        <button class="btn-cta" onclick="openVisualLab('transport')">ğŸ¥ è§€çœ‹äº¤é€šå·¥å…·æ¼”ç¤º</button>
      </div>
    </div>

    <div id="visual-modal" class="modal-content">
      <h2>5. Visual Lab å‹•æ…‹å¯¦é©—å®¤</h2>
      <p>é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œè§€å¯Ÿä»‹ä¿‚è©çš„è¦–è¦ºåŒ–é‚è¼¯ã€‚</p>
      
      <div class="scene-controls">
        <button class="scene-btn active" onclick="setScenario('pyramid')">ğŸ“ å€’ä¸‰è§’æ³•å‰‡</button>
        <button class="scene-btn" onclick="setScenario('motion_through')">ğŸš‡ Through vs Across</button>
        <button class="scene-btn" onclick="setScenario('surface_in')">ğŸ“¦ In vs On (ç‰©é«”)</button>
        <button class="scene-btn" onclick="setScenario('transport')" style="border-color: #d35400; color: #d35400;">ğŸšŒ Bus vs Car</button>
      </div>
      
      <div class="canvas-wrapper" id="canvasContainer">
        <canvas id="prepCanvas"></canvas>
      </div>
      
      <p id="caption" style="text-align:center; color:#666; background:#f9f9f9; padding:10px; border-radius:8px; font-weight:bold;">
        æ­£åœ¨è¼‰å…¥å‹•ç•«...
      </p>
    </div>

    <div id="phrase-modal" class="modal-content">
      <h2>6. Phrasal Verbs å‹•è©ç‰‡èª</h2>
      <p>ä»‹ä¿‚è©æ”¹è®Šäº†å‹•è©çš„æ„æ€ã€‚</p>
      <div class="table-responsive">
        <table>
          <tr><th>Verb</th><th>Phrase</th><th>Meaning</th></tr>
          <tr><td><strong>Look</strong></td><td>look for<br>look after</td><td>å°‹æ‰¾<br>ç…§é¡§</td></tr>
          <tr><td><strong>Give</strong></td><td>give up<br>give in</td><td>æ”¾æ£„<br>å±ˆæœ</td></tr>
          <tr><td><strong>Turn</strong></td><td>turn on/off<br>turn up/down</td><td>é–‹/é—œ<br>èª¿å¤§/å°è²</td></tr>
          <tr><td><strong>Get</strong></td><td>get along<br>get over</td><td>ç›¸è™•<br>å…‹æœ</td></tr>
        </table>
      </div>
      <a href="https://ducj-creator.github.io/Shirley-Grammar/phrases" target="_blank" class="btn-cta" style="width:100%; justify-content:center;">
        ğŸ§© å‰å¾€äº’å‹•å¼ç‰‡èªç·´ç¿’å€
      </a>
    </div>

    <div id="mistake-modal" class="modal-content">
      <h2>7. Common Mistakes æ˜“éŒ¯é»</h2>
      <div class="table-responsive">
        <table>
          <tr><th style="color:#c62828">Wrong (X)</th><th style="color:#2e7d32">Right (O)</th><th>Why?</th></tr>
          <tr><td>on the morning</td><td><strong>in</strong> the morning</td><td>æ™‚æ®µç”¨ IN</td></tr>
          <tr><td>at Christmas</td><td><strong>on</strong> Christmas Day</td><td>ç‰¹å®šæ—¥å­ç”¨ ON (at Christmas æŒ‡æ•´å€‹å‡æœŸ)</td></tr>
          <tr><td>arrive to London</td><td>arrive <strong>in</strong> London</td><td>åˆ°é”å¤§åŸå¸‚ç”¨ in, å°åœ°é»ç”¨ at</td></tr>
          <tr><td>married with</td><td>married <strong>to</strong></td><td>çµå©šå°è±¡ç”¨ to</td></tr>
          <tr><td>angry at me</td><td>angry <strong>with</strong> me</td><td>å°äººç”Ÿæ°£ç”¨ with</td></tr>
        </table>
      </div>
    </div>

    <div id="quiz-modal" class="modal-content">
      <h2>8. Preposition Challenge (20 Qs) ğŸ†</h2>
      <p style="margin-bottom:20px; color:#666;">Choose the correct preposition.</p>
      <div id="quiz-container"></div>
      <div id="result-area" class="result-card">
        <div class="result-score" id="score-display">0 / 20</div>
        <h3>Quiz Completed!</h3>
        <p id="result-msg"></p>
        <button onclick="startQuiz()" class="btn-cta">â†º Restart Quiz</button>
      </div>
    </div>

  </div>

  <script>
    // === 1. Floating Background ===
    const floatWords = ['In', 'On', 'At', 'To', 'For', 'With', 'By', 'Of', 'From', 'Up', 'Down', 'Over', 'Under'];
    const floatContainer = document.getElementById('floatingBg');

    function createFloatingIcons() {
      for(let i=0; i<18; i++) {
        const el = document.createElement('div');
        el.classList.add('float-item');
        el.innerText = floatWords[Math.floor(Math.random() * floatWords.length)];
        el.style.left = Math.random() * 100 + 'vw';
        el.style.animationDuration = (25 + Math.random() * 10) + 's';
        el.style.animationDelay = (Math.random() * 5) + 's';
        el.style.fontSize = (1.5 + Math.random() * 2) + 'rem';
        floatContainer.appendChild(el);
      }
    }
    createFloatingIcons();

    // === 2. Mind Map Layout ===
    function updateLayout() {
      const satellites = document.querySelectorAll('.satellite');
      const stage = document.getElementById('stage');
      const svg = document.getElementById('svgLines');
      const isMobile = window.innerWidth <= 768;

      while(svg.firstChild) svg.removeChild(svg.firstChild);

      if(isMobile) return; 

      const centerX = stage.offsetWidth / 2;
      const centerY = stage.offsetHeight / 2;
      const radius = 280;
      const total = satellites.length;

      satellites.forEach((node, index) => {
        const angle = (index / total) * 2 * Math.PI - (Math.PI / 2);
        const x = centerX + radius * Math.cos(angle);
        const y = centerY + radius * Math.sin(angle);

        node.style.left = x + 'px';
        node.style.top = y + 'px';
        node.style.transform = 'translate(-50%, -50%)';

        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', centerX);
        line.setAttribute('y1', centerY);
        line.setAttribute('x2', x);
        line.setAttribute('y2', y);
        line.classList.add('connection-line');
        svg.appendChild(line);
      });
    }
    window.addEventListener('resize', updateLayout);
    window.addEventListener('load', updateLayout);

    // === 3. Modal Logic & Canvas Trigger ===
    const overlay = document.getElementById('modalOverlay');
    let isCanvasRunning = false;

    document.querySelectorAll('.satellite').forEach(btn => {
      btn.addEventListener('click', () => {
        const targetId = btn.getAttribute('data-target');
        if(!targetId) return;

        document.querySelectorAll('.modal-content').forEach(c => c.style.display = 'none');
        document.getElementById(targetId).style.display = 'block';
        overlay.classList.add('active');

        if(targetId === 'quiz-modal') startQuiz();
        if(targetId === 'visual-modal') {
          setTimeout(() => {
            initCanvas(); 
            setScenario('pyramid'); 
          }, 100);
        }
      });
    });

    function openVisualLab(scenarioName) {
      document.querySelectorAll('.modal-content').forEach(c => c.style.display = 'none');
      document.getElementById('visual-modal').style.display = 'block';
      setTimeout(() => {
        initCanvas();
        setScenario(scenarioName);
      }, 100);
    }

    function closeModal() { 
      overlay.classList.remove('active'); 
      isCanvasRunning = false; // Stop animation loop
    }
    overlay.addEventListener('click', (e) => { if(e.target === overlay) closeModal(); });


    // === 4. CANVAS VISUALIZER LOGIC (Adapted from your file) ===
    const canvas = document.getElementById('prepCanvas');
    const ctx = canvas.getContext('2d');
    let frame = 0;
    let scenario = 'pyramid';
    let animId;

    function initCanvas() {
      const p = document.getElementById('canvasContainer');
      canvas.width = p.clientWidth;
      canvas.height = p.clientHeight;
      if(!isCanvasRunning) {
        isCanvasRunning = true;
        loop();
      }
    }

    function drawEmoji(e, x, y, s) {
      ctx.font = `${s}px Arial`; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(e, x, y);
    }

    function loop() {
      if(!isCanvasRunning) return;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      frame++;
      const cx = canvas.width/2;
      const cy = canvas.height/2;

      if(scenario === 'pyramid') {
        // Pyramid
        ctx.beginPath(); ctx.moveTo(cx, cy-120); ctx.lineTo(cx-100, cy+80); ctx.lineTo(cx+100, cy+80); ctx.closePath();
        const g = ctx.createLinearGradient(0, cy-120, 0, cy+80);
        g.addColorStop(0, '#fab1a0'); g.addColorStop(0.5, '#55efc4'); g.addColorStop(1, '#74b9ff');
        ctx.fillStyle=g; ctx.fill();
        
        ctx.fillStyle="#000"; ctx.font="bold 14px Arial"; ctx.textAlign='center';
        ctx.fillText("AT (Point)", cx, cy-80);
        ctx.fillText("ON (Surface)", cx, cy);
        ctx.fillText("IN (Volume)", cx, cy+60);

        const y = cy - 80 + Math.sin(frame/20)*60;
        drawEmoji("ğŸ“…", cx+120, y, 30);
        ctx.fillStyle="#555"; ctx.fillText("Time/Place", cx+120, y+30);

      } else if (scenario === 'transport') {
        const carX = cx - 100;
        ctx.fillStyle = "#ff7675"; ctx.fillRect(carX-40, cy, 80, 40);
        ctx.fillStyle = "#dfe6e9"; ctx.fillRect(carX-30, cy-25, 60, 25);
        drawEmoji("ğŸš—", carX, cy+20, 20);
        ctx.fillStyle="#2d3436"; ctx.fillText("IN the car", carX, cy+60);
        
        const busX = cx + 100;
        ctx.fillStyle = "#0984e3"; ctx.fillRect(busX-50, cy-40, 100, 80);
        ctx.fillStyle="#fff"; ctx.fillRect(busX-45, cy-30, 90, 30);
        ctx.fillStyle="#2d3436"; ctx.fillText("ON the bus", busX, cy+60);

        const pX = (frame % 200) < 100 ? carX : busX;
        const action = (frame % 200) < 100 ? "Get IN" : "Get ON";
        const emoji = (frame % 200) < 100 ? "ğŸ§" : "ğŸš¶";
        drawEmoji(emoji, pX, cy + 10, 40);
        ctx.fillStyle = "#d35400"; ctx.font="bold 20px Arial"; ctx.fillText(action, cx, cy-100);

      } else if (scenario === 'surface_in') {
         drawEmoji("ğŸ“¦", cx-80, cy, 80);
         drawEmoji("ğŸ±", cx-80, cy, 40);
         ctx.fillStyle="#333"; ctx.fillText("IN the box", cx-80, cy+60);

         ctx.fillStyle="#a29bfe"; ctx.fillRect(cx+40, cy+20, 80, 10);
         ctx.fillRect(cx+50, cy+30, 10, 30); ctx.fillRect(cx+100, cy+30, 10, 30);
         drawEmoji("ğŸ", cx+80, cy, 40);
         ctx.fillStyle="#333"; ctx.fillText("ON the table", cx+80, cy+80);

      } else if (scenario === 'motion_through') {
        ctx.fillStyle="#636e72"; ctx.beginPath(); ctx.arc(cx, cy-50, 40, Math.PI, 0); ctx.fill();
        const tx = (frame*2)%300 + (cx-150);
        if(tx > cx-40 && tx < cx+40) ctx.globalAlpha=0.3;
        drawEmoji("ğŸš‚", tx, cy-50, 40);
        ctx.globalAlpha=1;
        ctx.fillStyle="#333"; ctx.fillText("THROUGH (Tunnel)", cx, cy-10);

        ctx.fillStyle="#b2bec3"; ctx.fillRect(cx-100, cy+50, 200, 40);
        const wx = cx; const wy = cy+30 + (frame%100)/100 * 80;
        drawEmoji("ğŸš¶", wx, wy, 30);
        ctx.fillStyle="#333"; ctx.fillText("ACROSS (Road)", cx, cy+110);
      }
      animId = requestAnimationFrame(loop);
    }

    function setScenario(s) {
      scenario = s;
      frame = 0;
      document.querySelectorAll('.scene-btn').forEach(b => b.classList.remove('active'));
      const btn = document.querySelector(`.scene-btn[onclick="setScenario('${s}')"]`);
      if(btn) btn.classList.add('active');
      
      const texts = {
        pyramid: "å€’ä¸‰è§’æ³•å‰‡ï¼šä¸Šæ–¹å¤§ç¯„åœç”¨ INï¼Œä¸­é–“ç‰¹å®šç”¨ ONï¼Œä¸‹æ–¹ç²¾ç¢ºé»ç”¨ ATã€‚",
        transport: "äº¤é€šå·¥å…·ï¼šåƒå®¹å™¨éœ€å½è…°ç”¨ IN (Car)ï¼›åƒç”²æ¿å¯ç«™ç«‹ç”¨ ON (Bus)ã€‚",
        surface_in: "ç©ºé–“ï¼šIN åœ¨å…§éƒ¨ï¼ŒON åœ¨è¡¨é¢æ¥è§¸ã€‚",
        motion_through: "å‹•æ…‹ï¼šThrough ç©¿éå…§éƒ¨ï¼ŒAcross æ©«è¶Šè¡¨é¢ã€‚"
      };
      document.getElementById('caption').innerText = texts[s];
    }

    // === 5. Quiz Logic (20 Qs) ===
    const quizQuestions = [
      { q: "I was born _____ 1995.", options: ["in", "on", "at", "to"], correct: 0, expl: "Year is a long period -> IN." },
      { q: "The meeting is _____ Friday.", options: ["in", "at", "on", "by"], correct: 2, expl: "Specific Day -> ON." },
      { q: "See you _____ 5:00 PM.", options: ["in", "on", "at", "around"], correct: 2, expl: "Precise time -> AT." },
      { q: "He is sitting _____ the bus.", options: ["in", "on", "at", "by"], correct: 1, expl: "Public transport (platform) -> ON." },
      { q: "She got _____ the taxi.", options: ["on", "in", "to", "at"], correct: 1, expl: "Small vehicle (container) -> IN." },
      { q: "The cat is _____ the table.", options: ["under", "between", "among", "into"], correct: 0, expl: "Position: Under." },
      { q: "He walked _____ the forest.", options: ["across", "through", "on", "at"], correct: 1, expl: "3D space (forest) -> Through." },
      { q: "She swam _____ the river.", options: ["through", "across", "in", "above"], correct: 1, expl: "Surface (river) -> Across." },
      { q: "Look _____ the baby for me.", options: ["at", "for", "after", "up"], correct: 2, expl: "Look after = take care of." },
      { q: "Please turn _____ the lights.", options: ["in", "on", "at", "over"], correct: 1, expl: "Turn on (switch)." },
      { q: "I am interested _____ music.", options: ["in", "on", "at", "with"], correct: 0, expl: "interested in." },
      { q: "She is afraid _____ spiders.", options: ["of", "for", "with", "about"], correct: 0, expl: "afraid of." },
      { q: "He is good _____ math.", options: ["in", "at", "on", "for"], correct: 1, expl: "good at." },
      { q: "The picture is _____ the wall.", options: ["in", "on", "at", "above"], correct: 1, expl: "Surface contact -> ON." },
      { q: "Let's meet _____ the cinema.", options: ["on", "in", "at", "to"], correct: 2, expl: "Specific point/landmark -> AT." },
      { q: "Don't give _____.", options: ["up", "in", "on", "off"], correct: 0, expl: "Give up = quit." },
      { q: "He walked _____ the door.", options: ["to", "towards", "at", "on"], correct: 1, expl: "Direction -> Towards (or to)." },
      { q: "There is a bridge _____ the river.", options: ["above", "over", "on", "in"], correct: 1, expl: "Crossing over something -> Over." },
      { q: "I agree _____ you.", options: ["to", "with", "on", "at"], correct: 1, expl: "agree with someone." },
      { q: "The book is _____ the box.", options: ["in", "on", "at", "to"], correct: 0, expl: "Container -> IN." }
    ];

    let currentQ = 0;
    let score = 0;

    function startQuiz() {
      currentQ = 0;
      score = 0;
      document.getElementById('quiz-container').style.display = 'block';
      document.getElementById('result-area').style.display = 'none';
      renderQuestion();
    }

    function renderQuestion() {
      if(currentQ >= quizQuestions.length) {
        showResult();
        return;
      }
      const q = quizQuestions[currentQ];
      const container = document.getElementById('quiz-container');
      
      let html = `
        <div class="quiz-progress">Question ${currentQ + 1} / ${quizQuestions.length}</div>
        <div class="quiz-question-box">
          <div class="quiz-q-text">${q.q.replace('_____', '<span style="border-bottom:2px solid var(--secondary-tone); color:var(--secondary-tone);">?</span>')}</div>
          <div style="display:grid; gap:10px;">
            ${q.options.map((opt, idx) => `
              <button class="quiz-opt" onclick="checkAns(this, ${idx})">${opt}</button>
            `).join('')}
          </div>
          <div class="explanation" id="expl-${currentQ}">${q.expl}</div>
          <div style="text-align:right; margin-top:15px; display:none;" id="nav-${currentQ}">
            <button class="btn-cta" onclick="nextQ()">Next â†’</button>
          </div>
        </div>
      `;
      container.innerHTML = html;
    }

    function checkAns(btn, idx) {
      const q = quizQuestions[currentQ];
      const parent = btn.parentElement;
      const allBtns = parent.querySelectorAll('.quiz-opt');
      allBtns.forEach(b => b.disabled = true);
      
      if(idx === q.correct) {
        btn.classList.add('correct');
        score++;
      } else {
        btn.classList.add('incorrect');
        allBtns[q.correct].classList.add('correct');
      }
      document.getElementById(`expl-${currentQ}`).classList.add('show');
      document.getElementById(`nav-${currentQ}`).style.display = 'block';
    }

    function nextQ() {
      currentQ++;
      renderQuestion();
    }

    function showResult() {
      document.getElementById('quiz-container').style.display = 'none';
      document.getElementById('result-area').style.display = 'block';
      document.getElementById('score-display').innerText = `${score} / 20`;
      
      let msg = score >= 18 ? "Preposition Master! ğŸ†" : (score >= 12 ? "Good Job! Keep it up! ğŸ’ª" : "Keep practicing! ğŸ“š");
      document.getElementById('result-msg').innerText = msg;
    }
  </script>
</body>
</html>

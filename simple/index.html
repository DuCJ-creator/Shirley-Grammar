<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Happy Grammar: 5 Sentence Patterns</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600&family=Noto+Sans+TC:wght@400;500;700&display=swap');

        :root {
            --bg-gradient-start: #FFF1EB;
            --bg-gradient-end: #ACE0F9;
            --card-bg: #FFFFFF;
            
            /* Component Colors (Pastel & Happy) */
            --c-s: #A0C4FF; /* Subject - Blue */
            --c-v: #FFADAD; /* Verb - Red */
            --c-o: #CAFFBF; /* Object - Green */
            --c-c: #FDFFB6; /* Complement - Yellow */
            --c-io: #BDB2FF; /* Indirect - Purple */
            --c-do: #9BF6FF; /* Direct - Cyan */
            
            --text-main: #4A4A4A;
            --text-sub: #7F8C8D;
            --text-accent: #FF9F1C;

            --font-en: 'Fredoka', sans-serif;
            --font-cn: 'Noto Sans TC', sans-serif;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: var(--font-cn);
            overflow: hidden;
            touch-action: manipulation;
        }

        /* --- Main Stage --- */
        #app-stage {
            width: 95%;
            max-width: 1200px;
            height: 95vh;
            max-height: 800px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 8px solid #fff;
            backdrop-filter: blur(10px);
        }

        /* ÊâãÊ©üÊ©´ÂêëÊ®°ÂºèË™øÊï¥ */
        @media (max-height: 500px) and (orientation: landscape) {
            #app-stage {
                height: 98vh;
                max-height: none;
            }
            
            .header {
                height: 15% !important;
                padding-bottom: 5px !important;
            }
            
            .content-zone {
                height: 30% !important;
                padding-bottom: 10px !important;
            }
            
            .formula-title {
                font-size: 2rem !important;
            }
            
            .info-card {
                padding: 15px 20px !important;
            }
            
            .usage-text, .ex-en {
                font-size: 1.2rem !important;
            }
        }

        /* --- Floating Bubbles Decor --- */
        .bubble {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.8), rgba(255,255,255,0.1));
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            animation: floatUp linear infinite;
            z-index: 0;
            pointer-events: none;
        }
        @keyframes floatUp {
            0% { transform: translateY(120vh) scale(0.8); opacity: 0; }
            20% { opacity: 0.6; }
            80% { opacity: 0.6; }
            100% { transform: translateY(-20vh) scale(1.2); opacity: 0; }
        }

        /* --- Layout Sections --- */
        .header {
            height: 18%;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            z-index: 10;
            padding-bottom: 10px;
        }

        .formula-title {
            font-family: var(--font-en);
            font-size: 2.5rem;
            color: var(--text-main);
            font-weight: 600;
            letter-spacing: 1px;
            text-shadow: 2px 2px 0px #fff;
            transform: scale(0.8);
            opacity: 0;
            transition: all 0.5s ease;
            text-align: center;
            padding: 0 10px;
        }
        .formula-title.active { transform: scale(1); opacity: 1; }

        .formula-sub {
            font-size: 1rem;
            color: var(--text-sub);
            margin-top: 5px;
            opacity: 0;
            transition: opacity 0.5s;
            text-align: center;
            padding: 0 10px;
        }

        /* Animation Zone */
        .anim-zone {
            flex-grow: 1;
            position: relative;
            z-index: 5;
            overflow: hidden;
        }

        .block {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%) scale(0);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: var(--font-en);
            font-weight: 600;
            font-size: 1.8rem;
            color: #555;
            background: white;
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
            transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .block span { 
            font-size: 0.7rem; 
            font-weight: 400; 
            margin-top: 2px; 
            opacity: 0.6; 
        }
        
        /* Specific Component Colors */
        .b-s { background: var(--c-s); }
        .b-v { background: var(--c-v); }
        .b-o { background: var(--c-o); }
        .b-c { background: var(--c-c); }
        .b-io { background: var(--c-io); }
        .b-do { background: var(--c-do); }

        /* Content Card Zone */
        .content-zone {
            height: 35%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            padding-bottom: 15px;
        }

        .info-card {
            background: white;
            width: 85%;
            padding: 20px 25px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            text-align: center;
            position: absolute; /* Stack them */
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .info-card.show { opacity: 1; transform: translateY(0); }

        /* Usage Card Specifics */
        .usage-badge {
            background: var(--text-accent);
            color: white;
            padding: 5px 12px;
            border-radius: 12px;
            font-size: 0.9rem;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .usage-text {
            font-size: 1.2rem;
            color: var(--text-main);
            line-height: 1.5;
        }

        /* Example Card Specifics */
        .level-badge {
            padding: 5px 12px;
            border-radius: 12px;
            color: white;
            font-size: 0.8rem;
            margin-bottom: 8px;
            text-transform: uppercase;
            font-weight: bold;
            font-family: var(--font-en);
        }
        .lvl-low { background: #81B29A; }
        .lvl-mid { background: #F2CC8F; }
        .lvl-high { background: #E07A5F; }

        .ex-en { 
            font-family: var(--font-en); 
            font-size: 1.5rem; 
            color: var(--text-main); 
            margin-bottom: 5px; 
            line-height: 1.3;
        }
        .ex-cn { 
            font-size: 1rem; 
            color: var(--text-sub); 
            line-height: 1.3;
        }

        /* Progress Bar */
        .progress-container {
            height: 6px;
            width: 100%;
            background: #f0f0f0;
            position: absolute;
            bottom: 0;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #FFADAD, #A0C4FF);
            transition: width 0.5s linear;
        }

        /* --- Overlays (Start, Quiz, End) --- */
        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            transition: opacity 0.5s;
            opacity: 0;
            pointer-events: none;
            padding: 20px;
            text-align: center;
        }
        .overlay.active { opacity: 1; pointer-events: all; }

        .big-title {
            font-family: var(--font-en);
            font-size: 3rem;
            color: var(--text-main);
            margin-bottom: 10px;
            line-height: 1.2;
        }

        .btn-primary {
            padding: 14px 30px;
            font-size: 1.3rem;
            background: var(--c-s);
            color: white;
            border: none;
            border-radius: 40px;
            cursor: pointer;
            font-family: var(--font-en);
            font-weight: 600;
            box-shadow: 0 8px 15px rgba(160, 196, 255, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 8px;
            min-width: 180px;
            min-height: 55px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-primary:hover, .btn-primary:active { 
            transform: scale(1.05); 
            box-shadow: 0 12px 20px rgba(160, 196, 255, 0.6); 
        }
        
        .btn-secondary {
            background: var(--c-v);
            box-shadow: 0 8px 15px rgba(255, 173, 173, 0.4);
        }
        .btn-secondary:hover, .btn-secondary:active { 
            box-shadow: 0 12px 20px rgba(255, 173, 173, 0.6); 
        }

        /* Quiz Styles */
        .quiz-question { 
            font-size: 1.8rem; 
            margin-bottom: 30px; 
            color: var(--text-main); 
            font-family: var(--font-en); 
            text-align: center; 
            width: 90%; 
            line-height: 1.3;
        }
        .quiz-options { 
            display: flex; 
            justify-content: center; 
            gap: 15px; 
            flex-wrap: wrap; 
            width: 100%;
        }
        .quiz-btn {
            padding: 12px 20px; 
            font-size: 1.1rem; 
            border: 3px solid #eee; 
            background: white;
            border-radius: 15px; 
            cursor: pointer; 
            font-family: var(--font-en); 
            color: var(--text-main);
            transition: all 0.2s;
            min-width: 120px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .quiz-btn:hover, .quiz-btn:active { 
            border-color: var(--c-s); 
            transform: translateY(-3px); 
        }
        .quiz-btn.correct { background: var(--c-o); border-color: var(--c-o); color: white; }
        .quiz-btn.wrong { background: var(--c-v); border-color: var(--c-v); color: white; }

        /* Control Buttons */
        .control-buttons {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
            z-index: 200;
        }

        .control-btn {
            font-size: 1.5rem;
            cursor: pointer;
            background: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            user-select: none;
        }
        .control-btn:hover, .control-btn:active { 
            transform: scale(1.1); 
        }

        /* Êö´ÂÅúË¶ÜËìãÂ±§ */
        .pause-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 150;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            padding: 20px;
            text-align: center;
        }
        .pause-overlay.active { opacity: 1; pointer-events: all; }
        .pause-overlay h2 {
            font-family: var(--font-en);
            font-size: 2.5rem;
            color: var(--text-main);
            margin-bottom: 15px;
        }

        /* ÊâãÊ©üÂ∞èËû¢ÂπïË™øÊï¥ */
        @media (max-width: 480px) {
            #app-stage {
                width: 98%;
                height: 98vh;
                border-radius: 15px;
                border-width: 5px;
            }
            
            .formula-title {
                font-size: 2rem;
            }
            
            .formula-sub {
                font-size: 0.9rem;
            }
            
            .block {
                width: 70px;
                height: 70px;
                font-size: 1.5rem;
                border-radius: 15px;
            }
            
            .block span {
                font-size: 0.6rem;
            }
            
            .info-card {
                width: 90%;
                padding: 15px 20px;
            }
            
            .usage-text {
                font-size: 1.1rem;
            }
            
            .ex-en {
                font-size: 1.3rem;
            }
            
            .ex-cn {
                font-size: 0.9rem;
            }
            
            .big-title {
                font-size: 2.5rem;
            }
            
            .btn-primary {
                padding: 12px 25px;
                font-size: 1.2rem;
                min-width: 160px;
                min-height: 50px;
            }
            
            .quiz-question {
                font-size: 1.6rem;
            }
            
            .quiz-btn {
                padding: 10px 15px;
                font-size: 1rem;
                min-width: 100px;
                min-height: 45px;
            }
            
            .control-btn {
                width: 40px;
                height: 40px;
                font-size: 1.3rem;
            }
            
            .pause-overlay h2 {
                font-size: 2rem;
            }
        }

        /* ÊâãÊ©üÊ©´ÂêëÊ®°ÂºèË™øÊï¥ */
        @media (max-height: 500px) and (orientation: landscape) {
            #app-stage {
                height: 98vh;
                max-height: none;
            }
            
            .header {
                height: 15% !important;
                padding-bottom: 5px !important;
            }
            
            .content-zone {
                height: 30% !important;
                padding-bottom: 10px !important;
            }
            
            .formula-title {
                font-size: 2rem !important;
            }
            
            .info-card {
                padding: 15px 20px !important;
            }
            
            .usage-text, .ex-en {
                font-size: 1.2rem !important;
            }
            
            .block {
                width: 60px !important;
                height: 60px !important;
                font-size: 1.3rem !important;
            }
        }
    </style>
</head>
<body>

    <div id="app-stage">
        <!-- ÊéßÂà∂ÊåâÈàï -->
        <div class="control-buttons">
            <div class="control-btn pause-btn" id="pauseToggle">‚è∏Ô∏è</div>
            <div class="control-btn music-btn" id="musicToggle">üîá</div>
        </div>
        
        <!-- Êö´ÂÅúË¶ÜËìãÂ±§ -->
        <div class="pause-overlay" id="pauseOverlay">
            <h2>Paused</h2>
            <p style="font-size: 1.2rem; color: #666; margin-bottom: 30px;">ÈªûÊìäÁπºÁ∫åÊåâÈàïÊàñÊö´ÂÅúÈçµÊÅ¢Âæ©</p>
            <button class="btn-primary" onclick="togglePause()">ÁπºÁ∫å</button>
        </div>
        
        <!-- Bubbles Container -->
        <div id="bubbles"></div>

        <!-- Header -->
        <div class="header">
            <div class="formula-title" id="headerTitle">S + V</div>
            <div class="formula-sub" id="headerSub">Subject + Verb</div>
        </div>

        <!-- Animation Stage -->
        <div class="anim-zone" id="animStage"></div>

        <!-- Content Area (Usage & Examples) -->
        <div class="content-zone">
            <!-- Usage Card -->
            <div class="info-card" id="usageCard">
                <div class="usage-badge">How to use</div>
                <div class="usage-text" id="usageText">Âãï‰Ωú‰∏çÈúÄË¶ÅÂèóË©û</div>
            </div>
            
            <!-- Example Card -->
            <div class="info-card" id="exampleCard">
                <div class="level-badge" id="exBadge">Basic</div>
                <div class="ex-en" id="exEn">Birds fly.</div>
                <div class="ex-cn" id="exCn">È≥•ÂÖíÈ£õÁøî„ÄÇ</div>
            </div>
        </div>

        <!-- Progress -->
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <!-- 1. Start Screen -->
        <div class="overlay active" id="startScreen">
            <div class="big-title">English Grammar</div>
            <p style="font-size: 1.3rem; color: #888; margin-bottom: 30px; line-height: 1.4;">The 5 Happy Sentence Patterns</p>
            <button class="btn-primary" onclick="startLesson()">Start Learning üéµ</button>
        </div>

        <!-- 2. Quiz Screen -->
        <div class="overlay" id="quizScreen">
            <h2 style="color: #AAA; margin-bottom: 10px;">Quiz Time!</h2>
            <div style="color: var(--c-s); font-weight: bold; margin-bottom: 20px;" id="quizProgress">Question 1/5</div>
            <div class="quiz-question" id="qText">Question goes here</div>
            <div class="quiz-options" id="qOptions"></div>
            <div id="qMsg" style="height: 30px; margin-top: 20px; font-weight: bold; font-size: 1.2rem;"></div>
        </div>

        <!-- 3. Result Screen -->
        <div class="overlay" id="resultScreen">
            <div class="big-title">Great Job! üéâ</div>
            <p style="font-size: 1.2rem; color: #666; margin-bottom: 40px; width: 90%; text-align: center; line-height: 1.4;">
                You've practiced all the patterns. What would you like to do next?
            </p>
            <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
                <button class="btn-primary" onclick="startQuiz()">One more challenge</button>
                <button class="btn-primary btn-secondary" onclick="resetApp()">Back to Start</button>
            </div>
        </div>
    </div>

    <script>
        // --- Data: Content & Usage ---
        const grammarData = [
            {
                id: 'sv',
                formula: 'S + Vi',
                desc: 'Subject + Intransitive Verb',
                // Explicit Usage Explanation
                usage: 'ÈÄôÂÄãÂè•ÂûãË°®Á§∫„Äå‰∏ªË©ûËá™Â∑±ÂÅöÂãï‰Ωú„Äç„ÄÇÂãï‰ΩúÂà∞Ê≠§ÁÇ∫Ê≠¢ÔºåÂæåÈù¢‰∏çÈúÄË¶ÅÊé•ÂèóÂãï‰ΩúÁöÑÂ∞çË±°ÔºàÂèóË©ûÔºâ„ÄÇ',
                blocks: ['S', 'Vi'],
                examples: [
                    { lvl: 'low', en: "Time flies.", cn: "ÊôÇÂÖâÈ£õÈÄù„ÄÇ" },
                    { lvl: 'mid', en: "The sun rises in the east.", cn: "Â§™ÈôΩÂæûÊù±ÊñπÂçáËµ∑„ÄÇ" },
                    { lvl: 'high', en: "The negotiation failed completely.", cn: "Ë´áÂà§ÂæπÂ∫ïÂ§±Êïó‰∫Ü„ÄÇ" }
                ]
            },
            {
                id: 'svc',
                formula: 'S + Vl + C',
                desc: 'Subject + Linking Verb + Complement',
                usage: 'ÈÄ£Á∂¥ÂãïË©ûÂÉè„ÄåÁ≠âËôü (=)„Äç‰∏ÄÊ®£ÔºåÁî®‰æÜÈÄ£Êé•‰∏ªË©ûÂíåË£úË™ûÔºåË™™Êòé‰∏ªË©ûÁöÑ„ÄåÁãÄÊÖã„ÄçÊàñ„ÄåË∫´ÂàÜ„Äç„ÄÇ',
                blocks: ['S', 'Vl', 'C'],
                examples: [
                    { lvl: 'low', en: "She is a teacher.", cn: "Â•πÊòØ‰∏Ä‰ΩçËÄÅÂ∏´„ÄÇ" },
                    { lvl: 'mid', en: "The idea sounds great.", cn: "ÈÄôÂÄã‰∏ªÊÑèËÅΩËµ∑‰æÜÂæàÊ£í„ÄÇ" },
                    { lvl: 'high', en: "He remained silent during the meeting.", cn: "‰ªñÂú®ÊúÉË≠∞ÊúüÈñì‰øùÊåÅÊ≤àÈªò„ÄÇ" }
                ]
            },
            {
                id: 'svo',
                formula: 'S + Vt + O',
                desc: 'Subject + Transitive Verb + Object',
                usage: 'ÈÄôÊòØÊúÄÂ∏∏Ë¶ãÁöÑÂè•Âûã„ÄÇ‰∏ªË©ûÂÅö‰∫Ü‰∏ÄÂÄãÂãï‰ΩúÔºåÈÄôÂÄãÂãï‰ΩúÊúÉÂΩ±ÈüøÂà∞‰∏ÄÂÄãÂ∞çË±°ÔºàÂèóË©ûÔºâ„ÄÇ',
                blocks: ['S', 'Vt', 'O'],
                examples: [
                    { lvl: 'low', en: "I love music.", cn: "ÊàëÊÑõÈü≥Ê®Ç„ÄÇ" },
                    { lvl: 'mid', en: "They discussed the plan.", cn: "‰ªñÂÄëË®éË´ñ‰∫ÜÈÄôÂÄãË®àÁï´„ÄÇ" },
                    { lvl: 'high', en: "The government implemented new policies.", cn: "ÊîøÂ∫úÂØ¶ÊñΩ‰∫ÜÊñ∞ÊîøÁ≠ñ„ÄÇ" }
                ]
            },
            {
                id: 'svoo',
                formula: 'S + Vt + iO + dO',
                desc: 'Subj + Verb + Ind. Obj + Dir. Obj',
                usage: 'ÈÄöÂ∏∏Ë°®Á§∫„ÄåÁµ¶‰∫à„ÄçÊàñ„ÄåÂÇ≥ÈÅû„Äç„ÄÇÊúÉÊúâÂÖ©ÂÄãÂ∞çË±°Ôºö‰∏ÄÂÄãÊòØÊù±Ë•øÔºàÁõ¥Êé•ÂèóË©ûÔºâÔºå‰∏ÄÂÄãÊòØÊî∂ÂèóÁöÑ‰∫∫ÔºàÈñìÊé•ÂèóË©ûÔºâ„ÄÇ',
                blocks: ['S', 'Vt', 'iO', 'dO'],
                examples: [
                    { lvl: 'low', en: "Show me the money.", cn: "ÊääÈå¢ÁßÄÁµ¶ÊàëÁúã„ÄÇ" },
                    { lvl: 'mid', en: "He bought her a flower.", cn: "‰ªñË≤∑‰∫Ü‰∏ÄÊúµËä±Áµ¶Â•π„ÄÇ" },
                    { lvl: 'high', en: "The award granted him international recognition.", cn: "ÈÄôÂÄãÁçéÈ†ÖÁµ¶‰∫à‰∫Ü‰ªñÂúãÈöõË™çÂèØ„ÄÇ" }
                ]
            },
            {
                id: 'svoc',
                formula: 'S + Vt + O + OC',
                desc: 'Subj + Verb + Obj + Obj Comp',
                usage: '‰∏ªË©ûÂÅöÁöÑÂãï‰ΩúÔºåËÆìÂèóË©ûÁî¢Áîü‰∫ÜËÆäÂåñÔºåÊàñËÄÖË≥¶‰∫àÂèóË©ûÊüêÁ®ÆÁãÄÊÖã„ÄÇË£úË™ûÊòØÁî®‰æÜË£úÂÖÖË™™ÊòéÂèóË©ûÁöÑ„ÄÇ',
                blocks: ['S', 'Vt', 'O', 'OC'],
                examples: [
                    { lvl: 'low', en: "Keep the room clean.", cn: "‰øùÊåÅÊàøÈñì‰πæÊ∑®„ÄÇ" },
                    { lvl: 'mid', en: "They named the baby Joy.", cn: "‰ªñÂÄëÊääÂ¨∞ÂÖíÂèñÂêçÁÇ∫ Joy„ÄÇ" },
                    { lvl: 'high', en: "We consider the matter settled.", cn: "ÊàëÂÄëË™çÁÇ∫ÈÄô‰ª∂‰∫ãÂ∑≤Á∂ìËß£Ê±∫‰∫Ü„ÄÇ" }
                ]
            }
        ];

        // --- Audio System (Generated) ---
        const AudioSys = {
            ctx: null,
            muted: true,
            bgmInterval: null,
            
            init() {
                // Âª∂ÈÅ≤ÂàùÂßãÂåñÈü≥È†ª‰∏ä‰∏ãÊñáÔºåÈÅøÂÖçiOSÈôêÂà∂
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            },
            
            toggle() {
                if (!this.ctx) this.init();
                
                this.muted = !this.muted;
                if(!this.muted) {
                    this.ctx.resume();
                    this.startBGM();
                } else {
                    this.ctx.suspend();
                    clearInterval(this.bgmInterval);
                }
                return this.muted;
            },

            playTone(freq, type, dur, vol) {
                if(this.muted || !this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + dur);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + dur);
            },

            playChord() {
                // Major chord
                this.playTone(349.23, 'sine', 1.0, 0.05); // F4
                setTimeout(() => this.playTone(440.00, 'sine', 1.0, 0.05), 50); // A4
                setTimeout(() => this.playTone(523.25, 'sine', 1.0, 0.05), 100); // C5
            },

            playPop() {
                this.playTone(600 + Math.random()*200, 'triangle', 0.1, 0.05);
            },

            playSuccess() {
                this.playTone(523.25, 'square', 0.2, 0.05);
                setTimeout(() => this.playTone(659.25, 'square', 0.4, 0.05), 100);
            },

            playError() {
                this.playTone(200, 'sawtooth', 0.3, 0.08);
            },

            startBGM() {
                if(this.bgmInterval) clearInterval(this.bgmInterval);
                let i = 0;
                const notes = [261.63, 329.63, 392.00, 523.25, 392.00, 329.63];
                this.bgmInterval = setInterval(() => {
                    if(!this.muted && this.ctx) {
                        this.playTone(notes[i], 'sine', 1.5, 0.015);
                        i = (i + 1) % notes.length;
                    }
                }, 600);
            }
        };

        // --- UI Elements ---
        const els = {
            stage: document.getElementById('animStage'),
            headerTitle: document.getElementById('headerTitle'),
            headerSub: document.getElementById('headerSub'),
            usageCard: document.getElementById('usageCard'),
            usageText: document.getElementById('usageText'),
            exCard: document.getElementById('exampleCard'),
            exBadge: document.getElementById('exBadge'),
            exEn: document.getElementById('exEn'),
            exCn: document.getElementById('exCn'),
            bar: document.getElementById('progressBar'),
            musicBtn: document.getElementById('musicToggle'),
            pauseBtn: document.getElementById('pauseToggle'),
            pauseOverlay: document.getElementById('pauseOverlay'),
            screens: {
                start: document.getElementById('startScreen'),
                quiz: document.getElementById('quizScreen'),
                result: document.getElementById('resultScreen')
            }
        };

        // --- Êñ∞Â¢ûÊö´ÂÅúÁ≥ªÁµ± ---
        let isPaused = false;
        let pauseResolve = null;
        let pausePromise = null;

        function togglePause() {
            isPaused = !isPaused;
            
            if (isPaused) {
                // Êö´ÂÅúÁãÄÊÖã
                els.pauseOverlay.classList.add('active');
                els.pauseBtn.innerHTML = '‚ñ∂Ô∏è';
                
                // Êö´ÂÅúÈü≥Êïà
                if (AudioSys.ctx) {
                    AudioSys.ctx.suspend();
                }
                
                // ÂâµÂª∫‰∏ÄÂÄãPromiseÔºåÁï∂ÊÅ¢Âæ©ÊôÇËß£Ê±∫ÂÆÉ
                pausePromise = new Promise(resolve => {
                    pauseResolve = resolve;
                });
            } else {
                // ÊÅ¢Âæ©ÁãÄÊÖã
                els.pauseOverlay.classList.remove('active');
                els.pauseBtn.innerHTML = '‚è∏Ô∏è';
                
                // ÊÅ¢Âæ©Èü≥Êïà
                if (!AudioSys.muted && AudioSys.ctx) {
                    AudioSys.ctx.resume();
                }
                
                // Ëß£Ê±∫PromiseÔºåËÆìÁ≠âÂæÖÁöÑÂãïÁï´ÁπºÁ∫å
                if (pauseResolve) {
                    pauseResolve();
                    pauseResolve = null;
                }
            }
        }

        // ‰øÆÊîπsleepÂáΩÊï∏‰ª•ÊîØÊåÅÊö´ÂÅú
        async function sleep(ms) {
            const start = Date.now();
            let elapsed = 0;
            
            while (elapsed < ms) {
                if (isPaused) {
                    await pausePromise;
                    // ÈáçÊñ∞Ë®àÁÆóÂâ©È§òÊôÇÈñì
                    elapsed = Date.now() - start;
                } else {
                    const remaining = ms - elapsed;
                    await new Promise(r => setTimeout(r, Math.min(100, remaining)));
                    elapsed = Date.now() - start;
                }
            }
        }

        // --- Helper Functions ---
        function createBubbles() {
            const container = document.getElementById('bubbles');
            // Ê∏õÂ∞ëÊ≥°Ê≥°Êï∏Èáè‰ª•ÊèêÂçáÊâãÊ©üÊïàËÉΩ
            for(let i=0; i<10; i++) {
                const b = document.createElement('div');
                b.className = 'bubble';
                const size = Math.random() * 50 + 15;
                b.style.width = size + 'px';
                b.style.height = size + 'px';
                b.style.left = Math.random() * 100 + '%';
                b.style.animationDuration = (Math.random() * 10 + 10) + 's';
                b.style.animationDelay = (Math.random() * 5) + 's';
                container.appendChild(b);
            }
        }

        function clearActiveCards() {
            els.usageCard.classList.remove('show');
            els.exCard.classList.remove('show');
        }

        // --- Main Animation Sequence ---
        async function startLesson() {
            els.screens.start.classList.remove('active');
            
            // Unmute by default on start if user hasn't toggled
            if(AudioSys.muted) {
                AudioSys.toggle();
                els.musicBtn.innerText = "üîä";
            }

            for (let i = 0; i < grammarData.length; i++) {
                const data = grammarData[i];
                
                // Update Progress
                els.bar.style.width = `${(i / grammarData.length) * 100}%`;

                // 1. Setup Header
                els.headerTitle.classList.remove('active');
                els.headerSub.style.opacity = 0;
                clearActiveCards();
                els.stage.innerHTML = ''; // Clear blocks

                await sleep(500);
                
                // Show Formula
                els.headerTitle.innerText = data.formula;
                els.headerSub.innerText = data.desc;
                els.headerTitle.classList.add('active');
                AudioSys.playChord();
                
                await sleep(600);
                els.headerSub.style.opacity = 1;

                // 2. Animate Blocks
                const positions = getBlockPositions(data.blocks.length);
                
                for (let j = 0; j < data.blocks.length; j++) {
                    const bCode = data.blocks[j];
                    const block = document.createElement('div');
                    let typeClass = 'b-s';
                    if(bCode.startsWith('V')) typeClass = 'b-v';
                    else if(bCode === 'O') typeClass = 'b-o';
                    else if(bCode === 'C' || bCode === 'OC') typeClass = 'b-c';
                    else if(bCode === 'iO') typeClass = 'b-io';
                    else if(bCode === 'dO') typeClass = 'b-do';

                    block.className = `block ${typeClass}`;
                    block.innerHTML = `${bCode}<span>${getLabel(bCode)}</span>`;
                    block.style.left = `${positions[j]}%`;
                    els.stage.appendChild(block);
                    
                    // Pop in
                    await sleep(100);
                    requestAnimationFrame(() => {
                        block.style.transform = 'translate(-50%, -50%) scale(1)';
                    });
                    AudioSys.playPop();
                    await sleep(500);
                }

                // 3. SHOW USAGE (New Feature)
                await sleep(500);
                els.usageText.innerText = data.usage;
                els.usageCard.classList.add('show');
                
                // Keep usage visible for reading
                await sleep(4000); 
                els.usageCard.classList.remove('show');
                await sleep(500);

                // 4. SHOW EXAMPLES (Low -> Mid -> High)
                for (let k = 0; k < data.examples.length; k++) {
                    const ex = data.examples[k];
                    
                    // Update content
                    els.exBadge.className = `level-badge lvl-${ex.lvl}`;
                    els.exBadge.innerText = ex.lvl === 'low' ? 'Basic' : ex.lvl === 'mid' ? 'Intermediate' : 'Advanced';
                    els.exEn.innerText = ex.en;
                    els.exCn.innerText = ex.cn;

                    // Show card
                    els.exCard.classList.add('show');
                    AudioSys.playPop();
                    
                    // Wait reading time
                    await sleep(3000);
                    
                    // Hide to prep for next
                    els.exCard.classList.remove('show');
                    await sleep(400);
                }
            }

            // Lesson Complete
            els.bar.style.width = '100%';
            await sleep(1000);
            startQuiz();
        }

        function getBlockPositions(count) {
            if (count === 2) return [35, 65];
            if (count === 3) return [25, 50, 75];
            if (count === 4) return [20, 40, 60, 80];
            return [50];
        }

        function getLabel(code) {
            const map = {
                'S': 'Subject', 'Vi': 'Intransitive', 'Vt': 'Transitive',
                'Vl': 'Linking', 'O': 'Object', 'C': 'Complement',
                'OC': 'Complement', 'iO': 'Indirect', 'dO': 'Direct'
            };
            return map[code] || '';
        }

        // --- Quiz System ---
        let quizCount = 0;
        const MAX_QUIZ = 5;

        function startQuiz() {
            quizCount = 0;
            els.screens.start.classList.remove('active');
            els.screens.result.classList.remove('active');
            els.screens.quiz.classList.add('active');
            nextQuestion();
        }

        function nextQuestion() {
            if(quizCount >= MAX_QUIZ) {
                endQuiz();
                return;
            }

            quizCount++;
            document.getElementById('quizProgress').innerText = `Question ${quizCount}/${MAX_QUIZ}`;
            document.getElementById('qMsg').innerText = "";

            // Generate Question
            const rPattern = grammarData[Math.floor(Math.random() * grammarData.length)];
            const rEx = rPattern.examples[Math.floor(Math.random() * rPattern.examples.length)];
            
            document.getElementById('qText').innerText = rEx.en;
            const optsContainer = document.getElementById('qOptions');
            optsContainer.innerHTML = '';

            // Options
            let options = [rPattern.formula];
            while(options.length < 3) {
                const wrong = grammarData[Math.floor(Math.random() * grammarData.length)].formula;
                if(!options.includes(wrong)) options.push(wrong);
            }
            options.sort(() => Math.random() - 0.5);

            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'quiz-btn';
                btn.innerText = opt;
                btn.onclick = () => handleAnswer(btn, opt, rPattern.formula);
                optsContainer.appendChild(btn);
            });
        }

        function handleAnswer(btn, selected, correct) {
            const allBtns = document.querySelectorAll('.quiz-btn');
            allBtns.forEach(b => b.disabled = true); // Lock buttons

            if(selected === correct) {
                btn.classList.add('correct');
                document.getElementById('qMsg').innerText = "Correct! üéâ";
                document.getElementById('qMsg').style.color = "#4CAF50";
                AudioSys.playSuccess();
                setTimeout(nextQuestion, 1500);
            } else {
                btn.classList.add('wrong');
                document.getElementById('qMsg').innerText = `Oops! It's ${correct}`;
                document.getElementById('qMsg').style.color = "#FF5252";
                AudioSys.playError();
                // Highlight correct one
                allBtns.forEach(b => {
                    if(b.innerText === correct) b.classList.add('correct');
                });
                setTimeout(nextQuestion, 2500);
            }
        }

        function endQuiz() {
            els.screens.quiz.classList.remove('active');
            els.screens.result.classList.add('active');
            AudioSys.playChord();
        }

        function resetApp() {
            els.screens.result.classList.remove('active');
            els.screens.start.classList.add('active');
            // Reset visuals
            els.stage.innerHTML = '';
            els.headerTitle.innerText = "S + V";
            els.headerTitle.classList.remove('active');
            els.bar.style.width = '0%';
            clearActiveCards();
        }

        // --- Initialization ---
        els.musicBtn.onclick = () => {
            const isMuted = AudioSys.toggle();
            els.musicBtn.innerText = isMuted ? "üîá" : "üîä";
        };

        // Á∂ÅÂÆöÊö´ÂÅúÊåâÈàï‰∫ã‰ª∂
        els.pauseBtn.onclick = togglePause;

        window.onload = createBubbles;

        // Èò≤Ê≠¢ÊâãÊ©ü‰∏äÁöÑÈõôÊìäÁ∏ÆÊîæ
        document.addEventListener('touchstart', function(e) {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });

        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(e) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

    </script>
</body>
</html>

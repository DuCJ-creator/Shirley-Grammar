<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Level 4: Compound-Complex Sentences</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+TC:wght@300;500;700&display=swap');

        :root {
            --bg-dark: #0f172a;
            --bg-panel: #1e293b;
            --text-main: #f1f5f9;
            --text-sub: #94a3b8;
            
            /* Logic Colors */
            --col-ic: #38bdf8; /* Independent Clause - Blue */
            --col-dc: #e879f9; /* Dependent Clause - Pink */
            --col-conn: #fbbf24; /* Connector - Amber */
            
            --shadow: 0 10px 30px -10px rgba(0,0,0,0.5);
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            font-family: 'Noto Sans TC', 'JetBrains Mono', sans-serif;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            color: var(--text-main);
        }

        /* Main Stage - 16:9 Ratio */
        #stage {
            width: 100%;
            max-width: 1920px;
            aspect-ratio: 16/9;
            background: var(--bg-dark);
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(56, 189, 248, 0.1);
            display: flex;
            flex-direction: column;
        }

        /* Background Grid Animation */
        .grid-bg {
            position: absolute;
            width: 200%;
            height: 200%;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            transform: perspective(500px) rotateX(60deg) translateY(-100px) translateZ(-200px);
            animation: gridMove 20s linear infinite;
            z-index: 0;
        }

        @keyframes gridMove {
            0% { transform: perspective(500px) rotateX(60deg) translateY(0) translateZ(-200px); }
            100% { transform: perspective(500px) rotateX(60deg) translateY(50px) translateZ(-200px); }
        }

        /* Content Area */
        #content {
            flex: 1;
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        /* Header */
        .header {
            position: absolute;
            top: 40px;
            text-align: center;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.8s ease;
        }
        
        .level-tag {
            background: var(--col-dc);
            color: #fff;
            padding: 5px 15px;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 0 0 15px var(--col-dc);
        }

        h1 {
            font-size: 3.5rem;
            margin: 10px 0 5px 0;
            background: linear-gradient(to right, #fff, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
        }

        .subtitle {
            font-size: 1.5rem;
            color: var(--text-sub);
        }

        /* Formula Display */
        .formula-container {
            display: flex;
            gap: 20px;
            margin-bottom: 50px;
            opacity: 0;
            transition: opacity 0.5s;
        }

        .formula-block {
            padding: 15px 30px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.5rem;
            border: 2px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(5px);
            transform: scale(0.8);
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .f-ic { border-color: var(--col-ic); color: var(--col-ic); box-shadow: 0 0 20px rgba(56, 189, 248, 0.2); }
        .f-dc { border-color: var(--col-dc); color: var(--col-dc); box-shadow: 0 0 20px rgba(232, 121, 249, 0.2); }
        .f-plus { border: none; background: none; color: #fff; font-size: 2rem; }

        /* Sentence Construction Zone */
        .sentence-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 15px;
            width: 90%;
            min-height: 200px;
        }

        .word-block {
            position: relative;
            padding: 15px 20px;
            border-radius: 6px;
            font-size: 1.8rem;
            background: var(--bg-panel);
            color: #fff;
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.6s cubic-bezier(0.22, 1, 0.36, 1);
            border-left: 5px solid #555;
        }

        .word-block.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .word-block::before {
            content: attr(data-type);
            position: absolute;
            top: -25px;
            left: 0;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
            opacity: 0;
            transition: opacity 0.5s 0.5s;
        }

        .word-block.visible::before { opacity: 1; }

        /* Types */
        .type-ic { border-left-color: var(--col-ic); }
        .type-ic::before { color: var(--col-ic); }
        
        .type-dc { border-left-color: var(--col-dc); }
        .type-dc::before { color: var(--col-dc); }

        .type-conn { 
            background: transparent; 
            border: 2px solid var(--col-conn); 
            color: var(--col-conn);
            border-radius: 50px;
            padding: 10px 25px;
            font-weight: bold;
        }
        .type-conn::before { content: ''; } /* No label for connectors */

        /* Difficulty Badge */
        .difficulty-badge {
            position: absolute;
            right: 40px;
            top: 40px;
            font-size: 3rem;
            font-weight: 900;
            opacity: 0;
            transform: scale(0);
            transition: all 0.5s;
            color: rgba(255,255,255,0.1);
        }
        .diff-active { opacity: 1; transform: scale(1); color: var(--col-conn); text-shadow: 0 0 30px var(--col-conn); }

        /* Footer Controls */
        .footer {
            height: 15%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            position: relative;
        }

        .subs-box {
            text-align: center;
            margin-bottom: 10px;
            min-height: 60px;
        }

        .sub-text {
            font-size: 1.4rem;
            color: #fff;
            text-shadow: 0 2px 5px #000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .sub-tc {
            font-size: 1.1rem;
            color: var(--text-sub);
            margin-top: 5px;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 20px;
            width: 90%;
        }

        .btn {
            background: none;
            border: 1px solid rgba(255,255,255,0.3);
            color: #fff;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.2s;
        }

        .btn:hover { background: rgba(255,255,255,0.1); border-color: #fff; }
        .btn svg { width: 16px; height: 16px; fill: currentColor; }

        .progress-track {
            flex: 1;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            width: 0%;
            background: var(--col-ic);
            box-shadow: 0 0 10px var(--col-ic);
            transition: width 0.1s linear;
        }

        /* Pulse Animation for emphasis */
        .pulse { animation: pulseAnim 0.5s ease-in-out; }
        @keyframes pulseAnim {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); box-shadow: 0 0 30px rgba(255,255,255,0.5); }
            100% { transform: scale(1); }
        }

    </style>
</head>
<body>

    <div id="stage">
        <div class="grid-bg"></div>
        
        <div class="difficulty-badge" id="diff-badge">LEVEL 4</div>

        <div id="content">
            <div class="header" id="header">
                <div class="level-tag">Advanced Grammar</div>
                <h1>Compound-Complex Sentences</h1>
                <div class="subtitle">複合複雜句</div>
            </div>

            <!-- Formula Visualization -->
            <div class="formula-container" id="formula">
                <div class="formula-block f-ic">Indep. Clause</div>
                <div class="formula-block f-plus">+</div>
                <div class="formula-block f-ic">Indep. Clause</div>
                <div class="formula-block f-plus">+</div>
                <div class="formula-block f-dc">Dep. Clause</div>
            </div>

            <!-- Dynamic Sentence Area -->
            <div class="sentence-container" id="sentence-area">
                <!-- Blocks injected via JS -->
            </div>
        </div>

        <div class="footer">
            <div class="subs-box">
                <div class="sub-text" id="sub-en"></div>
                <div class="sub-text sub-tc" id="sub-tc"></div>
            </div>

            <div class="controls">
                <button class="btn" id="btn-play-pause">
                    <!-- Play Icon -->
                    <svg id="icon-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    <!-- Pause Icon (Hidden initially) -->
                    <svg id="icon-pause" viewBox="0 0 24 24" style="display:none"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                </button>
                <div class="progress-track">
                    <div class="progress-fill" id="progress"></div>
                </div>
                <div style="font-size: 0.8rem; color: #666; font-family: monospace;">AUDIO ON</div>
            </div>
        </div>
    </div>

    <script>
        // --- Audio Engine (Web Audio API) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            const now = audioCtx.currentTime;

            if (type === 'pop') {
                // Soft pop for text appearing
                osc.type = 'sine';
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.exponentialRampToValueAtTime(600, now + 0.1);
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            } else if (type === 'snap') {
                // Mechanical snap for connections
                osc.type = 'square';
                osc.frequency.setValueAtTime(100, now);
                osc.frequency.exponentialRampToValueAtTime(50, now + 0.1);
                gainNode.gain.setValueAtTime(0.05, now);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
                osc.start(now);
                osc.stop(now + 0.15);
            } else if (type === 'whoosh') {
                // Low whoosh for transitions
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(100, now);
                osc.frequency.linearRampToValueAtTime(300, now + 0.3);
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(0.05, now + 0.15);
                gainNode.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            }
        }

        // --- DOM Elements ---
        const els = {
            header: document.getElementById('header'),
            formula: document.getElementById('formula'),
            sentenceArea: document.getElementById('sentence-area'),
            subEn: document.getElementById('sub-en'),
            subTc: document.getElementById('sub-tc'),
            diffBadge: document.getElementById('diff-badge'),
            btnPlay: document.getElementById('btn-play-pause'),
            iconPlay: document.getElementById('icon-play'),
            iconPause: document.getElementById('icon-pause'),
            progress: document.getElementById('progress'),
            formulaBlocks: document.querySelectorAll('.formula-block')
        };

        // --- Animation Logic ---
        let isPlaying = false;
        let currentStep = 0;
        let timer = null;
        
        // The Timeline script
        const timeline = [
            // Intro
            { t: 0, action: () => { 
                playSound('whoosh');
                els.header.style.opacity = 1; 
                els.header.style.transform = 'translateY(0)';
                setSub("Compound-Complex Sentences are the most sophisticated sentence type.", "複合複雜句是最複雜的句型。");
            }},
            { t: 4000, action: () => {
                setSub("They combine at least two Independent Clauses and one Dependent Clause.", "它們結合了至少兩個獨立子句和一個從屬子句。");
                els.formula.style.opacity = 1;
            }},
            { t: 6000, action: () => {
                playSound('pop');
                els.formulaBlocks[0].style.opacity = 1;
                els.formulaBlocks[0].style.transform = 'scale(1)';
            }},
            { t: 6500, action: () => {
                playSound('pop');
                els.formulaBlocks[2].style.opacity = 1;
                els.formulaBlocks[2].style.transform = 'scale(1)';
            }},
            { t: 7000, action: () => {
                playSound('snap');
                els.formulaBlocks[4].style.opacity = 1;
                els.formulaBlocks[4].style.transform = 'scale(1)';
                els.formulaBlocks[1].style.opacity = 1;
                els.formulaBlocks[3].style.opacity = 1;
            }},

            // LOW LEVEL
            { t: 9000, action: () => {
                clearStage();
                setDiff('LOW');
                setSub("Level 1: Basic Structure. Simple vocabulary.", "低階：基本結構。簡單的詞彙。");
            }},
            { t: 11000, action: () => addBlock("Because I was hungry,", "DC", "type-dc") },
            { t: 12500, action: () => addBlock("I cooked pasta,", "IC", "type-ic") },
            { t: 13500, action: () => addBlock("and", "CONN", "type-conn") },
            { t: 14000, action: () => addBlock("I ate it all.", "IC", "type-ic") },
            { t: 15000, action: () => setSub("Because I was hungry, I cooked pasta, and I ate it all.", "因為我很餓，我煮了義大利麵，而且我把它全吃光了。") },

            // MEDIUM LEVEL
            { t: 19000, action: () => {
                clearStage();
                setDiff('MID');
                setSub("Level 2: Adding logic and consequence.", "中階：加入邏輯和結果。");
            }},
            { t: 21000, action: () => addBlock("Kate missed the bus", "IC", "type-ic") },
            { t: 22500, action: () => addBlock("because she woke up late,", "DC", "type-dc") },
            { t: 24000, action: () => addBlock("so", "CONN", "type-conn") },
            { t: 24500, action: () => addBlock("she took a taxi.", "IC", "type-ic") },
            { t: 26000, action: () => setSub("Kate missed the bus because she woke up late, so she took a taxi.", "Kate 錯過了公車因為她起晚了，所以她搭了計程車。") },

            // HIGH LEVEL
            { t: 30000, action: () => {
                clearStage();
                setDiff('HIGH');
                setSub("Level 3: Professional, academic context with complex transitions.", "高階：專業、學術語境，搭配複雜的轉折。");
            }},
            { t: 33000, action: () => addBlock("Although the data was inconclusive,", "DC", "type-dc") },
            { t: 35000, action: () => addBlock("the team published the report;", "IC", "type-ic") },
            { t: 37000, action: () => addBlock("however,", "CONN", "type-conn") }, // using conjunctive adverb
            { t: 38000, action: () => addBlock("they added a disclaimer.", "IC", "type-ic") },
            { t: 40000, action: () => setSub("Although the data was inconclusive, the team published the report; however, they added a disclaimer.", "雖然數據尚無定論，團隊還是發布了報告；然而，他們加了一個免責聲明。") },

            // Outro
            { t: 46000, action: () => {
                clearStage();
                els.diffBadge.style.opacity = 0;
                els.header.style.opacity = 1;
                setSub("Master this structure to sound professional.", "掌握這個結構，讓你的表達更專業。");
            }},
            { t: 50000, action: () => pause() } // End
        ];

        const totalTime = 50000;
        let startTime = 0;
        let pauseTime = 0;
        let animationFrameId;
        let executedIndices = new Set();

        function start() {
            if (isPlaying) return;
            isPlaying = true;
            
            // UI Toggle
            els.iconPlay.style.display = 'none';
            els.iconPause.style.display = 'block';

            startTime = performance.now() - pauseTime;
            loop();
        }

        function pause() {
            if (!isPlaying) return;
            isPlaying = false;
            
            // UI Toggle
            els.iconPlay.style.display = 'block';
            els.iconPause.style.display = 'none';

            cancelAnimationFrame(animationFrameId);
            pauseTime = performance.now() - startTime;
        }

        function togglePlay() {
            if (isPlaying) pause();
            else start();
        }

        function loop() {
            const now = performance.now();
            const elapsed = now - startTime;

            // Update progress bar
            const pct = Math.min((elapsed / totalTime) * 100, 100);
            els.progress.style.width = `${pct}%`;

            // Check timeline
            timeline.forEach((item, index) => {
                if (elapsed >= item.t && !executedIndices.has(index)) {
                    item.action();
                    executedIndices.add(index);
                }
            });

            if (elapsed < totalTime) {
                animationFrameId = requestAnimationFrame(loop);
            } else {
                pause(); // Finish
            }
        }

        // --- Helper Functions ---

        function setSub(en, tc) {
            els.subEn.style.opacity = 0;
            els.subTc.style.opacity = 0;
            setTimeout(() => {
                els.subEn.textContent = en;
                els.subTc.textContent = tc;
                els.subEn.style.opacity = 1;
                els.subTc.style.opacity = 1;
            }, 300);
        }

        function setDiff(level) {
            els.diffBadge.textContent = level;
            els.diffBadge.className = 'difficulty-badge diff-active';
            // Pulse effect
            playSound('whoosh');
        }

        function clearStage() {
            els.sentenceArea.innerHTML = '';
            els.diffBadge.className = 'difficulty-badge'; // hide
            els.header.style.opacity = 0.2; // Dim header focus on sentences
            els.formula.style.opacity = 0;
        }

        function addBlock(text, label, typeClass) {
            const div = document.createElement('div');
            div.className = `word-block ${typeClass}`;
            div.textContent = text;
            div.setAttribute('data-type', label);
            
            els.sentenceArea.appendChild(div);
            
            // Trigger reflow
            void div.offsetWidth; 
            
            div.classList.add('visible');
            
            if(typeClass === 'type-conn') playSound('snap');
            else playSound('pop');
        }

        // --- Initialization ---
        els.btnPlay.addEventListener('click', togglePlay);
        
        // Auto-start (simulated click for audio context)
        document.body.addEventListener('click', () => {
            if(audioCtx.state === 'suspended') audioCtx.resume();
        }, {once:true});

    </script>
</body>
</html>

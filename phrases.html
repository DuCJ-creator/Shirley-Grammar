<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shirley's Phrases Study Platform</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body{
      font-family:'Noto Sans TC',sans-serif;
      background: radial-gradient(1200px circle at 10% -10%, #e8f0ff 0, transparent 60%),
                  radial-gradient(1200px circle at 100% 0%, #f7efe9 0, transparent 55%),
                  linear-gradient(180deg, #f6f8fb 0%, #eef2f7 100%);
      color:#243447;
      min-height:100vh;
      padding:14px;
    }
    .container{ max-width:1100px; margin:0 auto; }

    header{
      background:rgba(255,255,255,0.98);
      border-radius:14px;
      padding:16px 18px;
      box-shadow:0 6px 18px rgba(24,39,75,0.08);
      text-align:center;
      margin-bottom:12px;
    }
    h1{
      font-size:1.6rem;
      letter-spacing:.5px;
      color:#1f2d3d;
      margin-bottom:6px;
    }
    .description{ font-size:.95rem; color:#5b6b7a; }

    .content-area{
      background:#fff;
      border-radius:14px;
      padding:14px;
      box-shadow:0 8px 22px rgba(24,39,75,0.08);
      min-height:360px;
    }

    /* mode selector */
    .mode-bar{
      display:flex; gap:8px; flex-wrap:wrap;
      justify-content:center; margin-bottom:10px;
    }
    .mode-btn{
      border:none; cursor:pointer;
      padding:8px 14px;
      border-radius:999px;
      font-weight:700; font-size:.95rem;
      background:#f3f6fb; color:#1f2d3d;
      border:1px solid #e0e6ef;
      transition:.15s ease;
    }
    .mode-btn.active{
      background:linear-gradient(135deg,#4f8cff,#5bc0be);
      color:#fff; border-color:transparent;
      box-shadow:0 6px 14px rgba(79,140,255,0.35);
    }

    /* Search */
    .search-wrap{
      display:flex; gap:8px; align-items:center;
      border:1px solid #e6ebf2;
      background:#fbfcfe;
      border-radius:12px;
      padding:8px 10px;
      margin-bottom:10px;
    }
    .search-wrap input{
      width:100%;
      border:none; outline:none; background:transparent;
      font-size:1rem; color:#233445;
    }
    .search-wrap .hint{
      white-space:nowrap; font-size:.9rem; color:#7a8896;
    }

    /* Tabs (A-Z + Favorites) */
    .alpha-bar{
      display:flex; flex-wrap:wrap; gap:6px;
      margin-bottom:10px; user-select:none;
    }
    .alpha-btn{
      width:40px; height:40px;
      border-radius:999px;
      border:1px solid #d7e0ea;
      background:#f7f9fc;
      color:#2c3e50;
      font-weight:700;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      transition:.15s ease;
      box-shadow: inset 0 -1px 0 rgba(0,0,0,0.03);
    }
    .alpha-btn:hover{ transform:translateY(-1px); background:#eef4ff; }
    .alpha-btn.active{
      background:linear-gradient(135deg,#4f8cff,#5bc0be);
      color:white; border:none;
      box-shadow:0 6px 14px rgba(79,140,255,0.35);
    }
    .alpha-btn.fav{
      width:auto; padding:0 12px; gap:6px; font-weight:700;
    }

    /* Study list */
    .phrase-list{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(220px,1fr));
      gap:8px;
    }
    .phrase-item{
      background:#f8fafc;
      border:1px solid #eef2f7;
      border-radius:10px;
      padding:10px 10px 8px;
      cursor:pointer;
      transition:.15s ease;
      position:relative;
    }
    .phrase-item:hover{
      transform:translateY(-1px);
      background:#f1f6ff;
      border-color:#e1e8f1;
    }
    .phrase-title{
      font-size:1.02rem; font-weight:800;
      color:#1f2d3d; padding-right:34px; line-height:1.25;
    }
    .phrase-meaning{
      font-size:.9rem; color:#546575; margin-top:2px;
    }

    /* Star */
    .star{
      position:absolute; top:8px; right:8px;
      font-size:1.2rem; line-height:1;
      cursor:pointer; padding:4px; border-radius:6px;
      color:#9aa8b6; background:transparent;
      transition:.12s ease;
    }
    .star:hover{ background:#eaf1ff; color:#4f8cff; }
    .star.active{ color:#f3b21a; }

    /* detail (Study expand) */
    .detail{
      margin-top:6px;
      background:#fff;
      border-radius:8px;
      border:1px dashed #e3e8ef;
      padding:8px;
      font-size:.95rem;
      line-height:1.55;
      color:#22313f;
    }
    .detail .en{ font-weight:700; margin-bottom:4px; }
    .detail .zh{ color:#4b5b69; }
    .detail .label{
      display:inline-block;
      font-size:.8rem; font-weight:700;
      color:#4f8cff; margin-right:6px;
    }

    .empty{
      padding:14px; color:#7a8a99; font-size:1rem;
    }

    .footer-note{
      margin-top:10px; font-size:.85rem; color:#7a8a99; text-align:right;
    }

    /* Review flip cards */
    .card-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(240px,1fr));
      gap:10px;
    }
    .flip-card{
      perspective: 1000px;
      height: 180px;
      cursor:pointer;
    }
    .flip-inner{
      width:100%; height:100%;
      position: relative;
      transform-style: preserve-3d;
      transition: transform .5s ease;
      border-radius:12px;
    }
    .flip-card.flipped .flip-inner{
      transform: rotateY(180deg);
    }
    .flip-face{
      position:absolute; inset:0;
      backface-visibility: hidden;
      border-radius:12px;
      padding:12px;
      border:1px solid #e6ebf2;
      box-shadow:0 6px 14px rgba(24,39,75,0.06);
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:8px;
      background:#fff;
    }
    .flip-front{
      border-left:6px solid #4f8cff;
      background:linear-gradient(180deg,#ffffff 0%, #f7faff 100%);
    }
    .flip-back{
      transform: rotateY(180deg);
      border-left:6px solid #f3b21a;
      background:linear-gradient(180deg,#fffdf6 0%, #fff6de 100%);
    }
    .card-phrase{
      font-weight:800; font-size:1.15rem; color:#1f2d3d;
    }
    .card-en{
      font-size:.95rem; color:#2b3a48; line-height:1.5;
    }
    .card-meaning{
      font-weight:800; font-size:1.05rem; color:#3a2a00;
    }
    .card-zh{
      font-size:.95rem; color:#4b3d1c; line-height:1.5;
    }
    .card-tip{
      position:absolute; bottom:8px; right:10px;
      font-size:.78rem; color:#7a8896;
    }

    @media (max-width:768px){
      .phrase-list{ grid-template-columns:1fr 1fr; }
      .card-grid{ grid-template-columns:1fr 1fr; }
    }
    @media (max-width:480px){
      .phrase-list{ grid-template-columns:1fr; }
      .card-grid{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Shirley's Phrases Study Platform</h1>
      <div class="description">
        Studyï¼šå­—æ¯ç´¢å¼•å…ˆçœ‹ç‰‡èªï¼‹ä¸­æ–‡é‡‹ç¾©ï¼Œé»æ“Šå±•é–‹ä¾‹å¥<br/>
        Reviewï¼šå­—æ¯ç´¢å¼•ç¿»å¡è¤‡ç¿’ï¼ˆæ­£é¢è‹±ï¼èƒŒé¢ä¸­ï¼‰
      </div>
    </header>

    <div class="content-area">
      <!-- mode selector -->
      <div class="mode-bar">
        <button class="mode-btn active" data-mode="study">Study Mode å­¸ç¿’æ¨¡å¼</button>
        <button class="mode-btn" data-mode="review">Review Mode è¤‡ç¿’æ¨¡å¼ï¼ˆFlip Cardï¼‰</button>
      </div>

      <!-- Search -->
      <div class="search-wrap">
        <div style="font-size:1.05rem;">ğŸ”</div>
        <input id="search-input" type="text" placeholder="å¯è¼¸å…¥ç‰‡èªæˆ–ä¸­æ–‡æ„æ€æœå°‹ï¼ˆåœ¨ç›®å‰å­—æ¯/æ”¶è—ç¯„åœå…§ï¼‰" />
        <div class="hint" id="search-hint"></div>
      </div>

      <!-- A-Z + Favorites -->
      <div class="alpha-bar" id="alpha-bar"></div>

      <!-- Study list -->
      <div id="study-section">
        <div class="phrase-list" id="phrase-list">
          <div class="empty">è¼‰å…¥ä¸­...</div>
        </div>
      </div>

      <!-- Review cards -->
      <div id="review-section" style="display:none;">
        <div class="card-grid" id="card-grid"></div>
      </div>

      <div class="footer-note" id="footer-note"></div>
    </div>
  </div>

<script>
  // å¤šå€™é¸ç¶²å€ + HTML åµæ¸¬ï¼ˆé¿å… 404/redirect å› HTMLï¼‰
  const CSV_CANDIDATES = [
    "https://ducj-creator.github.io/Shirley-Grammar/phrases.csv",
    "https://ducj-creator.github.io/Shirley-Grammar/prepositions/phrases.csv",
    "https://raw.githubusercontent.com/DuCJ-creator/Shirley-Grammar/main/phrases.csv",
    "https://raw.githubusercontent.com/DuCJ-creator/Shirley-Grammar/main/prepositions/phrases.csv"
  ];

  const STORAGE_KEY = "shirley_phrases_favorites_v1";

  let phrases = [];
  let currentLetter = "A";
  let currentMode = "alpha"; // alpha | fav
  let viewMode = "study";    // study | review
  let favorites = new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"));

  document.addEventListener("DOMContentLoaded", async () => {
    renderAlphaBar();
    bindSearch();
    bindModeButtons();

    await loadPhrasesWithFallback();

    renderAll();
  });

  /* ========== Mode buttons ========== */
  function bindModeButtons(){
    document.querySelectorAll(".mode-btn").forEach(btn=>{
      btn.onclick=()=>{
        document.querySelectorAll(".mode-btn").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        viewMode = btn.dataset.mode;
        document.getElementById("study-section").style.display = viewMode==="study" ? "block" : "none";
        document.getElementById("review-section").style.display = viewMode==="review" ? "block" : "none";
        renderAll();
      };
    });
  }

  /* ========== Load CSV (fallback + detect HTML) ========== */
  async function loadPhrasesWithFallback(){
    const listEl = document.getElementById("phrase-list");

    for (const url of CSV_CANDIDATES){
      try{
        const res = await fetch(url, { cache:"no-store" });
        if(!res.ok) throw new Error("HTTP " + res.status);

        const text = await res.text();

        // âœ… å¦‚æœå›ä¾†æ˜¯ HTMLï¼Œå°±è¦–ç‚ºå¤±æ•—ï¼ˆæ›ä¸‹ä¸€å€‹ï¼‰
        const lower = text.slice(0, 500).toLowerCase();
        if (lower.includes("<html") || lower.includes("<!doctype")) {
          throw new Error("Not CSV (HTML returned)");
        }

        const data = parseCSV(text);
        if(data.length){
          phrases = data;
          document.getElementById("footer-note").textContent =
            `è³‡æ–™ä¾†æºï¼š${url}ï¼ˆå·²è¼‰å…¥ ${phrases.length} ç­†ï¼‰`;
          return;
        }
      }catch(err){
        console.warn("CSV failed:", url, err);
      }
    }

    listEl.innerHTML = `<div class="empty">
      CSV è¼‰å…¥å¤±æ•—ï¼šç›®å‰æ‰€æœ‰å€™é¸ç¶²å€å›ä¾†éƒ½ä¸æ˜¯ CSV æˆ–ç„¡è³‡æ–™ã€‚<br/>
      ä½ åªè¦æä¾›æ­£ç¢º phrases.csv é€£çµï¼Œæˆ‘é¦¬ä¸Šå¹«ä½ æŠŠå€™é¸æ”¹æˆå”¯ä¸€ç¶²å€ã€‚
    </div>`;
  }

  function parseCSV(csvText){
    const rows = csvText.trim().split(/\r?\n/).filter(Boolean);
    if(!rows.length) return [];

    const headers = splitCSVLine(rows[0]).map(h => h.trim().toLowerCase());
    const idx = {
      phrase: headers.findIndex(h => h.includes("phrase")),
      meaning: headers.findIndex(h => h.includes("meaning") || h.includes("ä¸­æ–‡")),
      en: headers.findIndex(h => h.includes("english")),
      zh: headers.findIndex(h => h.includes("chinese"))
    };

    const out = [];
    for(let i=1;i<rows.length;i++){
      const cols = splitCSVLine(rows[i]);

      const phrase = (cols[idx.phrase] || "").trim();
      if(!phrase) continue;

      out.push({
        phrase,
        meaning: (cols[idx.meaning] || "").trim(),
        english: (cols[idx.en] || "").trim(),
        chinese: (cols[idx.zh] || "").trim()
      });
    }
    return out;
  }

  function splitCSVLine(line){
    const result = [];
    let cur="", inQuotes=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='"'){
        if(inQuotes && line[i+1]==='"'){ cur+='"'; i++; }
        else inQuotes=!inQuotes;
      }else if(ch===',' && !inQuotes){
        result.push(cur); cur="";
      }else cur+=ch;
    }
    result.push(cur);
    return result;
  }

  /* ========== Alpha bar ========== */
  function renderAlphaBar(){
    const bar = document.getElementById("alpha-bar");
    bar.innerHTML = "";

    // ğŸŒŸ favorites tab
    const favBtn = document.createElement("button");
    favBtn.className = "alpha-btn fav" + (currentMode==="fav" ? " active" : "");
    favBtn.textContent = "ğŸŒŸ æ”¶è—";
    favBtn.onclick = () => {
      currentMode = "fav";
      setActiveButtons();
      renderAll();
    };
    bar.appendChild(favBtn);

    // A-Z
    for(let c=65;c<=90;c++){
      const letter = String.fromCharCode(c);
      const btn = document.createElement("button");
      btn.className = "alpha-btn " + (currentMode==="alpha" && currentLetter===letter ? "active" : "");
      btn.textContent = letter;
      btn.onclick = () => {
        currentMode = "alpha";
        currentLetter = letter;
        setActiveButtons();
        renderAll();
      };
      bar.appendChild(btn);
    }

    setHint();
  }

  function setActiveButtons(){
    document.querySelectorAll(".alpha-btn").forEach(b => b.classList.remove("active"));
    document.querySelectorAll(".alpha-btn").forEach(b => {
      if(b.classList.contains("fav") && currentMode==="fav") b.classList.add("active");
      if(!b.classList.contains("fav") && currentMode==="alpha" && b.textContent===currentLetter){
        b.classList.add("active");
      }
    });
    setHint();
  }

  function setHint(){
    const hint = document.getElementById("search-hint");
    hint.textContent = currentMode==="fav" ? "ç¯„åœï¼šæ”¶è—" : `ç¯„åœï¼š${currentLetter}`;
  }

  /* ========== Search ========== */
  function bindSearch(){
    document.getElementById("search-input").addEventListener("input", renderAll);
  }

  /* ========== Render pipeline ========== */
  function getCurrentPool(){
    const q = document.getElementById("search-input").value.trim().toLowerCase();

    let pool = [];
    if(currentMode==="fav"){
      pool = phrases.filter(p => favorites.has(p.phrase));
    }else{
      pool = phrases.filter(p => (p.phrase[0]||"").toUpperCase() === currentLetter);
    }

    if(q){
      pool = pool.filter(p =>
        p.phrase.toLowerCase().includes(q) ||
        (p.meaning||"").toLowerCase().includes(q)
      );
    }
    return pool;
  }

  function renderAll(){
    if(!phrases.length){
      // loader already handled empty text
      return;
    }
    const pool = getCurrentPool();
    if(viewMode==="study") renderStudy(pool);
    if(viewMode==="review") renderReview(pool);
  }

  /* ========== Study list ========== */
  function renderStudy(pool){
    const listEl = document.getElementById("phrase-list");
    listEl.innerHTML = "";

    if(!pool.length){
      listEl.innerHTML = `<div class="empty">${
        currentMode==="fav" ? "ç›®å‰æ²’æœ‰æ”¶è—ç‰‡èªã€‚" : "æ­¤å­—æ¯ç›®å‰æ²’æœ‰ç‰‡èªã€‚"
      }</div>`;
      return;
    }

    pool.forEach(p => listEl.appendChild(buildPhraseItem(p)));
  }

  function buildPhraseItem(p){
    const item = document.createElement("div");
    item.className = "phrase-item";
    item.dataset.open = "0";

    const star = document.createElement("div");
    star.className = "star" + (favorites.has(p.phrase) ? " active" : "");
    star.textContent = favorites.has(p.phrase) ? "ğŸŒŸ" : "â˜†";
    star.title = favorites.has(p.phrase) ? "å–æ¶ˆæ”¶è—" : "åŠ å…¥æ”¶è—";
    star.onclick = (e) => {
      e.stopPropagation();
      toggleFavorite(p.phrase);
      star.classList.toggle("active");
      star.textContent = favorites.has(p.phrase) ? "ğŸŒŸ" : "â˜†";
      star.title = favorites.has(p.phrase) ? "å–æ¶ˆæ”¶è—" : "åŠ å…¥æ”¶è—";
      if(currentMode==="fav") renderAll();
    };

    const title = document.createElement("div");
    title.className = "phrase-title";
    title.textContent = p.phrase;

    const meaning = document.createElement("div");
    meaning.className = "phrase-meaning";
    meaning.textContent = p.meaning || "";

    item.appendChild(star);
    item.appendChild(title);
    item.appendChild(meaning);

    item.onclick = () => toggleDetail(item, p);

    return item;
  }

  function toggleDetail(item, p){
    const open = item.dataset.open === "1";
    if(open){
      const detail = item.querySelector(".detail");
      if(detail) detail.remove();
      item.dataset.open = "0";
      return;
    }
    const detail = document.createElement("div");
    detail.className = "detail";
    detail.innerHTML = `
      ${p.english ? `<div class="en"><span class="label">EN</span>${escapeHTML(p.english)}</div>` : ""}
      ${p.chinese ? `<div class="zh"><span class="label">ZH</span>${escapeHTML(p.chinese)}</div>` : ""}
      ${(!p.english && !p.chinese) ? `<div class="zh">ï¼ˆæ­¤ç‰‡èªå°šç„¡ä¾‹å¥ï¼‰</div>` : ""}
    `;
    item.appendChild(detail);
    item.dataset.open = "1";
  }

  /* ========== Review flip cards ========== */
  function renderReview(pool){
    const grid = document.getElementById("card-grid");
    grid.innerHTML = "";

    if(!pool.length){
      grid.innerHTML = `<div class="empty">${
        currentMode==="fav" ? "ç›®å‰æ²’æœ‰æ”¶è—ç‰‡èªã€‚" : "æ­¤å­—æ¯ç›®å‰æ²’æœ‰ç‰‡èªã€‚"
      }</div>`;
      return;
    }

    pool.forEach(p=>{
      const card = document.createElement("div");
      card.className = "flip-card";
      card.innerHTML = `
        <div class="flip-inner">
          <div class="flip-face flip-front">
            <div class="card-phrase">${escapeHTML(p.phrase)}</div>
            <div class="card-en">${escapeHTML(p.english || "ï¼ˆç„¡è‹±æ–‡ä¾‹å¥ï¼‰")}</div>
            <div class="card-tip">é»ä¸€ä¸‹ç¿»é¢</div>
          </div>
          <div class="flip-face flip-back">
            <div class="card-meaning">${escapeHTML(p.meaning || "ï¼ˆç„¡ä¸­æ–‡é‡‹ç¾©ï¼‰")}</div>
            <div class="card-zh">${escapeHTML(p.chinese || "ï¼ˆç„¡ä¸­æ–‡ä¾‹å¥ï¼‰")}</div>
            <div class="card-tip">é»ä¸€ä¸‹ç¿»å›</div>
          </div>
        </div>
      `;
      card.onclick=()=>card.classList.toggle("flipped");
      grid.appendChild(card);
    });
  }

  /* ========== Favorites ========== */
  function toggleFavorite(phrase){
    if(favorites.has(phrase)) favorites.delete(phrase);
    else favorites.add(phrase);
    localStorage.setItem(STORAGE_KEY, JSON.stringify([...favorites]));
  }

  function escapeHTML(str){
    return (str||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll("\"","&quot;");
  }
</script>
</body>
</html>

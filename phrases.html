<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Shirley's Phrases | Premium Study Platform</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #4361ee;
      --primary-gradient: linear-gradient(135deg, #4361ee, #3a0ca3);
      --accent: #f72585;
      --text-main: #2b2d42;
      --text-sub: #8d99ae;
      --bg-color: #f8f9fa;
      --glass-bg: rgba(255, 255, 255, 0.75);
      --glass-border: rgba(255, 255, 255, 0.6);
      --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      --shadow-md: 0 10px 25px -5px rgba(67, 97, 238, 0.15), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
      --radius: 16px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Inter', 'Noto Sans TC', sans-serif;
      background-color: #f0f2f5;
      /* Êõ¥Âä†ÊüîÂíåÈ´òÁ¥öÁöÑÂãïÊÖãËÉåÊôØ */
      background-image: 
        radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
        radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
        radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
      background-size: 100% 100vh;
      background-attachment: fixed;
      background-repeat: no-repeat;
      color: var(--text-main);
      min-height: 100vh;
      padding: 20px 10px;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    /* === Header === */
    header {
      text-align: center;
      margin-bottom: 24px;
      color: white;
      padding: 20px 0;
      animation: fadeInDown 0.8s ease;
    }
    
    h1 {
      font-size: 2rem;
      font-weight: 800;
      letter-spacing: -0.5px;
      margin-bottom: 8px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    .description {
      font-size: 0.95rem;
      color: rgba(255,255,255,0.85);
      line-height: 1.6;
      font-weight: 500;
    }

    /* === Main Glass Panel === */
    .content-area {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow-md);
      min-height: 60vh;
      transition: transform 0.3s ease;
    }

    /* === Controls (Mode + Search) === */
    .controls-wrapper {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 20px;
    }

    /* Mode Switcher */
    .mode-bar {
      display: flex;
      background: #eef1f6;
      padding: 4px;
      border-radius: 12px;
      width: fit-content;
      margin: 0 auto;
    }
    
    .mode-btn {
      border: none;
      background: transparent;
      padding: 8px 24px;
      border-radius: 10px;
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--text-sub);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .mode-btn.active {
      background: white;
      color: var(--primary);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    /* Search Bar */
    .search-wrap {
      position: relative;
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
    }
    
    .search-wrap input {
      width: 100%;
      padding: 14px 14px 14px 48px;
      border-radius: 14px;
      border: 2px solid transparent;
      background: white;
      font-size: 1rem;
      color: var(--text-main);
      box-shadow: var(--shadow-sm);
      transition: all 0.2s ease;
    }
    
    .search-wrap input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.15);
    }
    
    .search-icon {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.1rem;
      pointer-events: none;
      opacity: 0.5;
    }
    
    .hint {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.8rem;
      color: var(--text-sub);
      background: #f0f2f5;
      padding: 2px 8px;
      border-radius: 6px;
      pointer-events: none;
    }

    /* === A-Z Navigation === */
    .alpha-bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 6px;
      margin-bottom: 24px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    
    .alpha-btn {
      width: 36px;
      height: 36px;
      border: 1px solid transparent;
      border-radius: 10px;
      background: white;
      color: var(--text-main);
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 4px rgba(0,0,0,0.03);
    }
    
    .alpha-btn:hover {
      transform: translateY(-2px);
      color: var(--primary);
    }
    
    .alpha-btn.active {
      background: var(--primary);
      color: white;
      box-shadow: 0 4px 12px rgba(67, 97, 238, 0.4);
    }
    
    .alpha-btn.fav {
      width: auto;
      padding: 0 16px;
      background: #fff0f3;
      color: #d00000;
    }
    
    .alpha-btn.fav.active {
      background: var(--accent);
      color: white;
      box-shadow: 0 4px 12px rgba(247, 37, 133, 0.4);
    }

    /* === Content Lists === */
    .phrase-list, .card-grid {
      display: grid;
      gap: 16px;
    }
    
    .phrase-list {
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    }

    /* === Phrase Item (Study) === */
    .phrase-item {
      background: white;
      border-radius: 14px;
      padding: 16px;
      cursor: pointer;
      position: relative;
      border: 1px solid #eef1f6;
      transition: all 0.25s ease;
      animation: fadeInUp 0.5s ease backwards;
    }
    
    .phrase-item:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-md);
      border-color: rgba(67, 97, 238, 0.3);
    }
    
    .phrase-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 4px;
    }

    .phrase-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-main);
      line-height: 1.3;
      padding-right: 30px;
    }
    
    .phrase-meaning {
      font-size: 0.95rem;
      color: var(--text-sub);
    }

    /* Star Icon */
    .star {
      position: absolute;
      top: 16px;
      right: 16px;
      font-size: 1.2rem;
      color: #e0e0e0;
      transition: 0.2s;
      z-index: 2;
    }
    .star:hover { transform: scale(1.2); }
    .star.active { color: #ffbe0b; filter: drop-shadow(0 0 5px rgba(255, 190, 11, 0.5)); }

    /* Expanded Detail */
    .detail {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px dashed #eef1f6;
      font-size: 0.95rem;
      line-height: 1.6;
      animation: slideDown 0.3s ease;
    }
    
    .detail-row { margin-bottom: 8px; }
    .detail-row:last-child { margin-bottom: 0; }
    
    .badge {
      display: inline-block;
      font-size: 0.7rem;
      font-weight: 800;
      padding: 2px 6px;
      border-radius: 4px;
      margin-right: 6px;
      vertical-align: middle;
    }
    .badge.en { background: #eef4ff; color: var(--primary); }
    .badge.zh { background: #fff0f3; color: var(--accent); }
    
    .text-content { color: var(--text-main); }

    /* === Review Flip Cards === */
    .card-grid {
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    }

    .flip-card {
      perspective: 1200px;
      height: 220px;
      cursor: pointer;
      animation: fadeInUp 0.5s ease backwards;
    }
    
    .flip-inner {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 16px;
      box-shadow: var(--shadow-sm);
    }
    
    .flip-card.flipped .flip-inner {
      transform: rotateY(180deg);
      box-shadow: var(--shadow-md);
    }
    
    .flip-face {
      position: absolute;
      inset: 0;
      backface-visibility: hidden;
      border-radius: 16px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      border: 1px solid rgba(0,0,0,0.03);
    }
    
    .flip-front {
      background: white;
    }
    .flip-front::after {
      content: '';
      position: absolute;
      top: 0; left: 0; bottom: 0; width: 6px;
      background: var(--primary);
      border-radius: 16px 0 0 16px;
    }
    
    .flip-back {
      background: #fffcf2;
      transform: rotateY(180deg);
      border: 1px solid #ffe6a7;
    }
    .flip-back::after {
      content: '';
      position: absolute;
      top: 0; right: 0; bottom: 0; width: 6px;
      background: #ffbe0b;
      border-radius: 0 16px 16px 0;
    }

    .card-main-text {
      font-size: 1.3rem;
      font-weight: 800;
      color: var(--text-main);
      margin-bottom: 10px;
    }
    .card-sub-text {
      font-size: 0.95rem;
      color: var(--text-sub);
      line-height: 1.4;
    }
    .card-hint {
      position: absolute;
      bottom: 12px;
      font-size: 0.75rem;
      color: #bdc3c7;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* === Utilities === */
    .empty {
      grid-column: 1 / -1;
      text-align: center;
      padding: 40px;
      color: var(--text-sub);
      font-size: 1.1rem;
      background: rgba(255,255,255,0.5);
      border-radius: 14px;
    }
    
    .footer-note {
      margin-top: 20px;
      font-size: 0.8rem;
      color: rgba(141, 153, 174, 0.7);
      text-align: center;
    }

    /* === Animations === */
    @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideDown { from { opacity: 0; height: 0; transform: translateY(-10px); } to { opacity: 1; height: auto; transform: translateY(0); } }

    /* === Responsive === */
    @media (max-width: 768px) {
      .container { width: 100%; padding: 0; }
      .content-area { border-radius: 20px 20px 0 0; min-height: 80vh; padding: 20px; }
      h1 { font-size: 1.5rem; }
      .mode-bar { width: 100%; display: grid; grid-template-columns: 1fr 1fr; }
      .mode-btn { text-align: center; }
      .flip-card { height: 260px; }
    }
  </style>
</head>
<body>

  <div class="container">
    <header>
      <h1>Shirley's Phrases</h1>
      <div class="description">
        Premium Learning Experience<br/>
        <span style="opacity:0.7; font-size:0.85rem">Study Mode for deep learning ¬∑ Review Mode for quick recall</span>
      </div>
    </header>

    <div class="content-area">
      
      <div class="controls-wrapper">
        <div class="mode-bar">
          <button class="mode-btn active" data-mode="study">üìö Study Mode</button>
          <button class="mode-btn" data-mode="review">üß† Review Cards</button>
        </div>

        <div class="search-wrap">
          <div class="search-icon">üîç</div>
          <input id="search-input" type="text" placeholder="Type to search global phrases..." />
          <div class="hint" id="search-hint">Range: A</div>
        </div>
      </div>

      <div class="alpha-bar" id="alpha-bar"></div>

      <div id="study-section">
        <div class="phrase-list" id="phrase-list">
          <div class="empty">Initializing Data...</div>
        </div>
      </div>

      <div id="review-section" style="display:none;">
        <div class="card-grid" id="card-grid"></div>
      </div>

      <div class="footer-note" id="footer-note"></div>
    </div>
  </div>

<script>
  /* * Updated for Global Search Functionality
   */
  const CSV_CANDIDATES = [
    "https://ducj-creator.github.io/Shirley-Grammar/phrases.csv",
    "https://ducj-creator.github.io/Shirley-Grammar/prepositions/phrases.csv",
    "https://raw.githubusercontent.com/DuCJ-creator/Shirley-Grammar/main/phrases.csv",
    "https://raw.githubusercontent.com/DuCJ-creator/Shirley-Grammar/main/prepositions/phrases.csv"
  ];

  const STORAGE_KEY = "shirley_phrases_favorites_v2";

  let phrases = [];
  let currentLetter = "A";
  let currentMode = "alpha"; 
  let viewMode = "study";   
  let favorites = new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"));

  document.addEventListener("DOMContentLoaded", async () => {
    renderAlphaBar();
    bindSearch();
    bindModeButtons();
    await loadPhrasesWithFallback();
    renderAll();
  });

  function bindModeButtons(){
    document.querySelectorAll(".mode-btn").forEach(btn=>{
      btn.onclick=()=>{
        document.querySelectorAll(".mode-btn").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        viewMode = btn.dataset.mode;
        
        // Simple fade effect
        const content = document.querySelector('.content-area');
        content.style.opacity = '0.5';
        setTimeout(() => {
            document.getElementById("study-section").style.display = viewMode==="study" ? "block" : "none";
            document.getElementById("review-section").style.display = viewMode==="review" ? "block" : "none";
            renderAll();
            content.style.opacity = '1';
        }, 150);
      };
    });
  }

  async function loadPhrasesWithFallback(){
    const listEl = document.getElementById("phrase-list");
    for (const url of CSV_CANDIDATES){
      try{
        const res = await fetch(url, { cache:"no-store" });
        if(!res.ok) throw new Error("HTTP " + res.status);
        const text = await res.text();
        const lower = text.slice(0, 500).toLowerCase();
        if (lower.includes("<html") || lower.includes("<!doctype")) {
          throw new Error("Not CSV (HTML returned)");
        }
        const data = parseCSV(text);
        if(data.length){
          phrases = data;
          document.getElementById("footer-note").textContent = `Source Connected ‚Ä¢ ${phrases.length} phrases loaded`;
          return;
        }
      }catch(err){
        console.warn("CSV failed:", url, err);
      }
    }
    listEl.innerHTML = `<div class="empty">‚ùå Failed to load data. Please check connection.</div>`;
  }

  function parseCSV(csvText){
    const rows = csvText.trim().split(/\r?\n/).filter(Boolean);
    if(!rows.length) return [];
    const headers = splitCSVLine(rows[0]).map(h => h.trim().toLowerCase());
    const idx = {
      phrase: headers.findIndex(h => h.includes("phrase")),
      meaning: headers.findIndex(h => h.includes("meaning") || h.includes("‰∏≠Êñá")),
      en: headers.findIndex(h => h.includes("english")),
      zh: headers.findIndex(h => h.includes("chinese"))
    };
    const out = [];
    for(let i=1;i<rows.length;i++){
      const cols = splitCSVLine(rows[i]);
      const phrase = (cols[idx.phrase] || "").trim();
      if(!phrase) continue;
      out.push({
        phrase,
        meaning: (cols[idx.meaning] || "").trim(),
        english: (cols[idx.en] || "").trim(),
        chinese: (cols[idx.zh] || "").trim()
      });
    }
    return out;
  }

  function splitCSVLine(line){
    const result = [];
    let cur="", inQuotes=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='"'){
        if(inQuotes && line[i+1]==='"'){ cur+='"'; i++; }
        else inQuotes=!inQuotes;
      }else if(ch===',' && !inQuotes){
        result.push(cur); cur="";
      }else cur+=ch;
    }
    result.push(cur);
    return result;
  }

  function renderAlphaBar(){
    const bar = document.getElementById("alpha-bar");
    bar.innerHTML = "";
    
    const favBtn = document.createElement("button");
    favBtn.className = "alpha-btn fav" + (currentMode==="fav" ? " active" : "");
    favBtn.innerHTML = "‚òÖ Favorites";
    favBtn.onclick = () => {
      currentMode = "fav";
      // Clear search when switching categories
      document.getElementById("search-input").value = ""; 
      setActiveButtons();
      renderAll();
    };
    bar.appendChild(favBtn);

    for(let c=65;c<=90;c++){
      const letter = String.fromCharCode(c);
      const btn = document.createElement("button");
      btn.className = "alpha-btn " + (currentMode==="alpha" && currentLetter===letter ? "active" : "");
      btn.textContent = letter;
      btn.onclick = () => {
        currentMode = "alpha";
        currentLetter = letter;
        // Clear search when switching letters
        document.getElementById("search-input").value = ""; 
        setActiveButtons();
        renderAll();
      };
      bar.appendChild(btn);
    }
    setHint();
  }

  function setActiveButtons(){
    document.querySelectorAll(".alpha-btn").forEach(b => b.classList.remove("active"));
    document.querySelectorAll(".alpha-btn").forEach(b => {
      if(b.classList.contains("fav") && currentMode==="fav") b.classList.add("active");
      if(!b.classList.contains("fav") && currentMode==="alpha" && b.textContent===currentLetter){
        b.classList.add("active");
      }
    });
    setHint();
  }

  function setHint(){
    const hint = document.getElementById("search-hint");
    hint.textContent = currentMode==="fav" ? "Scope: Favorites" : `Scope: ${currentLetter}`;
    hint.style.color = "var(--text-sub)";
    hint.style.fontWeight = "normal";
  }

  function bindSearch(){
    document.getElementById("search-input").addEventListener("input", renderAll);
  }

  /**
   * KEY UPDATE: Global Search Logic
   * If search text exists, ignore categories and search EVERYTHING.
   */
  function getCurrentPool(){
    const q = document.getElementById("search-input").value.trim().toLowerCase();
    
    // 1. GLOBAL SEARCH MODE (If input is not empty)
    if(q){
      // Visual feedback that we are searching everything
      const hint = document.getElementById("search-hint");
      hint.textContent = "Scope: Global Search";
      hint.style.color = "var(--primary)";
      hint.style.fontWeight = "bold";

      return phrases.filter(p =>
        p.phrase.toLowerCase().includes(q) ||
        (p.meaning||"").toLowerCase().includes(q)
      );
    }

    // 2. CATEGORY MODE (If input is empty)
    setHint(); // Reset hint to "Scope: A" or "Scope: Favorites"

    if(currentMode==="fav"){
      return phrases.filter(p => favorites.has(p.phrase));
    }else{
      return phrases.filter(p => (p.phrase[0]||"").toUpperCase() === currentLetter);
    }
  }

  function renderAll(){
    if(!phrases.length) return;
    const pool = getCurrentPool();
    if(viewMode==="study") renderStudy(pool);
    if(viewMode==="review") renderReview(pool);
  }

  /* Study Renderer */
  function renderStudy(pool){
    const listEl = document.getElementById("phrase-list");
    listEl.innerHTML = "";
    if(!pool.length){
      // Custom empty message based on context
      const isSearch = document.getElementById("search-input").value.trim().length > 0;
      let msg = "";
      if (isSearch) msg = "No global results found for this search.";
      else if (currentMode==="fav") msg = "No favorites yet. Go add some stars! ‚≠ê";
      else msg = "No phrases found in this section.";
      
      listEl.innerHTML = `<div class="empty">${msg}</div>`;
      return;
    }
    // Stagger animation delay
    pool.forEach((p, index) => {
        const item = buildPhraseItem(p);
        item.style.animationDelay = `${Math.min(index * 0.05, 0.5)}s`;
        listEl.appendChild(item);
    });
  }

  function buildPhraseItem(p){
    const item = document.createElement("div");
    item.className = "phrase-item";
    item.dataset.open = "0";

    const star = document.createElement("div");
    star.className = "star" + (favorites.has(p.phrase) ? " active" : "");
    star.textContent = "‚òÖ";
    star.onclick = (e) => {
      e.stopPropagation();
      toggleFavorite(p.phrase);
      star.classList.toggle("active");
      // Only re-render if we are in Favorites mode AND not searching
      const isSearch = document.getElementById("search-input").value.trim().length > 0;
      if(currentMode==="fav" && !isSearch) renderAll();
    };

    const header = document.createElement("div");
    header.className = "phrase-header";

    const title = document.createElement("div");
    title.className = "phrase-title";
    title.textContent = p.phrase;

    header.appendChild(title);

    const meaning = document.createElement("div");
    meaning.className = "phrase-meaning";
    meaning.textContent = p.meaning || "";

    item.appendChild(star);
    item.appendChild(header);
    item.appendChild(meaning);

    item.onclick = () => toggleDetail(item, p);
    return item;
  }

  function toggleDetail(item, p){
    const open = item.dataset.open === "1";
    if(open){
      const detail = item.querySelector(".detail");
      if(detail) detail.remove();
      item.dataset.open = "0";
      return;
    }
    const detail = document.createElement("div");
    detail.className = "detail";
    detail.innerHTML = `
      ${p.english ? `<div class="detail-row"><span class="badge en">EN</span><span class="text-content">${escapeHTML(p.english)}</span></div>` : ""}
      ${p.chinese ? `<div class="detail-row"><span class="badge zh">ZH</span><span class="text-content">${escapeHTML(p.chinese)}</span></div>` : ""}
      ${(!p.english && !p.chinese) ? `<div class="detail-row" style="color:#ccc;font-style:italic">No examples available.</div>` : ""}
    `;
    item.appendChild(detail);
    item.dataset.open = "1";
  }

  /* Review Renderer */
  function renderReview(pool){
    const grid = document.getElementById("card-grid");
    grid.innerHTML = "";
    if(!pool.length){
       const isSearch = document.getElementById("search-input").value.trim().length > 0;
       let msg = isSearch ? "No matches." : (currentMode==="fav" ? "No favorites to review." : "No phrases here.");
       grid.innerHTML = `<div class="empty">${msg}</div>`;
      return;
    }
    pool.forEach((p, index)=>{
      const card = document.createElement("div");
      card.className = "flip-card";
      card.style.animationDelay = `${Math.min(index * 0.05, 0.5)}s`;
      card.innerHTML = `
        <div class="flip-inner">
          <div class="flip-face flip-front">
            <div class="card-main-text">${escapeHTML(p.phrase)}</div>
            <div class="card-sub-text">${escapeHTML(p.english || "")}</div>
            <div class="card-hint">Tap to Flip</div>
          </div>
          <div class="flip-face flip-back">
            <div class="card-main-text" style="color:#e07a5f">${escapeHTML(p.meaning || "")}</div>
            <div class="card-sub-text">${escapeHTML(p.chinese || "")}</div>
            <div class="card-hint" style="color:#d4a373">Tap to Back</div>
          </div>
        </div>
      `;
      card.onclick=()=>card.classList.toggle("flipped");
      grid.appendChild(card);
    });
  }

  function toggleFavorite(phrase){
    if(favorites.has(phrase)) favorites.delete(phrase);
    else favorites.add(phrase);
    localStorage.setItem(STORAGE_KEY, JSON.stringify([...favorites]));
  }

  function escapeHTML(str){
    return (str||"").replace(/[&<>"']/g, function(m) {
      return {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'}[m];
    });
  }
</script>
</body>
</html>

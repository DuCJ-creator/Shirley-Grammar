<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Shirley's Phrases Study Platform</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; margin:0; padding:0; }
    body{
      font-family:'Noto Sans TC', sans-serif;
      color:#1f2d3d;
      background: radial-gradient(1200px circle at 10% -10%, #e8f7f4 0%, transparent 55%),
                  radial-gradient(1200px circle at 110% -30%, #eef3ff 0%, transparent 60%),
                  linear-gradient(180deg, #f7f9fc 0%, #eef2f7 100%);
      min-height:100vh;
      padding:12px;
    }

    .container{ max-width:1100px; margin:0 auto; }

    header{
      text-align:center;
      padding:14px 16px;
      background:rgba(255,255,255,0.96);
      border-radius:12px;
      box-shadow:0 6px 18px rgba(31,45,61,0.08);
      margin-bottom:12px;
      border:1px solid #e7ecf3;
    }
    h1{
      font-size:1.45rem;
      color:#123c4a;
      letter-spacing:.5px;
      margin-bottom:4px;
    }
    .description{
      font-size:.9rem;
      color:#5b6b7a;
    }

    .content-area{
      background:#fff;
      border-radius:12px;
      padding:14px;
      box-shadow:0 8px 22px rgba(20,35,50,0.08);
      border:1px solid #e7ecf3;
      min-height:360px;
    }

    /* A-Z index */
    .az-bar{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      justify-content:center;
      margin:6px 0 12px;
    }
    .az-btn{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #d7e3ea;
      background:#f2f7f6;
      color:#1f4b57;
      font-weight:700;
      font-size:.9rem;
      cursor:pointer;
      transition:.18s ease;
    }
    .az-btn:hover{ transform:translateY(-1px); background:#e8f4f2; }
    .az-btn.active{
      background:linear-gradient(135deg,#2bb3a3,#2f80ed);
      color:#fff;
      border-color:transparent;
      box-shadow:0 6px 14px rgba(47,128,237,0.25);
    }

    /* toolbar */
    .toolbar{
      display:flex; gap:8px; flex-wrap:wrap;
      align-items:center; justify-content:space-between;
      margin-bottom:10px;
    }
    .search{
      flex:1; min-width:180px;
      display:flex; align-items:center; gap:6px;
      background:#f6f9fc;
      border:1px solid #e3e9f0;
      border-radius:10px;
      padding:6px 8px;
    }
    .search input{
      border:none; outline:none; background:transparent;
      width:100%; font-size:.95rem;
    }
    .count{
      font-size:.85rem; color:#5c6b7a;
      white-space:nowrap;
    }

    .fav-toggle{
      display:flex; align-items:center; gap:6px;
      background:#f6f9fc;
      border:1px solid #e3e9f0;
      padding:6px 10px;
      border-radius:10px;
      cursor:pointer;
      font-size:.9rem;
      user-select:none;
      transition:.15s ease;
      white-space:nowrap;
    }
    .fav-toggle.active{
      background:#fff3d6;
      border-color:#ffd78a;
      box-shadow:0 4px 10px rgba(255, 188, 65, .25);
      font-weight:700;
    }

    /* list */
    .phrase-list{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
      gap:8px;
    }
    .phrase-item{
      background:#f8fbfd;
      border:1px solid #e9eff5;
      border-left:4px solid #2bb3a3;
      border-radius:10px;
      padding:10px 10px;
      cursor:pointer;
      transition:.18s ease;
      position:relative;
    }
    .phrase-item:hover{
      background:#f1f7fb;
      transform:translateY(-1px);
    }
    .phrase-item .p-title{
      font-size:1rem;
      font-weight:700;
      color:#143b48;
      margin-bottom:3px;
      padding-right:26px; /* leave space for star */
    }
    .phrase-item .p-meaning{
      font-size:.85rem;
      color:#4f5f6f;
      padding-right:26px;
    }

    /* star button in list */
    .star-btn{
      position:absolute;
      top:8px; right:8px;
      border:none;
      background:transparent;
      cursor:pointer;
      font-size:1.1rem;
      line-height:1;
      transition:.12s ease;
    }
    .star-btn:hover{ transform:scale(1.08); }
    .star-on{ color:#f6b73c; text-shadow:0 2px 6px rgba(246,183,60,.4); }
    .star-off{ color:#c8d2dd; }

    /* detail card */
    .detail-area{ margin-top:12px; }
    .detail-card{
      background:#ffffff;
      border:1px solid #e9eff5;
      border-radius:12px;
      padding:12px;
      box-shadow:0 4px 10px rgba(31,45,61,0.06);
      border-left:5px solid #2f80ed;
      animation:fadeIn .18s ease;
    }
    @keyframes fadeIn{
      from{opacity:0; transform:translateY(4px);}
      to{opacity:1; transform:translateY(0);}
    }
    .detail-header{
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:8px;
      gap:8px;
    }
    .detail-header h3{
      font-size:1.15rem;
      color:#0f2e3a;
      display:flex; align-items:center; gap:6px; flex-wrap:wrap;
    }
    .badge{
      font-size:.75rem;
      padding:3px 8px;
      border-radius:999px;
      background:#e8f4ff;
      color:#2f80ed;
      font-weight:700;
      white-space:nowrap;
    }

    .examples{
      display:grid;
      gap:8px;
      margin-top:6px;
    }
    .example{
      background:#f8fbfd;
      border:1px dashed #dfe8f0;
      padding:8px;
      border-radius:8px;
      font-size:.92rem;
      line-height:1.55;
    }
    .example b{ color:#1f4b57; }

    .tts-btn{
      border:none;
      background:transparent;
      cursor:pointer;
      font-size:1rem;
      margin-left:2px;
    }

    .muted{
      color:#8393a3;
      font-size:.9rem;
      text-align:center;
      padding:18px 6px;
    }

    @media (max-width: 640px){
      .phrase-list{ grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Shirley's Phrases Study Platform</h1>
      <p class="description">ä¾é¦–å­—æ¯ç´¢å¼•å­¸ç¿’ç‰‡èªï¼šå…ˆçœ‹ç‰‡èªï¼‹ä¸­æ–‡é‡‹ç¾©ï¼Œé»æ“Šå†å±•é–‹ä¾‹å¥ï¼ˆå¯æ”¶è—ğŸŒŸï¼‰</p>
    </header>

    <div class="content-area">
      <div class="toolbar">
        <div class="search">
          ğŸ” <input id="searchInput" type="text" placeholder="å¯è¼¸å…¥ç‰‡èªæˆ–ä¸­æ–‡æ„æ€æœå°‹ï¼ˆåœ¨ç›®å‰å­—æ¯/æ”¶è—ç¯„åœå…§ï¼‰">
        </div>

        <button class="fav-toggle" id="favToggle" title="åªé¡¯ç¤ºå·²æ”¶è—çš„ç‰‡èª">
          ğŸŒŸ åªçœ‹æ”¶è—
        </button>

        <div class="count" id="countInfo">Loading...</div>
      </div>

      <div class="az-bar" id="azBar"></div>

      <div id="listArea" class="phrase-list">
        <div class="muted">è¼‰å…¥ä¸­...</div>
      </div>

      <div class="detail-area" id="detailArea"></div>
    </div>
  </div>

<script>
  // âœ… ä¿®æ­£ï¼šä¸è¦å°¾å·´æ–œç·š
  const CSV_URL = "https://ducj-creator.github.io/Shirley-Grammar/phrases.csv";

  // æ”¶è— localStorage key
  const FAV_KEY = "phrases_favs_v1";

  let phrases = [];
  let grouped = {};
  let currentLetter = "A";
  let currentList = [];     // current letter full list
  let viewList = [];        // after fav-filter & search
  let favorites = new Set();
  let onlyFav = false;

  document.addEventListener("DOMContentLoaded", async () => {
    loadFavorites();
    bindFavToggle();

    await loadCSV();
    buildAZBar();
    showLetter("A");
    bindSearch();
  });

  /* ----------------- Favorites ----------------- */
  function loadFavorites(){
    try{
      const raw = localStorage.getItem(FAV_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      favorites = new Set(arr.filter(Boolean));
    }catch(e){
      favorites = new Set();
    }
  }

  function saveFavorites(){
    localStorage.setItem(FAV_KEY, JSON.stringify([...favorites]));
  }

  function isFav(phrase){
    return favorites.has(phrase);
  }

  function toggleFav(phrase){
    if(isFav(phrase)) favorites.delete(phrase);
    else favorites.add(phrase);
    saveFavorites();
  }

  function bindFavToggle(){
    const btn = document.getElementById("favToggle");
    btn.addEventListener("click", ()=>{
      onlyFav = !onlyFav;
      btn.classList.toggle("active", onlyFav);
      btn.textContent = onlyFav ? "ğŸŒŸ åªçœ‹æ”¶è—ï¼ˆé–‹ï¼‰" : "ğŸŒŸ åªçœ‹æ”¶è—";
      applyFiltersAndRender(); // re-render current letter
    });
  }

  /* ----------------- Load & Parse CSV ----------------- */
  async function loadCSV(){
    try{
      const res = await fetch(CSV_URL);
      if(!res.ok) throw new Error("CSV ä¸‹è¼‰å¤±æ•—");
      const text = await res.text();
      phrases = parseCSV(text);

      grouped = groupByFirstLetter(phrases);
      updateCount();
    }catch(err){
      console.error(err);
      document.getElementById("listArea").innerHTML =
        `<div class="muted" style="color:#c0392b;">CSV è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²å€å¯é€£ç·š</div>`;
      document.getElementById("countInfo").textContent = "0 phrases";
    }
  }

  function parseCSV(csvText){
    const rows = csvText.trim().split(/\r?\n/).filter(Boolean);
    if(!rows.length) return [];

    const rawHeaders = splitCSVLine(rows[0]);
    const headers = rawHeaders.map(h => normalizeHeader(h));

    const data = [];
    for(let i=1;i<rows.length;i++){
      const cols = splitCSVLine(rows[i]);
      const obj = {};
      headers.forEach((h,idx)=>obj[h]=(cols[idx]??"").trim());

      const phrase = obj.phrases || obj.phrase || "";
      const meaning = obj.meaning || "";
      const en = obj.english_sentence || obj.english || obj.en_sentence || "";
      const zh = obj.chinese_sentence || obj.chinese || obj.zh_sentence || "";

      if(phrase){
        data.push({
          phrase,
          meaning,
          en_sentence: en,
          zh_sentence: zh
        });
      }
    }
    return data;
  }

  function normalizeHeader(h){
    const s = h.trim().toLowerCase();
    if(s.includes("phrases") || s.includes("phrase")) return "phrases";
    if(s.includes("meaning") || s.includes("ä¸­æ–‡") || s.includes("è§£é‡‹")) return "meaning";
    if(s.includes("english")) return "english_sentence";
    if(s.includes("chinese")) return "chinese_sentence";
    return s.replace(/\s+/g,"_");
  }

  function splitCSVLine(line){
    const result=[]; let cur=""; let inQuotes=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch === '"'){
        if(inQuotes && line[i+1] === '"'){ cur+='"'; i++; }
        else inQuotes=!inQuotes;
      }else if(ch===',' && !inQuotes){
        result.push(cur); cur="";
      }else cur+=ch;
    }
    result.push(cur);
    return result;
  }

  /* ----------------- Grouping & A-Z ----------------- */
  function groupByFirstLetter(items){
    const map={};
    items.forEach(p=>{
      const first = (p.phrase[0]||"").toUpperCase();
      const letter = first.match(/[A-Z]/) ? first : "#";
      if(!map[letter]) map[letter]=[];
      map[letter].push(p);
    });
    Object.keys(map).forEach(k=>{
      map[k].sort((a,b)=>a.phrase.localeCompare(b.phrase));
    });
    return map;
  }

  function buildAZBar(){
    const azBar = document.getElementById("azBar");
    azBar.innerHTML="";

    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
    letters.forEach(L=>{
      const btn=document.createElement("button");
      btn.className="az-btn";
      btn.textContent=L;
      btn.onclick=()=>showLetter(L);
      azBar.appendChild(btn);
    });

    const hashBtn=document.createElement("button");
    hashBtn.className="az-btn";
    hashBtn.textContent="#";
    hashBtn.title="é A-Z é–‹é ­";
    hashBtn.onclick=()=>showLetter("#");
    azBar.appendChild(hashBtn);
  }

  function setActiveLetterBtn(letter){
    document.querySelectorAll(".az-btn").forEach(b=>{
      b.classList.toggle("active", b.textContent===letter);
    });
  }

  function showLetter(letter){
    currentLetter = letter;
    setActiveLetterBtn(letter);
    document.getElementById("detailArea").innerHTML="";

    currentList = grouped[letter] || [];
    document.getElementById("searchInput").value = "";

    applyFiltersAndRender();
  }

  /* ----------------- Render list & detail ----------------- */
  function applyFiltersAndRender(){
    const q = (document.getElementById("searchInput").value || "").trim().toLowerCase();

    // 1) fav filter
    let list = onlyFav ? currentList.filter(p => isFav(p.phrase)) : [...currentList];

    // 2) search filter (within list)
    if(q){
      list = list.filter(p =>
        (p.phrase||"").toLowerCase().includes(q) ||
        (p.meaning||"").toLowerCase().includes(q)
      );
    }

    viewList = list;
    renderList(viewList);
    updateCount(viewList.length);
  }

  function renderList(list){
    const listArea = document.getElementById("listArea");
    if(!list.length){
      listArea.innerHTML=`<div class="muted">æ­¤å­—æ¯ç›®å‰æ²’æœ‰ç‰‡èªã€‚</div>`;
      return;
    }
    listArea.innerHTML="";

    list.forEach(p=>{
      const item=document.createElement("div");
      item.className="phrase-item";
      item.innerHTML=`
        <button class="star-btn ${isFav(p.phrase) ? "star-on" : "star-off"}"
                title="${isFav(p.phrase) ? "å–æ¶ˆæ”¶è—" : "åŠ å…¥æ”¶è—"}">ğŸŒŸ</button>

        <div class="p-title">${escapeHTML(p.phrase)}</div>
        <div class="p-meaning">${escapeHTML(p.meaning||"")}</div>
      `;

      // é»æ•´æ ¼çœ‹ detail
      item.onclick=()=>showDetail(p);

      // é»æ˜Ÿæ˜Ÿä¸è¦è§¸ç™¼ detailï¼ˆstopPropagationï¼‰
      const starBtn = item.querySelector(".star-btn");
      starBtn.onclick=(e)=>{
        e.stopPropagation();
        toggleFav(p.phrase);
        applyFiltersAndRender();
        // è‹¥ detail æ˜¯åŒä¸€ç­†ï¼Œä¹Ÿæ›´æ–° detail æ˜Ÿæ˜Ÿ
        const curDetail = document.getElementById("detailArea");
        if(curDetail.dataset.phrase === p.phrase){
          showDetail(p);
        }
      };

      listArea.appendChild(item);
    });
  }

  function showDetail(p){
    const detailArea=document.getElementById("detailArea");
    detailArea.dataset.phrase = p.phrase;

    detailArea.innerHTML=`
      <div class="detail-card">
        <div class="detail-header">
          <h3>
            ${escapeHTML(p.phrase)}
            <button class="tts-btn" data-text="${escapeAttr(p.phrase)}" title="æœ—è®€ç‰‡èª">ğŸ”Š</button>
            <button class="star-btn ${isFav(p.phrase) ? "star-on" : "star-off"}"
                    data-phrase="${escapeAttr(p.phrase)}"
                    title="${isFav(p.phrase) ? "å–æ¶ˆæ”¶è—" : "åŠ å…¥æ”¶è—"}">ğŸŒŸ</button>
          </h3>
          <span class="badge">${currentLetter}</span>
        </div>

        <div style="font-size:.98rem;color:#2c3e50;">
          <b>ä¸­æ–‡æ„æ€ï¼š</b>${escapeHTML(p.meaning||"")}
        </div>

        <div class="examples">
          ${
            p.en_sentence
              ? `<div class="example">
                   <b>English Sentenceï¼š</b><br/>
                   ${escapeHTML(p.en_sentence)}
                   <button class="tts-btn" data-text="${escapeAttr(p.en_sentence)}" title="æœ—è®€è‹±æ–‡ä¾‹å¥">ğŸ”Š</button>
                 </div>`
              : `<div class="example"><b>English Sentenceï¼š</b>ï¼ˆæ­¤ç‰‡èªç„¡ä¾‹å¥ï¼‰</div>`
          }
          ${
            p.zh_sentence
              ? `<div class="example">
                   <b>Chinese Sentenceï¼š</b><br/>
                   ${escapeHTML(p.zh_sentence)}
                 </div>`
              : `<div class="example"><b>Chinese Sentenceï¼š</b>ï¼ˆæ­¤ç‰‡èªç„¡ä¾‹å¥ï¼‰</div>`
          }
        </div>
      </div>
    `;

    // ç™¼éŸ³
    detailArea.querySelectorAll(".tts-btn").forEach(btn=>{
      btn.onclick=()=>playAudio(btn.dataset.text);
    });

    // detail æ˜Ÿæ˜Ÿ
    detailArea.querySelectorAll(".star-btn").forEach(btn=>{
      btn.onclick=()=>{
        const phrase = btn.dataset.phrase;
        toggleFav(phrase);
        applyFiltersAndRender();
        showDetail(p);
      };
    });

    detailArea.scrollIntoView({behavior:"smooth", block:"start"});
  }

  /* ----------------- Search (within current letter) ----------------- */
  function bindSearch(){
    const input=document.getElementById("searchInput");
    input.addEventListener("input", applyFiltersAndRender);
  }

  function updateCount(overrideCount=null){
    const total = phrases.length;
    const groupCount = overrideCount!==null ? overrideCount : (currentList?.length||0);
    const suffix = onlyFav ? "ï¼ˆæ”¶è—ç¯„åœï¼‰" : "";
    document.getElementById("countInfo").textContent =
      `${groupCount} / ${total} phrases ${suffix}`;
  }

  /* ----------------- TTS ----------------- */
  function playAudio(text){
    if(!text) return;
    if("speechSynthesis" in window){
      window.speechSynthesis.cancel();
      const u=new SpeechSynthesisUtterance(text);
      u.lang="en-US";
      u.rate=0.9;
      window.speechSynthesis.speak(u);
    }else{
      alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒèªéŸ³åˆæˆåŠŸèƒ½");
    }
  }

  /* ----------------- helpers ----------------- */
  function escapeHTML(s){
    return String(s).replace(/[&<>"']/g, m =>
      ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
    );
  }
  function escapeAttr(s){
    return String(s).replace(/"/g,'&quot;');
  }
</script>
</body>
</html>

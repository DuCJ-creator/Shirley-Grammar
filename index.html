<!DOCTYPE html>
<html lang="en" id="htmlRoot">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shirley's Grammar E-Charger</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@500;600;700&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0a0a;
            --surface-glass: rgba(30, 30, 30, 0.7);
            --gold: #FFD700;
            --copper: #B87333;
            --electric-blue: #4169E1;
            --glow-gold: 0 0 10px rgba(255, 215, 0, 0.6);
            --glow-blue: 0 0 10px rgba(65, 105, 225, 0.8);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            color: #f0f0f0;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* ✨ 粒子特效 Canvas */
        #particle-canvas {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        /* 導航欄 */
        header {
            width: 100%;
            padding: 1.5rem 2.5rem;
            max-width: 1200px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .back-btn {
            text-decoration: none;
            color: #fff;
            font-size: 0.95rem;
            font-weight: 500;
            padding: 0.6rem 1.2rem;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 99px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .back-btn:hover {
            background: var(--gold);
            color: #000;
            border-color: var(--gold);
            box-shadow: var(--glow-gold);
        }

        #station-container {
            text-align: center;
            z-index: 1;
            width: 100%;
            max-width: 900px;
            margin-bottom: 220px; /* 為機器人留空間 */
            padding-top: 20px;
        }

        h1 {
            font-family: 'Cormorant Garamond', serif;
            color: var(--gold);
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
            font-size: 3em;
            font-weight: 700;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        p {
            color: #ccc;
            font-size: 1.1rem;
            margin-bottom: 30px;
            font-weight: 300;
        }

        /* SVG 樣式優化 */
        #station-svg {
            /* 移除原本的方框背景，改用透明或玻璃感 */
            background: transparent;
            width: 100%;
            height: auto;
            filter: drop-shadow(0 0 20px rgba(0,0,0,0.5));
            overflow: visible;
        }

        /* 電纜發光特效 */
        .animated-cable {
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: extend 2s ease-in-out forwards;
            stroke: var(--electric-blue);
            stroke-width: 6;
            fill: none;
            filter: drop-shadow(0 0 5px var(--electric-blue)); /* 發光 */
        }

        .charging-wire {
            stroke: var(--copper);
            stroke-width: 3;
            fill: none;
            stroke-dasharray: 10 5;
            animation: flowWire 1s linear infinite;
            filter: drop-shadow(0 0 3px var(--copper));
        }

        .pillar-wire {
            stroke: var(--gold);
            stroke-width: 4;
            fill: none;
            stroke-dasharray: 10 5;
            animation: flowWire 0.5s linear infinite;
            filter: drop-shadow(0 0 5px var(--gold));
        }

        @keyframes flowWire {
            from { stroke-dashoffset: 0; }
            to { stroke-dashoffset: -30; }
        }

        @keyframes extend {
            from { stroke-dashoffset: 1000; }
            to { stroke-dashoffset: 0; }
        }

        /* 端口與按鈕互動 */
        .port {
            cursor: pointer;
            stroke: #808080;
            stroke-width: 2;
            transition: all 0.3s ease;
            fill: #333;
        }
        .port:hover {
            transform: scale(1.3);
            stroke: var(--gold);
            fill: var(--gold);
            filter: drop-shadow(0 0 8px var(--gold));
        }

        .port-label {
            font-size: 13px;
            fill: #fff;
            text-anchor: middle;
            pointer-events: none;
            text-shadow: 0 2px 4px rgba(0,0,0,0.9);
            font-weight: 500;
            font-family: 'Inter', sans-serif;
        }

        .pillar-block {
            fill: #444;
            stroke: var(--copper);
            stroke-width: 2;
            rx: 8;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .pillar-block:hover {
            stroke: var(--gold);
            fill: #555;
            filter: drop-shadow(0 0 10px var(--gold));
        }

        .pillar-label {
            font-weight: 600;
            fill: #fff;
            text-anchor: middle;
            text-shadow: 0 2px 4px rgba(0,0,0,1);
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }
        .pillar-label:hover {
            fill: var(--gold);
            font-size: 17px;
        }

        .red-button {
            fill: #d32f2f;
            stroke: #b71c1c;
            stroke-width: 2;
            rx: 8;
            cursor: pointer;
            transition: all 0.3s ease;
            filter: drop-shadow(0 0 5px rgba(211, 47, 47, 0.5));
        }
        .red-button:hover {
            fill: #f44336;
            stroke: var(--gold);
            filter: drop-shadow(0 0 10px #f44336);
        }
        
        .red-button-text {
            fill: white;
            font-weight: 600;
            text-anchor: middle;
            font-size: 13px;
            pointer-events: none;
            font-family: 'Inter', sans-serif;
        }

        .electricity-box {
            fill: #222;
            stroke: var(--copper);
            stroke-width: 3;
            rx: 8;
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.5));
        }

        /* Modal (Glassmorphism) */
        #modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }
        
        #modal-content {
            background: rgba(20, 20, 20, 0.85);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            margin: auto;
            padding: 40px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            width: 85%;
            max-width: 650px;
            border-radius: 20px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5), 0 0 20px rgba(255, 215, 0, 0.1);
            color: #fff;
            position: relative;
        }
        
        #close {
            color: #aaa;
            position: absolute;
            top: 20px;
            right: 25px;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }
        #close:hover {
            color: var(--gold);
        }
        
        .explanation-title {
            color: var(--gold);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 15px;
            font-size: 28px;
            font-family: 'Cormorant Garamond', serif;
            margin-top: 0;
        }
        
        .explanation-text {
            line-height: 1.8;
            color: #ddd;
            font-size: 1.05rem;
            margin-top: 20px;
        }

        /* Robots Container */
        .robots-container {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 1000px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            padding: 0 40px 20px;
            z-index: 10;
            pointer-events: none;
        }

        .robot-with-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: auto;
            transition: transform 0.3s;
        }
        .robot-with-card:hover {
            transform: translateY(-5px);
        }

        .grammar-card {
            width: 110px;
            height: 140px;
            cursor: pointer;
            transition: all 0.4s ease;
            border: 2px solid var(--copper);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.4);
            overflow: hidden;
            margin-bottom: 10px;
        }
        .grammar-card:hover {
            transform: scale(1.1) rotate(2deg);
            border-color: var(--gold);
            box-shadow: 0 0 20px var(--glow-gold);
        }

        .card-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* 機器人 SVG 樣式 */
        .robot {
            width: 100px;
            height: 140px;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5));
        }
        .robot-body { fill: #2a2a2a; stroke: #4169E1; stroke-width: 2; }
        .robot-head { fill: #333; stroke: #FF69B4; stroke-width: 2; }
        .robot-leg { fill: #444; stroke: #32CD32; stroke-width: 1; animation: legSwing 2s ease-in-out infinite alternate; }
        .robot-leg.left { animation-delay: -1s; }
        .robot-antenna { stroke: var(--gold); stroke-width: 3; stroke-linecap: round; }
        .robot-eye { fill: var(--electric-blue); filter: drop-shadow(0 0 2px var(--electric-blue)); }
        .robot-mouth { fill: none; stroke: #FF69B4; stroke-width: 2; }

        @keyframes legSwing {
            0% { transform: rotate(5deg); }
            100% { transform: rotate(-5deg); }
        }

        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(65, 105, 225, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 3000;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(4px);
        }

        @media (max-width: 768px) {
            h1 { font-size: 2em; }
            #station-container { margin-bottom: 180px; }
            .robots-container { padding: 0 10px 10px; }
            .robot { width: 70px; height: 100px; }
            .grammar-card { width: 80px; height: 100px; }
        }
    </style>
</head>
<body>

    <canvas id="particle-canvas"></canvas>

    <header>
        <a href="https://ducj-creator.github.io/Teacher-Shirley/study-tools/index.html" class="back-btn">
            <span>←</span> Back to Study Tools
        </a>
    </header>

    <div id="station-container">
        <h1>Shirley's Grammar E-Charger</h1>
        <p>Click on the pillar levels or charging ports to power up your grammar knowledge!</p>
        
        <svg id="station-svg" width="800" height="600" viewBox="0 0 800 600" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <linearGradient id="groundGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#B87333;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#5c3a1a;stop-opacity:1" />
                </linearGradient>
            </defs>
            <rect x="50" y="550" width="700" height="20" fill="url(#groundGrad)" rx="10" filter="drop-shadow(0 0 10px #B87333)" />
            
            <rect x="390" y="100" width="20" height="450" fill="#333" stroke="#555" stroke-width="2" />
            <path d="M 395 100 L 395 550" class="animated-cable" style="stroke-width: 4; stroke: #4169E1; opacity: 0.8;" />
            
            <g id="pillar-blocks">
                <rect x="370" y="120" width="60" height="60" class="pillar-block" onclick="handlePillarClick('simple')" />
                <line x1="400" y1="180" x2="400" y2="200" class="pillar-wire" />
                
                <rect x="370" y="200" width="60" height="60" class="pillar-block" onclick="handlePillarClick('compound')" />
                <line x1="400" y1="260" x2="400" y2="280" class="pillar-wire" />
                
                <rect x="370" y="280" width="60" height="60" class="pillar-block" onclick="handlePillarClick('complex')" />
                <line x1="400" y1="340" x2="400" y2="360" class="pillar-wire" />
                
                <rect x="370" y="360" width="60" height="60" class="pillar-block" onclick="handlePillarClick('compound-complex')" />
            </g>
            
            <text x="400" y="155" class="pillar-label" onclick="handlePillarClick('simple')">1. Simple</text>
            <text x="400" y="235" class="pillar-label" onclick="handlePillarClick('compound')">2. Compound</text>
            <text x="400" y="315" class="pillar-label" onclick="handlePillarClick('complex')">3. Complex</text>
            <text x="400" y="395" class="pillar-label" onclick="handlePillarClick('compound-complex')">4. Compound-Complex</text>
            
            <rect x="300" y="50" width="200" height="50" fill="#222" rx="8" stroke="#FFD700" stroke-width="2" filter="drop-shadow(0 0 8px #FFD700)" />
            <text x="400" y="82" fill="#FFD700" text-anchor="middle" font-weight="bold" font-size="18" font-family="Cormorant Garamond">Sentence Structures</text>
            
            <path d="M 400 130 Q 300 100 200 130" class="animated-cable" />
            <rect x="160" y="80" width="80" height="100" class="electricity-box" />
            
            <rect x="160" y="130" width="80" height="40" class="red-button" onclick="handleSectionClick('parts-of-speech')" />
            <text x="200" y="148" class="red-button-text">I. Parts of</text>
            <text x="200" y="163" class="red-button-text">Speech</text>
            
            <g id="section1-ports">
                <line x1="80" y1="60" x2="200" y2="130" class="charging-wire" />
                <circle cx="80" cy="60" r="14" class="port" onclick="handlePortClick('nouns')" />
                <text x="80" y="65" class="port-label" pointer-events="none">Nouns</text>
                
                <line x1="120" y1="200" x2="200" y2="130" class="charging-wire" />
                <circle cx="120" cy="200" r="14" class="port" onclick="handlePortClick('pronouns')" />
                <text x="120" y="205" class="port-label" pointer-events="none">Pronouns</text>
                
                <line x1="40" y1="120" x2="200" y2="130" class="charging-wire" />
                <circle cx="40" cy="120" r="14" class="port" onclick="handlePortClick('adjectives-adverbs')" />
                <text x="40" y="100" class="port-label" pointer-events="none">Adj &amp; Adv</text>
                
                <line x1="140" y1="30" x2="200" y2="130" class="charging-wire" />
                <circle cx="140" cy="30" r="14" class="port" onclick="handlePortClick('verbs')" />
                <text x="140" y="35" class="port-label" pointer-events="none">Verbs</text>
                
                <line x1="100" y1="220" x2="200" y2="130" class="charging-wire" />
                <circle cx="100" cy="220" r="14" class="port" onclick="handlePortClick('prepositions')" />
                <text x="100" y="245" class="port-label" pointer-events="none">Prepositions</text>
            </g>
            
            <path d="M 400 350 Q 300 380 200 350" class="animated-cable" />
            <rect x="160" y="300" width="80" height="100" class="electricity-box" />
            
            <rect x="160" y="350" width="80" height="40" class="red-button" onclick="handleSectionClick('nonfinite-verbs')" />
            <text x="200" y="368" class="red-button-text">II. Non-finite</text>
            <text x="200" y="383" class="red-button-text">Verbs</text>
            
            <g id="section2-ports">
                <line x1="80" y1="280" x2="200" y2="350" class="charging-wire" />
                <circle cx="80" cy="280" r="14" class="port" onclick="handlePortClick('infinitive')" />
                <text x="80" y="260" class="port-label" pointer-events="none">Infinitive</text>
                
                <line x1="120" y1="420" x2="200" y2="350" class="charging-wire" />
                <circle cx="120" cy="420" r="14" class="port" onclick="handlePortClick('gerund')" />
                <text x="120" y="445" class="port-label" pointer-events="none">Gerund</text>
                
                <line x1="40" y1="340" x2="200" y2="350" class="charging-wire" />
                <circle cx="40" cy="340" r="14" class="port" onclick="handlePortClick('present-participle')" />
                <text x="40" y="365" class="port-label" pointer-events="none">Present Part.</text>
                
                <line x1="140" y1="270" x2="200" y2="350" class="charging-wire" />
                <circle cx="140" cy="270" r="14" class="port" onclick="handlePortClick('past-participle')" />
                <text x="140" y="250" class="port-label" pointer-events="none">Past Part.</text>
            </g>
            
            <path d="M 400 130 Q 500 100 600 130" class="animated-cable" />
            <rect x="560" y="80" width="80" height="100" class="electricity-box" />
            
            <rect x="560" y="130" width="80" height="40" class="red-button" onclick="handleSectionClick('clauses')" />
            <text x="600" y="155" class="red-button-text">III. Clauses</text>
            
            <g id="section3-ports">
                <line x1="680" y1="60" x2="600" y2="130" class="charging-wire" />
                <circle cx="680" cy="60" r="14" class="port" onclick="handlePortClick('noun-clause')" />
                <text x="680" y="85" class="port-label" pointer-events="none">Noun Clause</text>
                
                <line x1="640" y1="200" x2="600" y2="130" class="charging-wire" />
                <circle cx="640" cy="200" r="14" class="port" onclick="handlePortClick('adjective-clause')" />
                <text x="640" y="225" class="port-label" pointer-events="none">Adj. Clause</text>
                
                <line x1="720" y1="120" x2="600" y2="130" class="charging-wire" />
                <circle cx="720" cy="120" r="14" class="port" onclick="handlePortClick('adverb-clause')" />
                <text x="720" y="145" class="port-label" pointer-events="none">Adv. Clause</text>
            </g>
            
            <path d="M 400 350 Q 500 380 600 350" class="animated-cable" />
            <rect x="560" y="300" width="80" height="100" class="electricity-box" />
            
            <rect x="560" y="350" width="80" height="40" class="red-button" onclick="handleSectionClick('special-sentences')" />
            <text x="600" y="368" class="red-button-text">IV. Special</text>
            <text x="600" y="383" class="red-button-text">Sentences</text>
            
            <g id="section4-ports">
                <line x1="680" y1="280" x2="600" y2="350" class="charging-wire" />
                <circle cx="680" cy="280" r="14" class="port" onclick="handlePortClick('questions')" />
                <text x="680" y="305" class="port-label" pointer-events="none">Questions</text>
                
                <line x1="640" y1="420" x2="600" y2="350" class="charging-wire" />
                <circle cx="640" cy="420" r="14" class="port" onclick="handlePortClick('exclamations')" />
                <text x="640" y="445" class="port-label" pointer-events="none">Exclamations</text>
                
                <line x1="720" y1="340" x2="600" y2="350" class="charging-wire" />
                <circle cx="720" cy="340" r="14" class="port" onclick="handlePortClick('inverted')" />
                <text x="720" y="365" class="port-label" pointer-events="none">Inverted</text>
                
                <line x1="600" y1="270" x2="600" y2="350" class="charging-wire" />
                <circle cx="600" cy="270" r="14" class="port" onclick="handlePortClick('subjunctive')" />
                <text x="600" y="250" class="port-label" pointer-events="none">Subjunctive</text>
            </g>
        </svg>
    </div>

    <div class="robots-container">
        <div class="robot-with-card left-robot">
            <div class="grammar-card" onclick="showCardInfo('sentence-structure')">
                <img src="https://ducj-creator.github.io/Shirley-Grammar/assets/sentence%20structure.png" 
                     alt="Sentence Structure" class="card-image">
            </div>
            <svg class="robot" viewBox="0 0 200 300" xmlns="http://www.w3.org/2000/svg">
                <rect x="50" y="90" width="100" height="80" rx="15" class="robot-body" />
                <circle cx="100" cy="60" r="25" class="robot-head" />
                <line x1="100" y1="35" x2="100" y2="15" class="robot-antenna" />
                <circle cx="100" cy="15" r="4" fill="#FFD700" />
                <circle cx="92" cy="55" r="4" class="robot-eye" />
                <circle cx="108" cy="55" r="4" class="robot-eye" />
                <path d="M 90 70 Q 100 80 110 70" class="robot-mouth" />
                <rect x="70" y="175" width="12" height="25" rx="4" class="robot-leg left" />
                <rect x="118" y="175" width="12" height="25" rx="4" class="robot-leg" />
            </svg>
        </div>

        <div class="robot-with-card right-robot">
            <div class="grammar-card" onclick="showCardInfo('grammar-concepts')">
                <img src="https://ducj-creator.github.io/Shirley-Grammar/assets/key%20grammar%20concepts.png" 
                     alt="Key Grammar Concepts" class="card-image">
            </div>
            <svg class="robot" viewBox="0 0 200 300" xmlns="http://www.w3.org/2000/svg">
                <rect x="50" y="90" width="100" height="80" rx="15" class="robot-body" />
                <circle cx="100" cy="60" r="25" class="robot-head" />
                <line x1="100" y1="35" x2="100" y2="15" class="robot-antenna" />
                <circle cx="100" cy="15" r="4" fill="#FFD700" />
                <circle cx="92" cy="55" r="4" class="robot-eye" />
                <circle cx="108" cy="55" r="4" class="robot-eye" />
                <path d="M 90 70 Q 100 80 110 70" class="robot-mouth" />
                <rect x="70" y="175" width="12" height="25" rx="4" class="robot-leg left" />
                <rect x="118" y="175" width="12" height="25" rx="4" class="robot-leg" />
            </svg>
        </div>
    </div>

    <div id="modal">
        <div id="modal-content">
            <span id="close">&times;</span>
            <h2 id="modal-title" class="explanation-title"></h2>
            <p id="modal-text" class="explanation-text"></p>
        </div>
    </div>

    <div id="status-message" class="status-message" style="display: none;"></div>

    <script>
        // ----------------------------------------
        // ✨ 能量粒子特效 (Energy Particles)
        // ----------------------------------------
        const canvas = document.getElementById('particle-canvas');
        const ctx = canvas.getContext('2d');
        let particlesArray;

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', () => {
            resizeCanvas();
            initParticles();
        });

        const mouse = { x: null, y: null, radius: 150 };
        window.addEventListener('mousemove', (event) => {
            mouse.x = event.x;
            mouse.y = event.y;
        });

        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 2 + 0.5;
                this.speedX = (Math.random() * 1 - 0.5);
                this.speedY = (Math.random() * 1 - 0.5);
                // 粒子顏色：金色與電光藍
                this.color = Math.random() > 0.6 ? 'rgba(255, 215, 0, 0.6)' : 'rgba(65, 105, 225, 0.6)';
            }
            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                if (this.x > canvas.width || this.x < 0) this.speedX = -this.speedX;
                if (this.y > canvas.height || this.y < 0) this.speedY = -this.speedY;

                let dx = mouse.x - this.x;
                let dy = mouse.y - this.y;
                let distance = Math.sqrt(dx*dx + dy*dy);
                if (distance < mouse.radius) {
                    if(mouse.x < this.x && this.x < canvas.width - 10) this.x += 1;
                    if(mouse.x > this.x && this.x > 10) this.x -= 1;
                    if(mouse.y < this.y && this.y < canvas.height - 10) this.y += 1;
                    if(mouse.y > this.y && this.y > 10) this.y -= 1;
                }
            }
            draw() {
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function initParticles() {
            particlesArray = [];
            let numberOfParticles = (canvas.width * canvas.height) / 10000;
            for (let i = 0; i < numberOfParticles; i++) {
                particlesArray.push(new Particle());
            }
        }

        function animateParticles() {
            requestAnimationFrame(animateParticles);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            for (let i = 0; i < particlesArray.length; i++) {
                particlesArray[i].update();
                particlesArray[i].draw();
                
                // 粒子連線 (微弱的電流感)
                for (let j = i; j < particlesArray.length; j++) {
                    let dx = particlesArray[i].x - particlesArray[j].x;
                    let dy = particlesArray[i].y - particlesArray[j].y;
                    let distance = Math.sqrt(dx*dx + dy*dy);
                    if (distance < 100) {
                        ctx.beginPath();
                        ctx.strokeStyle = 'rgba(255, 215, 0, 0.1)';
                        ctx.lineWidth = 0.5;
                        ctx.moveTo(particlesArray[i].x, particlesArray[i].y);
                        ctx.lineTo(particlesArray[j].x, particlesArray[j].y);
                        ctx.stroke();
                    }
                }
            }
        }
        initParticles();
        animateParticles();


        // ----------------------------------------
        // 原始業務邏輯 (CSV, Modal, Clicks)
        // ----------------------------------------
        const grammarCSV = `no.,key point,url
S-1,simple,https://ducj-creator.github.io/Shirley-Grammar/simple/
S-2,compound,https://ducj-creator.github.io/Shirley-Grammar/compound/
S-3,complex,https://ducj-creator.github.io/Shirley-Grammar/complex/
S-4,compound-complex,https://ducj-creator.github.io/Shirley-Grammar/compound-complex/
P-1,nouns,https://ducj-creator.github.io/Shirley-Grammar/nouns/
P-2,pronouns,https://ducj-creator.github.io/Shirley-Grammar/pronouns/
P-3,adjectives-adverbs,https://ducj-creator.github.io/Shirley-Grammar/adjectives-adverbs/
P-4,verbs,https://ducj-creator.github.io/Shirley-Grammar/verbs/
P-5,prepositions,https://ducj-creator.github.io/Shirley-Grammar/prepositions/
V-1,infinitive,https://ducj-creator.github.io/Shirley-Grammar/infinitive/
V-2,gerund,https://ducj-creator.github.io/Shirley-Grammar/gerund/
V-3,present-participle,https://ducj-creator.github.io/Shirley-Grammar/present-participle/
V-4,past-participle,https://ducj-creator.github.io/Shirley-Grammar/past-participle/
C-1,noun-clause,https://ducj-creator.github.io/Shirley-Grammar/noun-clause/
C-2,adjective-clause,https://ducj-creator.github.io/Shirley-Grammar/adjective-clause/
C-3,adverb-clause,https://ducj-creator.github.io/Shirley-Grammar/adverb-clause/
SS-1,questions,https://ducj-creator.github.io/Shirley-Grammar/questions/
SS-2,exclamations,https://ducj-creator.github.io/Shirley-Grammar/exclamations/
SS-3,inverted,https://ducj-creator.github.io/Shirley-Grammar/inverted/
SS-4,subjunctive,https://ducj-creator.github.io/Shirley-Grammar/subjunctive/`;

        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const result = {};
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                    const columns = line.split(',');
                    if (columns.length >= 3) {
                        const key = columns[1].trim();
                        const url = columns[2].trim();
                        if (key && url) {
                            result[key] = url;
                        }
                    }
                }
            }
            return result;
        }

        let grammarLinks = {};
        try {
            grammarLinks = parseCSV(grammarCSV);
        } catch (error) {
            console.error('Error loading grammar links:', error);
        }

        function showStatus(message, duration = 2000) {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.style.display = 'block';
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, duration);
        }

        let isProcessingClick = false;
        function safeOpenLink(url, key) {
            if (isProcessingClick) return;
            isProcessingClick = true;
            showStatus(`Connecting to ${key}...`);
            setTimeout(() => {
                window.open(url, '_blank');
                isProcessingClick = false;
            }, 500);
        }

        function handlePillarClick(key) {
            const lowerKey = key.toLowerCase();
            if (grammarLinks[lowerKey]) {
                safeOpenLink(grammarLinks[lowerKey], key);
            } else {
                showStatus(`No link found for ${key}`);
            }
        }

        function handlePortClick(key) {
            const lowerKey = key.toLowerCase();
            if (grammarLinks[lowerKey]) {
                safeOpenLink(grammarLinks[lowerKey], key);
            } else {
                showStatus(`No link found for ${key}`);
            }
        }

        const sectionExplanations = {
            'parts-of-speech': {
                title: "I. Parts of Speech 詞性",
                text: "The eight parts of speech are the basic categories of words in English grammar: nouns, pronouns, verbs, adjectives, adverbs, prepositions, conjunctions, and interjections. Here, we will mainly focus on the first six. (The FANBOYS conjunctions are explained in 'Compound Sentences,' and interjections like 'Wow,' 'Oh,' 'Hey,' 'Oops,' and 'Ouch' are limited in number.)<br><br>英語的八大詞類是詞彙在文法上的基本類別：名詞、代名詞、動詞、形容詞、副詞、介系詞、連接詞和感嘆詞。在此，我們將主要著重於前六類。（FANBOYS 連接詞已在「複合句」中說明；感嘆詞的數量有限，如「Wow、Oh、Hey、Oops 和 Ouch」。）"
            },
            'nonfinite-verbs': {
                title: "II. Non-finite Verbs 非限定動詞",
                text: "Non-finite verbs are verb forms that do not show tense, person, or number. They function as other parts of speech (nouns, adjectives, or adverbs) within a sentence. They include the infinitive, the gerund, and the participles (present and past).<br><br>非限定動詞 (Non-finite Verbs) 是指不顯示時態、人稱或數量的動詞形式。它們在句中充當其他詞類（如名詞、形容詞或副詞）。它們包括不定詞 (Infinitive)、動名詞 (Gerund)，以及分詞 (Participles)（現在分詞與過去分詞）。"
            },
            'clauses': {
                title: "III. Clauses 子句",
                text: "A clause is a group of words that contains a subject and a verb. Clauses are fundamentally classified into two types based on their function: independent clauses (which can stand alone as a complete sentence) and dependent clauses (which cannot stand alone).<br>Another key method for classifying dependent clauses focuses on their grammatical role within a sentence. These functional classifications are: Nominal Clauses (or Noun Clauses)；Relative Clauses (or Adjective Clauses)；Adverbial Clauses (or Adverb Clauses)<br><br>子句的分類（Clause Classification）<br>子句 (Clause) 是一組包含一個主詞 (subject) 和一個動詞 (verb) 的詞群。子句的分類方式主要有兩種：<br>1. 依獨立性分類<br>這是最基礎的分類，將子句分為兩大類：<br>獨立子句 (Independent Clause)：能獨立存在，構成一個完整的句子。<br>從屬子句 (Dependent Clause)：不能獨立存在，必須依附於獨立子句，在句中充當某個成分。<br>2. 依功能分類<br>這種分類方式主要針對從屬子句在句中所扮演的語法角色，將其分為三類：<br>名詞子句 (Nominal Clause / Noun Clause)：在句子中起名詞的作用，可作主詞、受詞、主詞補語等。<br>形容詞子句 (Adjective Clause / Relative Clause)：又稱關係子句，在句子中起形容詞的作用，用來修飾名詞或代名詞。<br>副詞子句 (Adverbial Clause / Adverb Clause)：在句子中起副詞的作用，用來修飾動詞、形容詞或副詞，表示時間、原因、條件、讓步等。"
            },
            'special-sentences': {
                title: "IV. Special Sentences 特殊句型",
                text: "Special Sentence Structures (or Sentence Types) are categories of sentences based on their function or specific arrangement of words. They include the following forms:<br>Questions (Interrogative Sentences)<br>Exclamations (Exclamatory Sentences)<br>Inverted Sentences (Sentences with Inversion)<br>Sentences using the Subjunctive Mood<br><br>特殊句型 (Special Sentence Structures)（或稱句子類型）是根據句子功能或特定詞序排列而劃分的類別。它們包括以下形式：<br>疑問句 (Questions / Interrogative Sentences)<br>感嘆句 (Exclamations / Exclamatory Sentences)<br>倒裝句 (Inverted Sentences)<br>使用虛擬語氣的句子 (Sentences using the Subjunctive Mood)"
            }
        };

        function handleSectionClick(key) {
            showExplanation(key);
        }

        function showCardInfo(cardType) {
            if (cardType === 'sentence-structure') {
                showStatus('Viewing: Sentence Structure Diagram');
            } else if (cardType === 'grammar-concepts') {
                showStatus('Viewing: Key Grammar Concepts');
            }
        }

        // Modal
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalText = document.getElementById('modal-text');
        const close = document.getElementById('close');

        function showExplanation(key) {
            const exp = sectionExplanations[key];
            if (exp) {
                modalTitle.textContent = exp.title;
                modalText.innerHTML = exp.text;
                modal.style.display = 'flex';
            }
        }

        close.onclick = function() {
            modal.style.display = 'none';
        }
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>

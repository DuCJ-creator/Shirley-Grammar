<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Shirley's TOEIC Essential Vocab</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

  <style>
    :root {
      --primary: #6C63FF;
      --primary-light: #8A85FF;
      --secondary: #FF6584;
      --accent: #36D1DC;
      --light: #F8F9FA;
      --dark: #2f3241;
      --success: #28A745;
      --warning: #FFC107;
      --danger: #DC3545;
      --gray: #6C757D;
      --gray-light: #EEF0F6;
      --border-radius: 16px;
      --shadow: 0 8px 20px rgba(0,0,0,0.08);
      --transition: all 0.25s ease;
    }

    *{ margin:0; padding:0; box-sizing:border-box; }
    body{
      font-family:"Poppins", sans-serif;
      background:
        radial-gradient(1200px 600px at 8% -12%, #ffffff 0%, #f3f6ff 30%, transparent 60%),
        radial-gradient(900px 500px at 110% 10%, #fff0f5 0%, #f5f7fa 35%, transparent 60%),
        linear-gradient(135deg,#f6f8fb 0%,#c9d7ee 100%);
      color:var(--dark);
      min-height:100vh;
      padding:16px;
    }
    .container{ max-width:1200px; margin:0 auto; }

    header{
      background:rgba(255,255,255,0.96);
      border-radius:var(--border-radius);
      box-shadow:var(--shadow);
      padding:18px 18px;
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      position:sticky; top:10px; z-index:10;
      backdrop-filter: blur(6px);
    }
    .title-block h1{
      color:var(--primary); font-size:1.9rem; font-weight:800; letter-spacing:.3px;
    }
    .title-block p{ color:var(--gray); font-size:1rem; margin-top:2px; }

    .header-actions{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }

    .btn{
      padding:9px 14px; background:#fff; border:2px solid var(--primary);
      color:var(--primary); border-radius:999px; font-weight:700;
      cursor:pointer; transition:var(--transition); display:flex; align-items:center; gap:6px;
      box-shadow:0 2px 0 rgba(108,99,255,0.08);
      font-size:.95rem;
    }
    .btn:hover{
      background:var(--primary-light); color:#fff; transform:translateY(-2px);
      box-shadow:0 12px 22px rgba(108,99,255,0.25);
    }
    .btn.active{ background:var(--primary); color:#fff; }
    .btn.secondary{
      border-color:transparent; background:rgba(255,101,132,0.12); color:#c73b57;
    }
    .btn.secondary:hover{
      background:var(--secondary); color:#fff;
      box-shadow:0 12px 22px rgba(255,101,132,0.25);
    }

    .loading{
      text-align:center; padding:50px 0; color:var(--primary); font-size:1.1rem;
    }
    .loading i{ font-size:2rem; display:block; margin-bottom:10px; }

    /* ====== LAYER 1 Home ====== */
    #home-view{ margin-top:16px; }
    .chapters-grid{
      display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
      gap:14px;
    }
    .chapter-card{
      background:linear-gradient(145deg,#ffffff 0%, #f6f7ff 70%, #fff 100%);
      border:1px solid #eef0ff;
      border-radius:18px;
      padding:16px 16px 14px;
      box-shadow:var(--shadow);
      cursor:pointer; transition:var(--transition);
      position:relative; overflow:hidden;
      min-height:130px;
      display:flex; flex-direction:column; justify-content:space-between;
    }
    .chapter-card::after{
      content:""; position:absolute; right:-40px; top:-40px;
      width:120px; height:120px; border-radius:50%;
      background:radial-gradient(circle at center, rgba(54,209,220,0.22), transparent 65%);
    }
    .chapter-card:hover{
      transform:translateY(-4px);
      box-shadow:0 16px 32px rgba(0,0,0,0.12);
      border-color:#dfe2ff;
    }
    .chapter-card h3{
      font-size:1.05rem; line-height:1.4; color:#27293b; font-weight:700;
    }
    .chapter-card .emoji{
      font-size:1.9rem; margin-bottom:6px;
    }
    .chapter-meta{
      display:flex; justify-content:space-between; align-items:center; margin-top:8px;
      color:var(--gray); font-size:.9rem;
    }
    .chip{
      background:rgba(108,99,255,0.12); color:var(--primary);
      padding:3px 8px; border-radius:999px; font-weight:700; font-size:.82rem;
      display:inline-flex; align-items:center; gap:4px;
    }

    /* ====== LAYER 2 Category view ====== */
    #category-view{ margin-top:16px; display:none; }
    #category-view.active{ display:block; }

    .category-header{
      display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;
      margin-bottom:12px;
    }
    .category-title{
      font-size:1.45rem; font-weight:800; color:#24263a;
      display:flex; gap:8px; align-items:center;
    }

    .subchips{
      display:flex; flex-wrap:wrap; gap:8px;
      background:rgba(255,255,255,0.9); padding:10px; border-radius:14px;
      box-shadow:var(--shadow);
    }
    .subchip{
      padding:6px 10px; border-radius:999px; background:var(--gray-light);
      cursor:pointer; transition:var(--transition); font-size:.9rem; font-weight:700;
      display:flex; align-items:center; gap:6px; border:1px solid transparent;
    }
    .subchip:hover{ background:var(--primary-light); color:#fff; transform:translateY(-1px); }
    .subchip.active{ background:var(--primary); color:#fff; }

    .word-bank{
      background:#fff; border-radius:16px; box-shadow:var(--shadow);
      padding:12px; margin-bottom:12px;
    }
    .word-bank-header{
      display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;
    }
    .word-bank-title{
      font-weight:800; color:#2c2f44; display:flex; align-items:center; gap:8px;
    }
    .word-bank-count{ color:var(--gray); font-size:.95rem; }

    .word-bank-list{
      display:grid; grid-template-columns:repeat(auto-fill,minmax(170px,1fr));
      gap:8px; max-height:210px; overflow:auto; padding-right:4px;
    }
    .bank-item{
      background:#fff; border:1px solid #f0f2ff; border-radius:12px;
      padding:8px 10px; transition:var(--transition);
      display:flex; flex-direction:column; gap:2px;
      cursor:pointer;
    }
    .bank-item:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 14px rgba(0,0,0,0.06);
      border-color:#e0e4ff;
    }
    .bank-word{ font-weight:800; color:#1f2133; }
    .bank-pos{ font-size:.85rem; color:var(--gray); }

    /* ===== Study card ===== */
    .study-area, .review-area, .quiz-area{ display:none; }
    .study-area.active, .review-area.active, .quiz-area.active{ display:block; }

    .study-container{
      display:flex; flex-direction:column; align-items:center; gap:14px;
      padding:8px 0 2px;
    }
    .word-card{
      width:100%; max-width:540px; height:320px; perspective:1000px;
      cursor:pointer;
    }
    .card-inner{
      position:relative; width:100%; height:100%; text-align:center;
      transition:transform .6s; transform-style:preserve-3d;
    }
    .word-card.flipped .card-inner{ transform:rotateY(180deg); }
    .card-front,.card-back{
      position:absolute; width:100%; height:100%; backface-visibility:hidden;
      display:flex; flex-direction:column; justify-content:center; align-items:center;
      padding:26px; border-radius:16px; box-shadow:var(--shadow);
    }
    .card-front{
      background:linear-gradient(135deg,var(--primary) 0%,var(--primary-light) 100%);
      color:#fff;
    }
    .card-back{
      background:#fff; color:var(--dark); transform:rotateY(180deg);
    }
    .word{ font-size:2.5rem; font-weight:900; margin-bottom:6px; }
    .pos{ font-size:1.1rem; font-style:italic; margin-bottom:10px; opacity:.95; }
    .meaning{ font-size:1.55rem; font-weight:700; margin-bottom:12px; }
    .example{ font-size:1.1rem; font-style:italic; color:var(--gray); margin-bottom:6px; }
    .example-translation{ color:var(--gray); font-size:1rem; }

    .tts-row{
      display:flex; gap:10px; align-items:center; margin-top:10px; flex-wrap:wrap;
      color:rgba(255,255,255,0.95);
    }
    .card-back .tts-row{ color:var(--gray); }

    .tts-btn{
      background:none; border:none; color:inherit; font-size:1.45rem;
      cursor:pointer; transition:var(--transition);
    }
    .tts-btn:hover{ color:var(--accent); transform:scale(1.1); }

    .card-controls{
      display:flex; gap:10px; margin-top:2px; flex-wrap:wrap; justify-content:center;
    }
    .nav-btn{
      padding:9px 16px;
      background:var(--primary); color:#fff; border:none; border-radius:999px;
      cursor:pointer; transition:var(--transition);
      font-weight:800; display:flex; align-items:center; gap:6px;
    }
    .nav-btn:hover{ background:var(--primary-light); transform:translateY(-2px); }
    .nav-btn:disabled{
      background:var(--gray-light); color:var(--gray); cursor:not-allowed; transform:none;
    }

    /* ===== Review cards ===== */
    .review-grid{
      display:grid; grid-template-columns:repeat(auto-fill,minmax(230px,1fr));
      gap:12px; padding-top:6px;
    }
    .review-card{
      height:200px; perspective:1000px; cursor:pointer;
    }
    .review-card .card-inner{ height:100%; }
    .review-card .card-front{
      background:linear-gradient(135deg, var(--secondary) 0%, #FF8EA0 100%);
      color:#fff;
    }

    /* ===== Quiz ===== */
    .quiz-settings{
      background:#fff; border-radius:16px; box-shadow:var(--shadow);
      padding:14px; margin-bottom:12px;
    }
    .setting-group{ margin-bottom:10px; }
    .setting-label{
      font-weight:800; color:#2c2f44; display:block; margin-bottom:6px;
    }
    .setting-select{
      width:100%; padding:9px; border-radius:10px; border:1px solid #d9dce6;
      font-family:"Poppins",sans-serif;
    }
    .start-btn{
      width:100%; text-align:center; padding:11px; border:none; border-radius:999px;
      background:var(--success); color:#fff; font-weight:900; cursor:pointer;
      transition:var(--transition);
    }
    .start-btn:hover{ background:#218838; transform:translateY(-2px); }

    .quiz-wrap{
      background:#fff; border-radius:16px; box-shadow:var(--shadow);
      padding:14px; display:none;
    }
    .quiz-wrap.active{ display:block; }

    .quiz-progress{
      display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:8px;
      font-size:.95rem; color:#2c2f44; font-weight:700;
    }
    .progress-bar{
      height:8px; background:var(--gray-light); border-radius:999px; flex-grow:1; overflow:hidden;
      margin:0 8px;
    }
    .progress-fill{
      height:100%; width:0%; background:var(--primary); transition:width .25s ease;
    }

    .quiz-question{
      padding:14px; border-radius:14px; background:#fbfbff; border:1px dashed #e6e8ff;
    }
    .question-text{
      font-size:1.18rem; font-weight:800; margin-bottom:10px;
    }
    .options-container{
      display:grid; grid-template-columns:1fr 1fr; gap:10px;
    }
    .option{
      background:var(--gray-light); border-radius:10px; padding:10px;
      cursor:pointer; transition:var(--transition); font-weight:700; user-select:none;
    }
    .option:hover{ background:var(--primary-light); color:#fff; transform:translateY(-1px); }
    .option.selected{ background:var(--primary); color:#fff; }

    .quiz-result{
      background:#fff; border-radius:16px; box-shadow:var(--shadow);
      padding:18px;
    }
    .wrong-list{ margin-top:10px; display:grid; gap:8px; }
    .wrong-item{
      background:var(--gray-light); padding:10px 12px; border-radius:12px;
    }
    .wrong-item .w-word{ font-weight:900; color:var(--primary); margin-bottom:4px; }

    .hidden{ display:none; }

    /* ===== RWD ===== */
    @media (max-width: 900px){
      header{ flex-direction:column; align-items:flex-start; }
      .header-actions{ width:100%; justify-content:flex-start; }
      .options-container{ grid-template-columns:1fr; }
    }
    @media (max-width: 600px){
      .chapters-grid{ grid-template-columns:1fr; }
      .word-bank-list{ grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); }
      .review-grid{ grid-template-columns:1fr; }
      .word{ font-size:2.1rem; }
    }
  </style>
</head>

<body>
<div class="container">

  <header>
    <div class="title-block">
      <h1>Shirley's TOEIC Essential Vocab</h1>
      <p>Study ¬∑ Review ¬∑ Quiz in one place</p>
    </div>

    <div class="header-actions">
      <button class="btn secondary" id="back-home-btn">
        <i class="fa-solid fa-house"></i> Categories
      </button>

      <button class="btn active" data-mode="study">
        <i class="fa-solid fa-book-open"></i> Study
      </button>
      <button class="btn" data-mode="review">
        <i class="fa-solid fa-arrows-rotate"></i> Review
      </button>
      <button class="btn" data-mode="quiz">
        <i class="fa-solid fa-list-check"></i> Quiz
      </button>
    </div>
  </header>

  <div class="loading" id="loading">
    <i class="fas fa-spinner fa-spin"></i>
    Loading vocabulary data...
  </div>

  <!-- ===== LAYER 1: HOME ===== -->
  <section id="home-view" class="hidden">
    <div class="chapters-grid" id="chapters-grid"></div>
  </section>

  <!-- ===== LAYER 2: CATEGORY ===== -->
  <section id="category-view">
    <div class="category-header">
      <div class="category-title" id="category-title">Category</div>
      <div class="subchips" id="subchips"></div>
    </div>

    <!-- word bank overview -->
    <div class="word-bank">
      <div class="word-bank-header">
        <div class="word-bank-title"><i class="fa-solid fa-layer-group"></i> Word Overview</div>
        <div class="word-bank-count" id="bank-count"></div>
      </div>
      <div class="word-bank-list" id="bank-list"></div>
    </div>

    <!-- STUDY -->
    <div class="study-area active" id="study-area">
      <div class="study-container">
        <div class="word-card" id="study-card">
          <div class="card-inner">
            <div class="card-front"></div>
            <div class="card-back"></div>
          </div>
        </div>
        <div class="card-controls">
          <button class="nav-btn" id="prev-btn"><i class="fa-solid fa-chevron-left"></i> Prev</button>
          <button class="nav-btn" id="flip-btn"><i class="fa-solid fa-right-left"></i> Flip</button>
          <button class="nav-btn" id="next-btn">Next <i class="fa-solid fa-chevron-right"></i></button>
        </div>
      </div>
    </div>

    <!-- REVIEW -->
    <div class="review-area" id="review-area">
      <div class="review-grid" id="review-grid"></div>
    </div>

    <!-- QUIZ -->
    <div class="quiz-area" id="quiz-area">
      <div class="quiz-settings" id="quiz-settings">
        <div class="setting-group">
          <label class="setting-label">Quiz Mode</label>
          <select class="setting-select" id="quiz-mode-select">
            <option value="mix-all">Mix All Chapters</option>
            <option value="mix-chapter">Mix Selected Chapter</option>
            <option value="precise">Precise (Chapter & Subchapter)</option>
          </select>
        </div>

        <div class="setting-group">
          <label class="setting-label">Chapter</label>
          <select class="setting-select" id="quiz-chapter-select"></select>
        </div>

        <div class="setting-group hidden" id="quiz-sub-setting">
          <label class="setting-label">Subchapter</label>
          <select class="setting-select" id="quiz-subchapter-select"></select>
        </div>

        <div class="setting-group">
          <label class="setting-label">Number of Questions</label>
          <select class="setting-select" id="quiz-count-select">
            <option value="10">10 Questions</option>
            <option value="20">20 Questions</option>
            <option value="all">All Questions</option>
          </select>
        </div>

        <button class="start-btn" id="start-quiz-btn">Start Quiz</button>
      </div>

      <div class="quiz-wrap" id="quiz-wrap">
        <div class="quiz-progress">
          <span id="progress-text">1 / 10</span>
          <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
          <span id="answered-text">Answered: 0/0</span>
        </div>

        <div class="quiz-question">
          <div class="question-text" id="question-text"></div>
          <div class="options-container" id="options-container"></div>
        </div>
      </div>
    </div>

  </section>

</div>

<script>
  // ================= CSV URL =================
  const CSV_URL = 'https://raw.githubusercontent.com/ducj-creator/Shirley-Grammar/main/TOEIC%20vocab.csv';

  // ================= DEMO DATA (ÂÇôÊè¥) =================
  const DEMO_DATA = {
    chapters: [
      {
        id: "Chapter 1",
        title: "Ë°åÊîøËàáÁµÑÁπîÈÅã‰Ωú / Administration & Organizational Operations",
        subchapters: [
          {id:"Ëæ¶ÂÖ¨ÂÆ§ËàáÊó•Â∏∏Ë°åÊîø / Office & Routine Administration", title:"Ëæ¶ÂÖ¨ÂÆ§ËàáÊó•Â∏∏Ë°åÊîø / Office & Routine Administration"}
        ],
        words: [
          {
            chapter:"Ë°åÊîøËàáÁµÑÁπîÈÅã‰Ωú / Administration & Organizational Operations",
            subchapter:"Ëæ¶ÂÖ¨ÂÆ§ËàáÊó•Â∏∏Ë°åÊîø / Office & Routine Administration",
            word:"appointment", pos:"n.", meaning:"Á¥ÑÊúÉ;Á¥ÑÂÆö",
            example:"I'd like to make an appointment with the HR manager to discuss my transfer.",
            exampleTranslation:"ÊàëÊÉ≥Âíå‰∫∫Ë≥áÁ∂ìÁêÜÁ¥ÑÂÄãÊôÇÈñìÔºåË®éË´ñÊàëÁöÑË™øËÅ∑‰∫ãÂÆú„ÄÇ"
          }
        ]
      }
    ]
  };

  // ================= DOM =================
  const loadingEl = document.getElementById('loading');
  const homeView = document.getElementById('home-view');
  const chaptersGrid = document.getElementById('chapters-grid');

  const categoryView = document.getElementById('category-view');
  const categoryTitle = document.getElementById('category-title');
  const subchipsEl = document.getElementById('subchips');

  const bankCountEl = document.getElementById('bank-count');
  const bankListEl = document.getElementById('bank-list');

  const modeBtns = document.querySelectorAll('.header-actions .btn[data-mode]');
  const backHomeBtn = document.getElementById('back-home-btn');

  const studyArea = document.getElementById('study-area');
  const reviewArea = document.getElementById('review-area');
  const quizArea = document.getElementById('quiz-area');

  const studyCard = document.getElementById('study-card');
  const flipBtn = document.getElementById('flip-btn');
  const prevBtn = document.getElementById('prev-btn');
  const nextBtn = document.getElementById('next-btn');

  const reviewGrid = document.getElementById('review-grid');

  const quizSettings = document.getElementById('quiz-settings');
  const quizWrap = document.getElementById('quiz-wrap');
  const quizModeSelect = document.getElementById('quiz-mode-select');
  const quizChapterSelect = document.getElementById('quiz-chapter-select');
  const quizSubSetting = document.getElementById('quiz-sub-setting');
  const quizSubchapterSelect = document.getElementById('quiz-subchapter-select');
  const quizCountSelect = document.getElementById('quiz-count-select');
  const startQuizBtn = document.getElementById('start-quiz-btn');

  const progressText = document.getElementById('progress-text');
  const answeredText = document.getElementById('answered-text');
  const progressFill = document.getElementById('progress-fill');
  const questionText = document.getElementById('question-text');
  const optionsContainer = document.getElementById('options-container');

  // ================= STATE =================
  let vocabularyData = null;
  let currentChapter = null;
  let currentSubchapter = 'ALL';
  let currentMode = 'study';

  let currentWords = [];
  let currentWordIndex = 0;

  // quiz
  let quizQuestionsData = [];
  let quizAnswers = [];
  let quizIndex = 0;
  let quizFinished = false;

  // ================= INIT =================
  async function init(){
    try {
      vocabularyData = await loadCSVData();
    } catch (e){
      console.warn('CSV failed, use demo', e);
      vocabularyData = DEMO_DATA;
    }

    renderHome();
    renderQuizChapterOptions();
    setupEvents();

    loadingEl.classList.add('hidden');
    homeView.classList.remove('hidden');
  }

  async function loadCSVData(){
    return new Promise((resolve, reject)=>{
      Papa.parse(CSV_URL,{
        download:true, header:true, skipEmptyLines:true,
        complete:(results)=>{
          if(results.errors?.length) return reject(results.errors[0]);
          if(!results.data?.length) return reject('empty csv');
          const processed = processCSVData(results.data);
          if(!processed.chapters.length) return reject('no valid rows');
          resolve(processed);
        },
        error:reject
      });
    });
  }

  function processCSVData(csvData){
    const chaptersMap = new Map();
    const pick = (row, keys) => {
      for(const k of keys){
        if(row[k]!=null && String(row[k]).trim()!=='') return String(row[k]).trim();
      }
      return '';
    };

    csvData.forEach(row=>{
      const chapterName = pick(row,['chapter','Chapter','CHAPTER']);
      const subchapterName = pick(row,['subchapter','Subchapter','SUBCHAPTER']);
      const wordText = pick(row,['word','Word','WORD']);
      if(!chapterName || !wordText) return;

      if(!chaptersMap.has(chapterName)){
        chaptersMap.set(chapterName,{
          id:chapterName,
          title:chapterName,
          subchapters:new Map(),
          words:[]
        });
      }

      const ch = chaptersMap.get(chapterName);

      if(subchapterName && !ch.subchapters.has(subchapterName)){
        ch.subchapters.set(subchapterName,{id:subchapterName, title:subchapterName});
      }

      ch.words.push({
        chapter:chapterName,
        subchapter:subchapterName,
        word:wordText,
        pos:pick(row,['pos','Part of Speech','POS']),
        meaning:pick(row,['meaning','Meaning']),
        example:pick(row,['english sentence','Example Sentence','example','sentence']),
        exampleTranslation:pick(row,['chinese sentence','Example Translation','translation']),
        pronunciation:pick(row,['pronunciation','Pronunciation'])
      });
    });

    const chapters = Array.from(chaptersMap.values()).map(ch=>{
      ch.subchapters = Array.from(ch.subchapters.values());
      return ch;
    });

    return {chapters};
  }

  // ================= UI RENDER =================
  function renderHome(){
    chaptersGrid.innerHTML = '';

    vocabularyData.chapters.forEach(ch=>{
      const card = document.createElement('div');
      card.className = 'chapter-card';
      const emoji = getChapterEmoji(ch.title);
      card.innerHTML = `
        <div>
          <div class="emoji">${emoji}</div>
          <h3>${ch.title}</h3>
        </div>
        <div class="chapter-meta">
          <span class="chip"><i class="fa-solid fa-book"></i> ${ch.words.length} words</span>
          <span><i class="fa-regular fa-folder-open"></i> ${ch.subchapters.length} sub</span>
        </div>
      `;
      card.addEventListener('click', ()=> enterCategory(ch.id));
      chaptersGrid.appendChild(card);
    });

    // layer control
    homeView.classList.remove('hidden');
    categoryView.classList.remove('active');
    currentChapter = null;
  }

  function enterCategory(chapterId){
    currentChapter = vocabularyData.chapters.find(c=>c.id===chapterId);
    if(!currentChapter) return;

    currentSubchapter = 'ALL';
    categoryTitle.innerHTML = `${getChapterEmoji(currentChapter.title)} ${currentChapter.title}`;

    renderSubchips();
    loadWordsForCategory();
    renderWordBank();
    renderStudyCard();
    renderReviewGrid();

    // show layer2
    homeView.classList.add('hidden');
    categoryView.classList.add('active');

    switchMode(currentMode);
  }

  function renderSubchips(){
    subchipsEl.innerHTML = '';

    const allChip = makeSubchip('ALL','All', currentChapter.words.length, true);
    subchipsEl.appendChild(allChip);

    currentChapter.subchapters.forEach(sub=>{
      const count = currentChapter.words.filter(w=>w.subchapter===sub.id).length;
      const chip = makeSubchip(sub.id, sub.title, count);
      subchipsEl.appendChild(chip);
    });
  }

  function makeSubchip(id, label, count, active=false){
    const chip = document.createElement('div');
    chip.className = `subchip ${active?'active':''}`;
    chip.dataset.subId = id;
    chip.innerHTML = `${label} <span class="chip" style="background:rgba(0,0,0,0.06); color:inherit">${count}</span>`;
    chip.addEventListener('click', ()=>{
      document.querySelectorAll('.subchip').forEach(c=>c.classList.remove('active'));
      chip.classList.add('active');
      currentSubchapter = id;
      loadWordsForCategory();
      renderWordBank();
      if(currentMode==='study') renderStudyCard();
      if(currentMode==='review') renderReviewGrid();
    });
    return chip;
  }

  function loadWordsForCategory(){
    if(currentSubchapter==='ALL'){
      currentWords = [...currentChapter.words];
    } else {
      currentWords = currentChapter.words.filter(w=>w.subchapter===currentSubchapter);
    }
    currentWordIndex = 0;
  }

  function renderWordBank(){
    bankListEl.innerHTML = '';
    bankCountEl.textContent = `${currentWords.length} words`;

    currentWords.forEach((w, idx)=>{
      const item = document.createElement('div');
      item.className = 'bank-item';
      item.innerHTML = `
        <div class="bank-word">${w.word}</div>
        <div class="bank-pos">${w.pos||''}</div>
      `;
      item.addEventListener('click', ()=>{
        currentWordIndex = idx;
        if(currentMode==='study'){
          renderStudyCard();
          studyArea.scrollIntoView({behavior:'smooth', block:'center'});
        }
      });
      bankListEl.appendChild(item);
    });
  }

  // ================= STUDY =================
  function renderStudyCard(){
    if(!currentWords.length) return;
    const w = currentWords[currentWordIndex];
    const front = studyCard.querySelector('.card-front');
    const back = studyCard.querySelector('.card-back');

    front.innerHTML = `
      <div class="word">${w.word}</div>
      <div class="pos">${w.pos||''}</div>
      <div class="meaning">${w.meaning||''}</div>
      <div class="tts-row">
        <button class="tts-btn" title="Pronounce word"><i class="fas fa-volume-up"></i></button>
        <span>${w.pronunciation||'/.../'}</span>
      </div>
      <div style="margin-top:10px; font-size:.9rem; opacity:.9;">Tap card to see examples</div>
    `;

    back.innerHTML = `
      <div class="word">${w.word}</div>
      <div class="pos">${w.pos||''}</div>
      <div class="example">${w.example||'No example available'}</div>
      <div class="example-translation">${w.exampleTranslation||'ÁÑ°ÂèØÁî®‰æãÂè•'}</div>
      <div class="tts-row">
        <button class="tts-btn" title="Pronounce example"><i class="fas fa-volume-up"></i></button>
        <span>Example TTS</span>
      </div>
      <div style="margin-top:10px; font-size:.9rem; color:var(--gray);">Tap card to go back</div>
    `;

    studyCard.classList.remove('flipped');

    prevBtn.disabled = currentWordIndex===0;
    nextBtn.disabled = currentWordIndex===currentWords.length-1;

    // bind TTS
    front.querySelector('.tts-btn').addEventListener('click',(e)=>{
      e.stopPropagation(); speak(w.word);
    });
    back.querySelector('.tts-btn').addEventListener('click',(e)=>{
      e.stopPropagation(); speak(w.example || w.word);
    });
  }

  function goPrevWord(){
    if(currentWordIndex>0){ currentWordIndex--; renderStudyCard(); }
  }
  function goNextWord(){
    if(currentWordIndex<currentWords.length-1){ currentWordIndex++; renderStudyCard(); }
  }

  // ================= REVIEW =================
  function renderReviewGrid(){
    reviewGrid.innerHTML='';
    currentWords.forEach(w=>{
      const card = document.createElement('div');
      card.className='review-card';
      card.innerHTML = `
        <div class="card-inner">
          <div class="card-front card-front-review">
            <div class="word" style="font-size:1.9rem">${w.word}</div>
            <div class="pos">${w.pos||''}</div>
          </div>
          <div class="card-back">
            <div class="meaning" style="font-size:1.2rem; font-weight:800">${w.meaning||''}</div>
            <div class="example">${w.example||'No example available'}</div>
            <div class="example-translation">${w.exampleTranslation||'ÁÑ°ÂèØÁî®‰æãÂè•'}</div>
            <div class="tts-row">
              <button class="tts-btn" title="Pronounce example"><i class="fas fa-volume-up"></i></button>
              <span>Example TTS</span>
            </div>
          </div>
        </div>
      `;
      card.addEventListener('click', ()=> card.classList.toggle('flipped'));
      // example tts
      card.querySelector('.card-back .tts-btn').addEventListener('click',(e)=>{
        e.stopPropagation(); speak(w.example || w.word);
      });
      reviewGrid.appendChild(card);
    });
  }

  // ================= QUIZ =================
  function renderQuizChapterOptions(){
    quizChapterSelect.innerHTML='';
    vocabularyData.chapters.forEach(ch=>{
      const opt = document.createElement('option');
      opt.value=ch.id; opt.textContent=ch.title;
      quizChapterSelect.appendChild(opt);
    });
    const allOpt = document.createElement('option');
    allOpt.value='all'; allOpt.textContent='All Chapters';
    quizChapterSelect.appendChild(allOpt);

    quizChapterSelect.value = currentChapter?.id || 'all';
    handleQuizChapterChange();
  }

  function handleQuizModeChange(){
    if(quizModeSelect.value==='precise'){
      quizSubSetting.classList.remove('hidden');
    } else {
      quizSubSetting.classList.add('hidden');
    }
  }

  function handleQuizChapterChange(){
    quizSubchapterSelect.innerHTML='';
    const chapterId = quizChapterSelect.value;
    if(chapterId==='all') return;

    const ch = vocabularyData.chapters.find(c=>c.id===chapterId);
    if(!ch) return;

    ch.subchapters.forEach(sub=>{
      const opt=document.createElement('option');
      opt.value=sub.id; opt.textContent=sub.title;
      quizSubchapterSelect.appendChild(opt);
    });
  }

  function startQuiz(){
    quizFinished=false;
    quizIndex=0;

    const mode = quizModeSelect.value;
    const chapterId = quizChapterSelect.value;
    const subId = quizSubchapterSelect.value;

    let pool=[];
    if(mode==='mix-all' || chapterId==='all'){
      vocabularyData.chapters.forEach(ch=>pool.push(...ch.words));
    } else if(mode==='mix-chapter'){
      const ch=vocabularyData.chapters.find(c=>c.id===chapterId);
      if(ch) pool=[...ch.words];
    } else if(mode==='precise'){
      const ch=vocabularyData.chapters.find(c=>c.id===chapterId);
      if(ch) pool=ch.words.filter(w=>w.subchapter===subId);
    }

    pool = pool.filter(w=>w.word && w.meaning);
    if(pool.length<4){
      alert('Not enough words to generate quiz (need at least 4).');
      return;
    }

    pool = shuffle(pool);

    let qCount = pool.length;
    if(quizCountSelect.value!=='all'){
      qCount = Math.min(Number(quizCountSelect.value), pool.length);
    }

    quizQuestionsData=[];
    for(let i=0;i<qCount;i++){
      const target=pool[i];
      const options=buildOptions(target, pool);
      const correctIndex=options.findIndex(o=>o.meaning===target.meaning);
      quizQuestionsData.push({wordObj:target, options, correctIndex});
    }
    quizAnswers = quizQuestionsData.map(()=>({selectedIndex:null}));

    quizSettings.style.display='none';
    quizWrap.classList.add('active');

    renderQuizQuestion();
    updateQuizUI();
  }

  function buildOptions(target, pool){
    const distractors = pool
      .filter(w=>w.word!==target.word && w.meaning)
      .map(w=>({meaning:w.meaning}))
      .filter((v,idx,arr)=>arr.findIndex(x=>x.meaning===v.meaning)===idx);

    const picked=[];
    while(picked.length<3 && distractors.length){
      const r=Math.floor(Math.random()*distractors.length);
      picked.push(distractors.splice(r,1)[0]);
    }

    return shuffle([{meaning:target.meaning}, ...picked]);
  }

  function renderQuizQuestion(){
    const q=quizQuestionsData[quizIndex];
    const w=q.wordObj;

    questionText.innerHTML = `Meaning of <strong>${w.word}</strong> ${w.pos?`(${w.pos})`:''} ?`;

    optionsContainer.innerHTML='';
    q.options.forEach((opt, idx)=>{
      const div=document.createElement('div');
      div.className='option';
      div.dataset.index=idx;
      div.textContent=`${String.fromCharCode(65+idx)}. ${opt.meaning}`;

      div.addEventListener('click', ()=>{
        if(quizFinished) return;
        quizAnswers[quizIndex].selectedIndex=idx;
        updateQuizUI();

        // ‚úÖ Ëá™ÂãïÈÄ≤‰∏ã‰∏ÄÈ°å
        if(quizIndex < quizQuestionsData.length-1){
          quizIndex++;
          renderQuizQuestion();
          updateQuizUI();
        } else {
          submitQuiz();
        }
      });

      optionsContainer.appendChild(div);
    });
  }

  function submitQuiz(){
    // ÂøÖÈ†àÁ≠îÂÆåÊâçÁÆóÊèê‰∫§Ôºà‰Ω†ÂéüÊú¨Ë¶ÅÊ±ÇÔºâ
    const total=quizQuestionsData.length;
    const answered=quizAnswers.filter(a=>a.selectedIndex!==null).length;
    if(answered<total){
      alert('Please answer all questions.');
      return;
    }

    quizFinished=true;

    let score=0;
    const wrongs=[];
    quizQuestionsData.forEach((q,i)=>{
      const sel=quizAnswers[i].selectedIndex;
      if(sel===q.correctIndex) score++;
      else wrongs.push({
        idx:i+1, word:q.wordObj.word, pos:q.wordObj.pos,
        meaning:q.wordObj.meaning, your:q.options[sel].meaning
      });
    });

    showQuizResult(score,total,wrongs);
  }

  function showQuizResult(score,total,wrongs){
    quizWrap.innerHTML=`
      <div class="quiz-result">
        <h2 style="color:var(--primary); margin-bottom:6px;">üéâ Quiz Finished!</h2>
        <p style="font-size:1.1rem; margin-bottom:6px;">
          Score: <strong>${score} / ${total}</strong>
        </p>
        <p style="color:var(--gray); margin-bottom:10px;">
          Accuracy: ${(score/total*100).toFixed(1)}%
        </p>

        ${wrongs.length===0 ? `
          <p style="color:var(--success); font-weight:900;">Perfect! üéØ</p>
        ` : `
          <h3>Wrong Answers</h3>
          <div class="wrong-list">
            ${wrongs.map(w=>`
              <div class="wrong-item">
                <div class="w-word">${w.idx}. ${w.word} ${w.pos?`(${w.pos})`:''}</div>
                <div>‚úÖ Correct: ${w.meaning}</div>
                <div>‚ùå Your answer: ${w.your}</div>
              </div>
            `).join('')}
          </div>
        `}

        <div style="display:flex; gap:8px; margin-top:12px; flex-wrap:wrap;">
          <button class="btn" id="restart-quiz-btn"><i class="fa-solid fa-rotate-right"></i> Restart</button>
          <button class="btn secondary" id="back-quiz-settings-btn"><i class="fa-solid fa-sliders"></i> Settings</button>
        </div>
      </div>
    `;

    document.getElementById('restart-quiz-btn').addEventListener('click', ()=>{
      // restore wrap
      quizWrap.innerHTML=`
        <div class="quiz-progress">
          <span id="progress-text">1 / 10</span>
          <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
          <span id="answered-text">Answered: 0/0</span>
        </div>
        <div class="quiz-question">
          <div class="question-text" id="question-text"></div>
          <div class="options-container" id="options-container"></div>
        </div>
      `;
      // rebind local refs
      window.progressText = document.getElementById('progress-text');
      window.answeredText = document.getElementById('answered-text');
      window.progressFill = document.getElementById('progress-fill');
      window.questionText = document.getElementById('question-text');
      window.optionsContainer = document.getElementById('options-container');

      startQuiz();
    });

    document.getElementById('back-quiz-settings-btn').addEventListener('click', ()=>{
      quizWrap.classList.remove('active');
      quizSettings.style.display='block';
    });
  }

  function updateQuizUI(){
    const total=quizQuestionsData.length;
    const answered=quizAnswers.filter(a=>a.selectedIndex!==null).length;

    progressText.textContent=`${quizIndex+1} / ${total}`;
    answeredText.textContent=`Answered: ${answered}/${total}`;
    progressFill.style.width=`${(answered/total)*100}%`;
  }

  // ================= MODE / NAV =================
  function switchMode(mode){
    currentMode=mode;
    modeBtns.forEach(b=>b.classList.remove('active'));
    document.querySelector(`.btn[data-mode="${mode}"]`)?.classList.add('active');

    studyArea.classList.remove('active');
    reviewArea.classList.remove('active');
    quizArea.classList.remove('active');

    if(mode==='study'){
      studyArea.classList.add('active');
      if(currentChapter) renderStudyCard();
    } else if(mode==='review'){
      reviewArea.classList.add('active');
      if(currentChapter) renderReviewGrid();
    } else {
      quizArea.classList.add('active');
      renderQuizChapterOptions();
      quizWrap.classList.remove('active');
      quizSettings.style.display='block';
      handleQuizModeChange();
      handleQuizChapterChange();
    }
  }

  // ================= EVENTS / UTILS =================
  function setupEvents(){
    modeBtns.forEach(btn=>{
      btn.addEventListener('click', ()=> switchMode(btn.dataset.mode));
    });

    backHomeBtn.addEventListener('click', renderHome);

    // study interactions
    studyCard.addEventListener('click', ()=> studyCard.classList.toggle('flipped'));
    flipBtn.addEventListener('click', (e)=>{ e.stopPropagation(); studyCard.classList.toggle('flipped'); });
    prevBtn.addEventListener('click', goPrevWord);
    nextBtn.addEventListener('click', goNextWord);

    // quiz settings
    quizModeSelect.addEventListener('change', handleQuizModeChange);
    quizChapterSelect.addEventListener('change', handleQuizChapterChange);
    startQuizBtn.addEventListener('click', startQuiz);
  }

  function speak(text){
    if(!('speechSynthesis' in window)) return;
    const u=new SpeechSynthesisUtterance(text);
    u.lang='en-US'; u.rate=0.85;
    speechSynthesis.speak(u);
  }

  function shuffle(arr){
    const a=[...arr];
    for(let i=a.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  // Á∞°ÂñÆ emoji Ë¶èÂâáÔºöÂèØÂÜçÊâãÂãïÊì¥ÂÖÖ
  function getChapterEmoji(title){
    const t=title.toLowerCase();
    if(t.includes('administration')||t.includes('Ë°åÊîø')) return 'üóÇÔ∏è';
    if(t.includes('finance')||t.includes('Ë≤°Âãô')||t.includes('budget')) return 'üí∞';
    if(t.includes('marketing')||t.includes('Ë°åÈä∑')) return 'üì£';
    if(t.includes('meeting')||t.includes('ÊúÉË≠∞')) return 'üßë‚Äçüíº';
    if(t.includes('travel')||t.includes('ÊóÖË°å')) return '‚úàÔ∏è';
    if(t.includes('office')||t.includes('Ëæ¶ÂÖ¨ÂÆ§')) return 'üè¢';
    return 'üìò';
  }

  init();
</script>
</body>
</html>

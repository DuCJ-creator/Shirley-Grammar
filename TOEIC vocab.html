<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Shirley's TOEIC Essential Vocab</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

  <style>
    :root {
      /* Á∂≠ÊåÅÂéüÊú¨ÁöÑÈ´òÁ¥öÈÖçËâ≤ */
      --primary: #6C63FF;
      --primary-light: #8A85FF;
      --secondary: #FF6584;
      --accent: #36D1DC;
      --light: #F8F9FA;
      --dark: #2f3241;
      --success: #28A745;
      --warning: #FFC107;
      --danger: #DC3545;
      --gray: #6C757D;
      --gray-light: #EEF0F6;
      --border-radius: 16px;
      --shadow: 0 8px 20px rgba(0,0,0,0.08);
      --transition: all 0.25s ease;
      --glass: rgba(255, 255, 255, 0.9);
    }

    *{ margin:0; padding:0; box-sizing:border-box; }
    body{
      font-family:"Poppins", sans-serif;
      background:
        radial-gradient(1200px 600px at 8% -12%, #ffffff 0%, #f3f6ff 30%, transparent 60%),
        radial-gradient(900px 500px at 110% 10%, #fff0f5 0%, #f5f7fa 35%, transparent 60%),
        linear-gradient(135deg,#f6f8fb 0%,#c9d7ee 100%);
      color:var(--dark);
      min-height:100vh;
      padding:16px;
    }
    .container{ max-width:1200px; margin:0 auto; }

    /* Header ÊîπÁÇ∫ÊîØÊè¥ÊêúÂ∞ãÊ¨ÑÁöÑ‰ΩàÂ±Ä */
    header{
      background: rgba(255,255,255,0.85);
      border-radius:var(--border-radius);
      box-shadow:var(--shadow);
      padding:18px 24px;
      margin-bottom: 20px;
      display:flex; flex-direction: column; gap:16px;
      position:sticky; top:10px; z-index:50;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.6);
    }

    .header-top {
      display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;
    }

    .title-block h1{
      color:var(--primary); font-size:1.8rem; font-weight:800; letter-spacing:.3px;
      text-shadow: 0 2px 10px rgba(108,99,255,0.15);
    }
    .title-block p{ color:var(--gray); font-size:0.95rem; margin-top:2px; }

    .header-actions{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }

    /* === SEARCH BAR STYLES (NEW) === */
    .search-row {
      width: 100%;
      position: relative;
    }
    .search-input {
      width: 100%;
      padding: 12px 16px 12px 48px;
      border-radius: 12px;
      border: 2px solid transparent;
      background: #f0f2f5;
      font-size: 1rem;
      color: var(--dark);
      transition: var(--transition);
      font-family: inherit;
    }
    .search-input:focus {
      background: #fff;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(108, 99, 255, 0.15);
      outline: none;
    }
    .search-icon {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
      pointer-events: none;
    }
    .search-hint {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.8rem;
      color: #fff;
      background: var(--primary);
      padding: 2px 8px;
      border-radius: 6px;
      opacity: 0;
      transition: var(--transition);
      pointer-events: none;
    }
    .search-input:not(:placeholder-shown) + .search-icon + .search-hint {
      opacity: 1;
    }

    /* Buttons */
    .btn{
      padding:8px 16px; background:#fff; border:1px solid #e0e0e0;
      color:var(--gray); border-radius:999px; font-weight:600;
      cursor:pointer; transition:var(--transition); display:flex; align-items:center; gap:8px;
      font-size:.9rem;
    }
    .btn:hover{
      background: #f8f9fa; transform:translateY(-2px); color: var(--primary);
      border-color: var(--primary-light);
    }
    .btn.active{ 
      background:var(--primary); color:#fff; border-color:var(--primary); 
      box-shadow: 0 4px 12px rgba(108, 99, 255, 0.3);
    }
    .btn.secondary{
      background: rgba(255, 101, 132, 0.1); color: var(--secondary); border:none;
    }
    .btn.secondary:hover {
      background: var(--secondary); color: white;
    }

    .loading{
      text-align:center; padding:50px 0; color:var(--primary); font-size:1.1rem;
    }
    .loading i{ font-size:2rem; display:block; margin-bottom:10px; }

    /* ====== LAYER 1 Home ====== */
    #home-view{ margin-top:10px; }
    .chapters-grid{
      display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
      gap:20px;
    }
    .chapter-card{
      background: #ffffff;
      border:1px solid rgba(255,255,255,0.8);
      border-radius:18px;
      padding:20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.02), 0 10px 15px rgba(0,0,0,0.03);
      cursor:pointer; transition:var(--transition);
      position:relative; overflow:hidden;
      min-height:140px;
      display:flex; flex-direction:column; justify-content:space-between;
    }
    .chapter-card::before {
      content:''; position: absolute; top:0; left:0; width:6px; height:100%;
      background: var(--primary-light); opacity: 0.5;
    }
    .chapter-card:hover{
      transform:translateY(-5px);
      box-shadow: 0 15px 30px rgba(108, 99, 255, 0.15);
      border-color: var(--primary-light);
    }
    .chapter-card h3{
      font-size:1.1rem; line-height:1.4; color:#27293b; font-weight:700; margin-bottom: 4px;
    }
    .chapter-card .emoji{
      font-size:2rem; margin-bottom:12px; display: inline-block;
    }
    .chapter-meta{
      display:flex; justify-content:space-between; align-items:center; margin-top:12px;
      color:var(--gray); font-size:.85rem;
    }
    .chip{
      background: #f0f2f5; color: var(--dark);
      padding:4px 10px; border-radius:8px; font-weight:600; font-size:.8rem;
      display:inline-flex; align-items:center; gap:4px;
    }

    /* ====== LAYER 2 Category/Search view ====== */
    #category-view{ margin-top:10px; display:none; }
    #category-view.active{ display:block; }

    .category-header{
      display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;
      margin-bottom:16px;
    }
    .category-title{
      font-size:1.4rem; font-weight:800; color:#24263a;
      display:flex; gap:10px; align-items:center;
    }

    .subchips{
      display:flex; flex-wrap:wrap; gap:8px;
      background: #fff; padding:12px; border-radius:16px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,0.05);
    }
    .subchip{
      padding:6px 14px; border-radius:999px; background:var(--gray-light);
      cursor:pointer; transition:var(--transition); font-size:.9rem; font-weight:600;
      display:flex; align-items:center; gap:6px; color: var(--gray);
    }
    .subchip:hover{ background:#e2e6ea; color:var(--dark); }
    .subchip.active{ background:var(--primary); color:#fff; box-shadow: 0 4px 10px rgba(108,99,255,0.3); }

    .word-bank{
      background:#fff; border-radius:16px; box-shadow:var(--shadow);
      padding:16px; margin-bottom:20px;
      border: 1px solid rgba(0,0,0,0.05);
    }
    .word-bank-header{
      display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;
      border-bottom: 1px solid #f0f0f0; padding-bottom: 8px;
    }
    .word-bank-title{
      font-weight:700; color:#2c2f44; display:flex; align-items:center; gap:8px; font-size: 1.05rem;
    }
    .word-bank-count{ color:var(--gray); font-size:.9rem; background: #f0f0f0; padding: 2px 8px; border-radius: 4px;}

    .word-bank-list{
      display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
      gap:10px; max-height:240px; overflow-y:auto; padding-right:4px;
    }
    /* Custom Scrollbar */
    .word-bank-list::-webkit-scrollbar { width: 6px; }
    .word-bank-list::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }

    .bank-item{
      background: #fcfcfc; border:1px solid #eef0f5; border-radius:10px;
      padding:10px 12px; transition:var(--transition);
      display:flex; flex-direction:column; gap:2px;
      cursor:pointer; position: relative;
    }
    .bank-item:hover{
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(0,0,0,0.05);
      border-color:var(--primary-light);
      background: #fff;
    }
    .bank-item.active-item {
      border-color: var(--primary);
      background: #f4f3ff;
    }
    .bank-word{ font-weight:700; color:#1f2133; font-size: 0.95rem; }
    .bank-pos{ font-size:.8rem; color:var(--gray); }

    /* ===== Study / Review shared card ===== */
    .study-area, .review-area, .quiz-area{ display:none; animation: fadeIn 0.4s ease; }
    .study-area.active, .review-area.active, .quiz-area.active{ display:block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .singlecard-container{
      display:flex; flex-direction:column; align-items:center; gap:16px;
      padding:10px 0;
    }
    .word-card{
      width:100%; max-width:580px; height:340px; perspective:1000px;
      cursor:pointer; position: relative;
    }
    .card-inner{
      position:relative; width:100%; height:100%; text-align:center;
      transition:transform .6s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-style:preserve-3d;
    }
    .word-card.flipped .card-inner{ transform:rotateY(180deg); }
    .card-front,.card-back{
      position:absolute; width:100%; height:100%; backface-visibility:hidden;
      display:flex; flex-direction:column; justify-content:center; align-items:center;
      padding:30px; border-radius:24px; box-shadow:var(--shadow);
    }
    .card-front{
      background:linear-gradient(135deg, #6C63FF 0%, #4834d4 100%);
      color:#fff;
    }
    .card-front::after {
        content: ''; position: absolute; top:0; left:0; right:0; bottom:0;
        background: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMiIgY3k9IjIiIHI9IjIiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4wNSkiLz48L3N2Zz4=');
        opacity: 0.3;
    }

    .card-back{
      background:#fff; color:var(--dark); transform:rotateY(180deg);
      border: 1px solid rgba(0,0,0,0.05);
    }
    
    .word{ font-size:2.4rem; font-weight:800; margin-bottom:4px; letter-spacing: -0.5px; z-index: 2;}
    .pos{ font-size:1rem; font-style:italic; margin-bottom:12px; opacity:0.8; font-weight: 500; z-index: 2;}
    .meaning{ font-size:1.6rem; font-weight:700; margin-bottom:16px; color: #6C63FF; }
    .example-box {
      background: #f8f9fa; padding: 12px; border-radius: 12px; width: 100%; text-align: left;
    }
    .example{ font-size:1rem; font-style:italic; color:#495057; margin-bottom:6px; line-height: 1.4; }
    .example-translation{ color:#868e96; font-size:0.9rem; }

    .tts-row{
      display:flex; gap:12px; align-items:center; margin-top:16px; flex-wrap:wrap;
      z-index: 2;
    }
    .card-front .tts-row { color: rgba(255,255,255,0.9); }
    .card-back .tts-row{ justify-content:center; }

    .tts-btn{
      background:rgba(255,255,255,0.2); border:none; color:inherit; 
      width: 40px; height: 40px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size:1.2rem; cursor:pointer; transition:var(--transition);
    }
    .card-back .tts-btn { background: #e9ecef; color: var(--primary); }
    .tts-btn:hover{ transform:scale(1.1); background: rgba(255,255,255,0.3); }
    .card-back .tts-btn:hover { background: var(--primary); color: white; }

    .card-controls{
      display:flex; gap:12px; margin-top:8px; flex-wrap:wrap; justify-content:center;
    }
    .nav-btn{
      padding:10px 20px;
      background:#fff; color:var(--dark); border:1px solid #dcdde1; border-radius:999px;
      cursor:pointer; transition:var(--transition);
      font-weight:700; display:flex; align-items:center; gap:8px;
    }
    .nav-btn:hover{ background:var(--gray-light); transform:translateY(-2px); border-color: #b2bec3; }
    .nav-btn.primary-action { background: var(--primary); color: white; border-color: var(--primary); }
    .nav-btn.primary-action:hover { background: var(--primary-light); }
    .nav-btn:disabled{
      opacity: 0.5; cursor:not-allowed; transform:none;
    }

    /* ===== Review extras ===== */
    .review-stats{
      width:100%; max-width:580px;
      background:#fff; border-radius:14px; box-shadow:var(--shadow);
      padding:12px 20px; display:flex; justify-content:space-between; align-items:center; gap:8px;
      flex-wrap:wrap;
      font-weight:700; color:#2c2f44;
    }
    .review-rate{ color:var(--success); font-weight: 800; }
    .review-actions{ display:flex; gap:12px; flex-wrap:wrap; justify-content:center; width: 100%; margin-top: 10px; }
    .know-btn{
      border:none; background:#d4edda; color:#155724; padding: 12px 30px; border-radius: 12px; font-size: 1rem;
    }
    .unsure-btn{
      border:none; background:#fff3cd; color:#856404; padding: 12px 30px; border-radius: 12px; font-size: 1rem;
    }
    .know-btn:hover{ background:#c3e6cb; transform: translateY(-2px); }
    .unsure-btn:hover{ background:#ffeeba; transform: translateY(-2px); }

    /* ===== Quiz ===== */
    .quiz-settings{
      background:#fff; border-radius:16px; box-shadow:var(--shadow);
      padding:24px; margin-bottom:12px; max-width: 600px; margin: 0 auto;
    }
    .setting-group{ margin-bottom:16px; }
    .setting-label{
      font-weight:700; color:#2c2f44; display:block; margin-bottom:8px; font-size: 0.95rem;
    }
    .setting-select{
      width:100%; padding:12px; border-radius:12px; border:1px solid #d9dce6;
      font-family:"Poppins",sans-serif; font-size: 1rem;
      background: #f8f9fa;
    }
    .start-btn{
      width:100%; text-align:center; padding:14px; border:none; border-radius:12px;
      background:linear-gradient(135deg, #28A745 0%, #218838 100%); 
      color:#fff; font-weight:700; cursor:pointer; font-size: 1.1rem;
      transition:var(--transition); margin-top: 10px;
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }
    .start-btn:hover{ transform:translateY(-2px); box-shadow: 0 8px 16px rgba(40, 167, 69, 0.4); }

    .quiz-wrap{
      background:#fff; border-radius:16px; box-shadow:var(--shadow);
      padding:20px; display:none; max-width: 700px; margin: 0 auto;
    }
    .quiz-wrap.active{ display:block; }

    .quiz-progress{
      display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:12px;
      font-size:.9rem; color:var(--gray); font-weight:600;
    }
    .progress-bar{
      height:8px; background:#e9ecef; border-radius:999px; flex-grow:1; overflow:hidden;
      margin:0 10px;
    }
    .progress-fill{
      height:100%; width:0%; background:var(--primary); transition:width .3s ease;
      border-radius: 999px;
    }

    .quiz-question{
      padding:20px; border-radius:16px; background:#f8f9fa; border:1px solid #e9ecef;
    }
    .question-text{
      font-size:1.3rem; font-weight:800; margin-bottom:20px; color: var(--dark);
    }
    .options-container{
      display:grid; grid-template-columns:1fr 1fr; gap:12px;
    }
    .option{
      background:#fff; border-radius:12px; padding:16px;
      cursor:pointer; transition:var(--transition); font-weight:600; user-select:none;
      border: 2px solid transparent; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      color: #495057;
    }
    .option:hover{ border-color:var(--primary-light); color:var(--primary); transform:translateY(-2px); }
    .option.selected{ background:var(--primary); color:#fff; border-color:var(--primary); }

    .quiz-result{
      background:#fff; border-radius:16px; box-shadow:var(--shadow);
      padding:24px; text-align: center;
    }
    .wrong-list{ margin-top:20px; display:grid; gap:10px; text-align: left; }
    .wrong-item{
      background:#fff0f3; padding:12px 16px; border-radius:12px; border-left: 4px solid var(--secondary);
    }
    .wrong-item .w-word{ font-weight:800; color:var(--dark); margin-bottom:4px; font-size: 1.1rem; }

    .hidden{ display:none; }

    /* ===== RWD ===== */
    @media (max-width: 900px){
      header{ padding: 16px; }
      .header-top { justify-content: center; text-align: center; }
      .header-actions{ width:100%; justify-content:center; }
      .options-container{ grid-template-columns:1fr; }
    }
    @media (max-width: 600px){
      .chapters-grid{ grid-template-columns:1fr; }
      .word-bank-list{ grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); }
      .word{ font-size:2rem; }
      .word-card{ height:380px; }
      .card-front, .card-back { padding: 20px; }
    }
  </style>
</head>

<body>
<div class="container">

  <header>
    <div class="header-top">
      <div class="title-block">
        <h1>Shirley's TOEIC Vocab Master</h1>
        <p>Your Ultimate Learning Companion</p>
      </div>

      <div class="header-actions">
        <button class="btn secondary" id="back-home-btn" style="display:none;">
          <i class="fa-solid fa-arrow-left"></i> Back
        </button>

        <button class="btn active" data-mode="study">
          <i class="fa-solid fa-book-open"></i> Study
        </button>
        <button class="btn" data-mode="review">
          <i class="fa-solid fa-arrows-rotate"></i> Review
        </button>
        <button class="btn" data-mode="quiz">
          <i class="fa-solid fa-list-check"></i> Quiz
        </button>
      </div>
    </div>

    <div class="search-row">
      <input type="text" class="search-input" id="search-input" placeholder="Search any word (English or Chinese)...">
      <i class="fa-solid fa-magnifying-glass search-icon"></i>
      <div class="search-hint" id="search-hint">Searching Global Database...</div>
    </div>
  </header>

  <div class="loading" id="loading">
    <i class="fas fa-spinner fa-spin"></i>
    Loading vocabulary data...
  </div>

  <section id="home-view" class="hidden">
    <div class="chapters-grid" id="chapters-grid"></div>
  </section>

  <section id="category-view">
    <div class="category-header">
      <div class="category-title" id="category-title">Category</div>
      <div class="subchips" id="subchips"></div>
    </div>

    <div class="word-bank">
      <div class="word-bank-header">
        <div class="word-bank-title"><i class="fa-solid fa-layer-group"></i> Word List</div>
        <div class="word-bank-count" id="bank-count">0</div>
      </div>
      <div class="word-bank-list" id="bank-list"></div>
    </div>

    <div class="study-area active" id="study-area">
      <div class="singlecard-container">
        <div class="word-card" id="study-card">
          <div class="card-inner">
            <div class="card-front"></div>
            <div class="card-back"></div>
          </div>
        </div>
        <div class="card-controls">
          <button class="nav-btn" id="study-prev-btn"><i class="fa-solid fa-chevron-left"></i> Prev</button>
          <button class="nav-btn primary-action" id="study-flip-btn"><i class="fa-solid fa-repeat"></i> Flip</button>
          <button class="nav-btn" id="study-next-btn">Next <i class="fa-solid fa-chevron-right"></i></button>
        </div>
      </div>
    </div>

    <div class="review-area" id="review-area">
      <div class="singlecard-container">
        <div class="review-stats">
          <div>Retention: <span class="review-rate" id="review-rate">0%</span></div>
          <div id="review-count">0 / 0 marked</div>
        </div>

        <div class="word-card" id="review-card">
          <div class="card-inner">
            <div class="card-front"></div>
            <div class="card-back"></div>
          </div>
        </div>

        <div class="review-actions">
          <button class="know-btn" id="know-btn"><i class="fa-solid fa-check"></i> I Know This</button>
          <button class="unsure-btn" id="unsure-btn"><i class="fa-solid fa-question"></i> Not Sure</button>
        </div>

        <div class="card-controls">
          <button class="nav-btn" id="review-prev-btn"><i class="fa-solid fa-chevron-left"></i> Prev</button>
          <button class="nav-btn primary-action" id="review-flip-btn"><i class="fa-solid fa-repeat"></i> Flip</button>
          <button class="nav-btn" id="review-next-btn">Next <i class="fa-solid fa-chevron-right"></i></button>
        </div>
      </div>
    </div>

    <div class="quiz-area" id="quiz-area">
      <div class="quiz-settings" id="quiz-settings">
        <h2 style="text-align:center; margin-bottom:20px; color:var(--primary);">Quiz Settings</h2>
        
        <div class="setting-group">
          <label class="setting-label">Quiz Mode</label>
          <select class="setting-select" id="quiz-mode-select">
            <option value="mix-all">üî• Mix All Chapters</option>
            <option value="mix-chapter">üìÇ Specific Chapter</option>
            <option value="precise">üéØ Chapter & Subchapter</option>
            <option value="unsure">üß† Review 'Not Sure' Words</option>
          </select>
        </div>

        <div class="setting-group" id="quiz-chapter-setting">
          <label class="setting-label">Select Chapter</label>
          <select class="setting-select" id="quiz-chapter-select"></select>
        </div>

        <div class="setting-group hidden" id="quiz-sub-setting">
          <label class="setting-label">Select Subchapter</label>
          <select class="setting-select" id="quiz-subchapter-select"></select>
        </div>

        <div class="setting-group">
          <label class="setting-label">Question Count</label>
          <select class="setting-select" id="quiz-count-select">
            <option value="10">10 Questions</option>
            <option value="20">20 Questions</option>
            <option value="50">50 Questions</option>
            <option value="all">All Available</option>
          </select>
        </div>

        <button class="start-btn" id="start-quiz-btn">Start Challenge</button>
      </div>

      <div class="quiz-wrap" id="quiz-wrap">
        <div class="quiz-progress">
          <span id="progress-text">1 / 10</span>
          <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
          <span id="answered-text">0/0</span>
        </div>

        <div class="quiz-question">
          <div class="question-text" id="question-text"></div>
          <div class="options-container" id="options-container"></div>
        </div>
      </div>
    </div>

  </section>

</div>

<script>
  // ================= CSV URL =================
  // ‰ΩøÁî®ÊÇ®ÂéüÊú¨ÁöÑ CSV ‰æÜÊ∫ê
  const CSV_URL = 'https://raw.githubusercontent.com/ducj-creator/Shirley-Grammar/main/TOEIC%20vocab.csv';

  // ================= DOM =================
  const loadingEl = document.getElementById('loading');
  const homeView = document.getElementById('home-view');
  const chaptersGrid = document.getElementById('chapters-grid');

  const categoryView = document.getElementById('category-view');
  const categoryTitle = document.getElementById('category-title');
  const subchipsEl = document.getElementById('subchips');

  const bankCountEl = document.getElementById('bank-count');
  const bankListEl = document.getElementById('bank-list');

  const modeBtns = document.querySelectorAll('.header-actions .btn[data-mode]');
  const backHomeBtn = document.getElementById('back-home-btn');
  const searchInput = document.getElementById('search-input');
  const searchHint = document.getElementById('search-hint');

  const studyArea = document.getElementById('study-area');
  const reviewArea = document.getElementById('review-area');
  const quizArea = document.getElementById('quiz-area');

  // Study elements
  const studyCard = document.getElementById('study-card');
  const studyFlipBtn = document.getElementById('study-flip-btn');
  const studyPrevBtn = document.getElementById('study-prev-btn');
  const studyNextBtn = document.getElementById('study-next-btn');

  // Review elements
  const reviewCard = document.getElementById('review-card');
  const reviewFlipBtn = document.getElementById('review-flip-btn');
  const reviewPrevBtn = document.getElementById('review-prev-btn');
  const reviewNextBtn = document.getElementById('review-next-btn');
  const knowBtn = document.getElementById('know-btn');
  const unsureBtn = document.getElementById('unsure-btn');
  const reviewRateEl = document.getElementById('review-rate');
  const reviewCountEl = document.getElementById('review-count');

  // Quiz elements
  const quizSettings = document.getElementById('quiz-settings');
  const quizWrap = document.getElementById('quiz-wrap');
  const quizModeSelect = document.getElementById('quiz-mode-select');
  const quizChapterSelect = document.getElementById('quiz-chapter-select');
  const quizSubSetting = document.getElementById('quiz-sub-setting');
  const quizSubchapterSelect = document.getElementById('quiz-subchapter-select');
  const quizChapterSetting = document.getElementById('quiz-chapter-setting');
  const quizCountSelect = document.getElementById('quiz-count-select');
  const startQuizBtn = document.getElementById('start-quiz-btn');

  const progressText = document.getElementById('progress-text');
  const answeredText = document.getElementById('answered-text');
  const progressFill = document.getElementById('progress-fill');
  const questionText = document.getElementById('question-text');
  const optionsContainer = document.getElementById('options-container');

  // ================= STATE =================
  let vocabularyData = null;
  let allWordsFlat = []; // ÁÇ∫‰∫ÜÊêúÂ∞ãÂäüËÉΩÔºåÂª∫Á´ã‰∏ÄÂÄãÊâÅÂπ≥ÂåñÁöÑÂñÆÂ≠óÂàóË°®

  let currentChapter = null;
  let currentSubchapter = 'ALL';
  let currentMode = 'study';
  
  let isSearchMode = false; // ÊòØÂê¶ËôïÊñºÊêúÂ∞ãÊ®°Âºè

  let currentWords = []; // ÁõÆÂâçÊ≠£Âú®Â≠∏Áøí/Ë§áÁøíÁöÑÂñÆÂ≠óÂàóË°® (ÂèØËÉΩÊòØÊüêÁ´†ÁØÄÔºå‰πüÂèØËÉΩÊòØÊêúÂ∞ãÁµêÊûú)
  let currentWordIndex = 0;

  // Review tracking
  const reviewStatsByChapter = new Map(); 
  const globalUnsureKeys = new Set();
  // We'll use a special key "SEARCH_RESULTS" for stats in search mode, though stats are usually per-chapter.
  // In search mode, marking words will update their respective chapter stats.

  // Quiz State
  let quizQuestionsData = [];
  let quizAnswers = [];
  let quizIndex = 0;
  let quizFinished = false;

  // ================= INIT =================
  async function init(){
    try {
      const results = await loadCSVData();
      vocabularyData = results;
      // Build flat list for search
      allWordsFlat = [];
      vocabularyData.chapters.forEach(ch => {
        ch.words.forEach(w => allWordsFlat.push(w));
      });
    } catch (e){
      console.error('Error loading data', e);
      loadingEl.textContent = "Failed to load data. Please check connection.";
      return;
    }

    renderHome();
    renderQuizChapterOptions();
    setupEvents();

    loadingEl.classList.add('hidden');
    homeView.classList.remove('hidden');
  }

  async function loadCSVData(){
    return new Promise((resolve, reject)=>{
      Papa.parse(CSV_URL,{
        download:true, header:true, skipEmptyLines:true,
        complete:(results)=>{
          if(results.errors?.length) return reject(results.errors[0]);
          if(!results.data?.length) return reject('empty csv');
          resolve(processCSVData(results.data));
        },
        error:reject
      });
    });
  }

  function processCSVData(csvData){
    const chaptersMap = new Map();
    const pick = (row, keys) => {
      for(const k of keys){
        if(row[k]!=null && String(row[k]).trim()!=='') return String(row[k]).trim();
      }
      return '';
    };

    csvData.forEach(row=>{
      const chapterName = pick(row,['chapter','Chapter','CHAPTER']);
      const subchapterName = pick(row,['subchapter','Subchapter','SUBCHAPTER']);
      const wordText = pick(row,['word','Word','WORD']);
      if(!chapterName || !wordText) return;

      if(!chaptersMap.has(chapterName)){
        chaptersMap.set(chapterName,{
          id:chapterName,
          title:chapterName,
          subchapters:new Map(),
          words:[]
        });
      }

      const ch = chaptersMap.get(chapterName);

      if(subchapterName && !ch.subchapters.has(subchapterName)){
        ch.subchapters.set(subchapterName,{id:subchapterName, title:subchapterName});
      }

      ch.words.push({
        chapter:chapterName,
        subchapter:subchapterName,
        word:wordText,
        pos:pick(row,['pos','Part of Speech','POS']),
        meaning:pick(row,['meaning','Meaning']),
        example:pick(row,['english sentence','Example Sentence','example','sentence']),
        exampleTranslation:pick(row,['chinese sentence','Example Translation','translation']),
        pronunciation:pick(row,['pronunciation','Pronunciation'])
      });
    });

    const chapters = Array.from(chaptersMap.values()).map(ch=>{
      ch.subchapters = Array.from(ch.subchapters.values());
      return ch;
    });

    return {chapters};
  }

  // ================= UI RENDER =================
  function renderHome(){
    isSearchMode = false;
    searchInput.value = ''; // Clear search
    chaptersGrid.innerHTML = '';

    vocabularyData.chapters.forEach(ch=>{
      const card = document.createElement('div');
      card.className = 'chapter-card';
      const emoji = getChapterEmoji(ch.title);
      card.innerHTML = `
        <div>
          <div class="emoji">${emoji}</div>
          <h3>${ch.title}</h3>
        </div>
        <div class="chapter-meta">
          <span class="chip"><i class="fa-solid fa-book"></i> ${ch.words.length}</span>
          <span class="chip"><i class="fa-regular fa-folder-open"></i> ${ch.subchapters.length}</span>
        </div>
      `;
      card.addEventListener('click', ()=> enterCategory(ch.id));
      chaptersGrid.appendChild(card);
    });

    homeView.classList.remove('hidden');
    categoryView.classList.remove('active');
    backHomeBtn.style.display = 'none';
  }

  function enterCategory(chapterId){
    currentChapter = vocabularyData.chapters.find(c=>c.id===chapterId);
    if(!currentChapter) return;
    
    isSearchMode = false;
    currentSubchapter = 'ALL';
    
    // UI Update
    categoryTitle.innerHTML = `${getChapterEmoji(currentChapter.title)} ${currentChapter.title}`;
    subchipsEl.style.display = 'flex';
    backHomeBtn.style.display = 'flex';

    renderSubchips();
    loadWordsForCategory(); // Loads words from chapter
    renderWordBank();

    renderStudyCard();
    renderReviewCard();
    updateReviewStatsUI();

    homeView.classList.add('hidden');
    categoryView.classList.add('active');

    // If we are in quiz mode, we might want to stay in quiz settings, but usually entering a category defaults to study
    if(currentMode === 'quiz') switchMode('study'); // Default to study when entering
    else switchMode(currentMode);
  }

  // === SEARCH FUNCTIONALITY ===
  function handleSearch(e) {
    const query = e.target.value.trim().toLowerCase();
    
    if (query.length === 0) {
      if(isSearchMode) renderHome(); // Exit search mode if empty
      return;
    }

    isSearchMode = true;
    
    // Filter ALL words
    const results = allWordsFlat.filter(w => 
      w.word.toLowerCase().includes(query) || 
      (w.meaning && w.meaning.includes(query))
    );

    // Switch View to Category View (reused for search results)
    homeView.classList.add('hidden');
    categoryView.classList.add('active');
    backHomeBtn.style.display = 'flex';

    // Update Header for Search Context
    categoryTitle.innerHTML = `<span style="color:var(--primary)"><i class="fa-solid fa-magnifying-glass"></i> Search: "${e.target.value}"</span>`;
    subchipsEl.style.display = 'none'; // Hide subchapters in search mode

    // Update Data
    currentWords = results;
    currentWordIndex = 0;

    renderWordBank();
    if(currentWords.length > 0) {
        renderStudyCard();
        renderReviewCard();
    } else {
        // Handle empty results
        studyCard.querySelector('.card-front').innerHTML = '<div style="color:#ccc">No matches found.</div>';
    }
    
    // In search mode, review stats are tricky, maybe just hide or show "Global" ?
    // For now, let's just reset stats UI to empty or handle gracefully
    reviewRateEl.textContent = "-";
    reviewCountEl.textContent = "Search Mode";
  }

  function renderSubchips(){
    subchipsEl.innerHTML = '';
    const allChip = makeSubchip('ALL','All Words', currentChapter.words.length, true);
    subchipsEl.appendChild(allChip);

    currentChapter.subchapters.forEach(sub=>{
      const count = currentChapter.words.filter(w=>w.subchapter===sub.id).length;
      const chip = makeSubchip(sub.id, sub.title, count);
      subchipsEl.appendChild(chip);
    });
  }

  function makeSubchip(id, label, count, active=false){
    const chip = document.createElement('div');
    chip.className = `subchip ${active?'active':''}`;
    chip.dataset.subId = id;
    chip.innerHTML = `${label} <span style="opacity:0.7; font-size:0.8em; margin-left:4px;">(${count})</span>`;
    chip.addEventListener('click', ()=>{
      document.querySelectorAll('.subchip').forEach(c=>c.classList.remove('active'));
      chip.classList.add('active');
      currentSubchapter = id;
      loadWordsForCategory();
      renderWordBank();

      currentWordIndex = 0;
      if(currentMode==='study') renderStudyCard();
      if(currentMode==='review') renderReviewCard();
    });
    return chip;
  }

  function loadWordsForCategory(){
    if(currentSubchapter==='ALL'){
      currentWords = [...currentChapter.words];
    } else {
      currentWords = currentChapter.words.filter(w=>w.subchapter===currentSubchapter);
    }
    currentWordIndex = 0;
  }

  function renderWordBank(){
    bankListEl.innerHTML = '';
    bankCountEl.textContent = `${currentWords.length}`;

    if(currentWords.length === 0){
        bankListEl.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:var(--gray); padding:20px;">No words found.</div>`;
        return;
    }

    currentWords.forEach((w, idx)=>{
      const item = document.createElement('div');
      item.className = 'bank-item';
      if(idx === currentWordIndex) item.classList.add('active-item');
      
      item.innerHTML = `
        <div class="bank-word">${w.word}</div>
        <div class="bank-pos">${w.meaning}</div> 
      `;
      // Show meaning in bank for easier searching visual
      
      item.addEventListener('click', ()=>{
        currentWordIndex = idx;
        // Highlight active
        document.querySelectorAll('.bank-item').forEach(b=>b.classList.remove('active-item'));
        item.classList.add('active-item');

        if(currentMode==='study'){
          renderStudyCard();
          // studyArea.scrollIntoView({behavior:'smooth', block:'center'});
        } else if(currentMode==='review'){
          renderReviewCard();
        }
      });
      bankListEl.appendChild(item);
    });
  }

  // ================= STUDY =================
  function renderStudyCard(){
    if(!currentWords.length) return;
    const w = currentWords[currentWordIndex];
    const front = studyCard.querySelector('.card-front');
    const back = studyCard.querySelector('.card-back');

    // Update active state in list
    document.querySelectorAll('.bank-item').forEach((b,i)=>{
        if(i===currentWordIndex) b.classList.add('active-item');
        else b.classList.remove('active-item');
    });

    front.innerHTML = `
      <div class="word">${w.word}</div>
      <div class="pos">${w.pos||''}</div>
      <div class="meaning" style="color:#fff; opacity:0; height:0; overflow:hidden;">${w.meaning}</div>
      <div class="tts-row">
        <button class="tts-btn" title="Pronounce word"><i class="fas fa-volume-high"></i></button>
      </div>
      <div style="position:absolute; bottom:20px; font-size:.9rem; opacity:.7;">Tap to Flip</div>
    `;

    back.innerHTML = `
      <div class="word" style="font-size:1.8rem; color:var(--primary)">${w.word}</div>
      <div class="meaning">${w.meaning||''}</div>
      <div class="example-box">
          <div class="example">${w.example||'No example available'}</div>
          <div class="example-translation">${w.exampleTranslation||''}</div>
      </div>
      <div class="tts-row">
        <button class="tts-btn" title="Pronounce example"><i class="fas fa-volume-high"></i></button>
      </div>
    `;

    studyCard.classList.remove('flipped');

    studyPrevBtn.disabled = currentWordIndex===0;
    studyNextBtn.disabled = currentWordIndex===currentWords.length-1;

    front.querySelector('.tts-btn').addEventListener('click',(e)=>{
      e.stopPropagation(); speak(w.word);
    });
    back.querySelector('.tts-btn').addEventListener('click',(e)=>{
      e.stopPropagation(); speak(w.example || w.word);
    });
  }

  function studyPrev(){ if(currentWordIndex>0){ currentWordIndex--; renderStudyCard(); } }
  function studyNext(){ if(currentWordIndex<currentWords.length-1){ currentWordIndex++; renderStudyCard(); } }

  // ================= REVIEW (ÂñÆÂç°) =================
  function currentWordKey(w){
    return `${w.chapter}|||${w.subchapter||''}|||${w.word}`; 
  }

  function getReviewStats(chapterId){
    if(!reviewStatsByChapter.has(chapterId)){
      reviewStatsByChapter.set(chapterId,{
        known:new Set(),
        unsure:new Set()
      });
    }
    return reviewStatsByChapter.get(chapterId);
  }

  function renderReviewCard(){
    if(!currentWords.length) return;
    const w = currentWords[currentWordIndex];
    const front = reviewCard.querySelector('.card-front');
    const back = reviewCard.querySelector('.card-back');

    front.innerHTML = `
      <div class="word">${w.word}</div>
      <div class="pos">${w.pos||''}</div>
      <div class="tts-row">
        <button class="tts-btn" title="Pronounce word"><i class="fas fa-volume-high"></i></button>
      </div>
      <div style="position:absolute; bottom:20px; font-size:.9rem; opacity:.7;">Tap to Check Meaning</div>
    `;

    back.innerHTML = `
      <div class="meaning" style="font-size:2rem;">${w.meaning||''}</div>
      <div class="word" style="font-size:1.2rem; color:var(--gray); margin-bottom:10px;">${w.word}</div>
      <div class="example-box">
          <div class="example">${w.example||''}</div>
          <div class="example-translation">${w.exampleTranslation||''}</div>
      </div>
      <div class="tts-row">
        <button class="tts-btn" title="Pronounce"><i class="fas fa-volume-high"></i></button>
      </div>
    `;

    reviewCard.classList.remove('flipped');

    reviewPrevBtn.disabled = currentWordIndex===0;
    reviewNextBtn.disabled = currentWordIndex===currentWords.length-1;

    front.querySelector('.tts-btn').addEventListener('click',(e)=>{
      e.stopPropagation(); speak(w.word);
    });
    back.querySelector('.tts-btn').addEventListener('click',(e)=>{
      e.stopPropagation(); speak(w.example || w.word);
    });
  }

  function reviewPrev(){ if(currentWordIndex>0){ currentWordIndex--; renderReviewCard(); } }
  function reviewNext(){ if(currentWordIndex<currentWords.length-1){ currentWordIndex++; renderReviewCard(); } }

  function markKnow(){
    if(!currentWords.length) return;
    const w=currentWords[currentWordIndex];
    // In search mode, find which chapter this word belongs to
    const chId = w.chapter; 
    const stats=getReviewStats(chId);
    const key=currentWordKey(w);

    stats.known.add(key);
    stats.unsure.delete(key);
    globalUnsureKeys.delete(key);

    flashButton(knowBtn);
    if(!isSearchMode) updateReviewStatsUI(); 
    
    if(currentWordIndex < currentWords.length-1){
      currentWordIndex++;
      renderReviewCard();
    }
  }

  function markUnsure(){
    if(!currentWords.length) return;
    const w=currentWords[currentWordIndex];
    const chId = w.chapter; 
    const stats=getReviewStats(chId);
    const key=currentWordKey(w);

    stats.unsure.add(key);
    stats.known.delete(key);
    globalUnsureKeys.add(key);

    flashButton(unsureBtn);
    if(!isSearchMode) updateReviewStatsUI();

    if(currentWordIndex < currentWords.length-1){
      currentWordIndex++;
      renderReviewCard();
    }
  }

  function updateReviewStatsUI(){
    if(isSearchMode || !currentChapter) return;
    const stats=getReviewStats(currentChapter.id);
    const knownCount=stats.known.size;
    const unsureCount=stats.unsure.size;
    const marked=knownCount+unsureCount;

    const rate = marked===0 ? 0 : Math.round((knownCount/marked)*100);
    reviewRateEl.textContent = `${rate}%`;
    reviewCountEl.textContent = `${marked} / ${currentChapter.words.length} marked`;
  }

  function flashButton(btn){
    btn.style.transform='scale(1.1)';
    setTimeout(()=>btn.style.transform='scale(1)',150);
  }

  // ================= QUIZ =================
  function renderQuizChapterOptions(){
    quizChapterSelect.innerHTML='';
    vocabularyData.chapters.forEach(ch=>{
      const opt = document.createElement('option');
      opt.value=ch.id; opt.textContent=ch.title;
      quizChapterSelect.appendChild(opt);
    });
    const allOpt = document.createElement('option');
    allOpt.value='all'; allOpt.textContent='All Chapters';
    quizChapterSelect.appendChild(allOpt);

    quizChapterSelect.value = currentChapter?.id || 'all';
    handleQuizChapterChange();
  }

  function handleQuizModeChange(){
    const mode=quizModeSelect.value;
    const show = (el) => el.classList.remove('hidden');
    const hide = (el) => el.classList.add('hidden');

    if(mode==='precise'){
      show(quizSubSetting); show(quizChapterSetting);
    }else if(mode==='mix-chapter'){
      hide(quizSubSetting); show(quizChapterSetting);
    }else if(mode==='unsure'){
      hide(quizSubSetting); hide(quizChapterSetting);
    }else{
      hide(quizSubSetting); hide(quizChapterSetting);
    }
  }

  function handleQuizChapterChange(){
    quizSubchapterSelect.innerHTML='';
    const chapterId = quizChapterSelect.value;
    if(chapterId==='all') return;

    const ch = vocabularyData.chapters.find(c=>c.id===chapterId);
    if(!ch) return;

    ch.subchapters.forEach(sub=>{
      const opt=document.createElement('option');
      opt.value=sub.id; opt.textContent=sub.title;
      quizSubchapterSelect.appendChild(opt);
    });
  }

  function startQuiz(){
    quizFinished=false;
    quizIndex=0;

    const mode = quizModeSelect.value;
    const chapterId = quizChapterSelect.value;
    const subId = quizSubchapterSelect.value;

    let pool=[];

    if(mode==='unsure'){
      pool = getUnsureWordsObjects();
      if(pool.length<4){
        alert('Unsure list is too small. Please mark more words as "Not Sure" in Review mode.');
        return;
      }
    } else if(mode==='mix-all' || (mode==='mix-chapter' && chapterId==='all')){
      vocabularyData.chapters.forEach(ch=>pool.push(...ch.words));
    } else if(mode==='mix-chapter'){
      const ch=vocabularyData.chapters.find(c=>c.id===chapterId);
      if(ch) pool=[...ch.words];
    } else if(mode==='precise'){
      const ch=vocabularyData.chapters.find(c=>c.id===chapterId);
      if(ch) pool=ch.words.filter(w=>w.subchapter===subId);
    }

    // Filter invalid
    pool = pool.filter(w=>w.word && w.meaning);
    if(pool.length<4){
      alert('Not enough words found in this category to generate a quiz (need at least 4).');
      return;
    }

    pool = shuffle(pool);

    let qCount = pool.length;
    if(quizCountSelect.value!=='all'){
      qCount = Math.min(Number(quizCountSelect.value), pool.length);
    }

    quizQuestionsData=[];
    for(let i=0;i<qCount;i++){
      const target=pool[i];
      const options=buildOptions(target, pool);
      const correctIndex=options.findIndex(o=>o.meaning===target.meaning);
      quizQuestionsData.push({wordObj:target, options, correctIndex});
    }
    quizAnswers = quizQuestionsData.map(()=>({selectedIndex:null}));

    quizSettings.style.display='none';
    quizWrap.classList.add('active');

    renderQuizQuestion();
    updateQuizUI();
    
    // Auto scroll
    quizWrap.scrollIntoView({behavior:'smooth'});
  }

  function getUnsureWordsObjects(){
    const list=[];
    vocabularyData.chapters.forEach(ch=>{
      ch.words.forEach(w=>{
        const key=currentWordKey(w);
        if(globalUnsureKeys.has(key)) list.push(w);
      });
    });
    return list;
  }

  function buildOptions(target, pool){
    // Distinct meanings
    const distractors = pool
      .filter(w=>w.meaning !== target.meaning) // Ensure meaning is different, not just word
      .map(w=>({meaning:w.meaning}))
      .filter((v,idx,arr)=>arr.findIndex(x=>x.meaning===v.meaning)===idx); // Unique meanings

    const picked=[];
    while(picked.length<3 && distractors.length){
      const r=Math.floor(Math.random()*distractors.length);
      picked.push(distractors.splice(r,1)[0]);
    }

    // If not enough unique distractors, fill with dummies (rare case)
    while(picked.length < 3) {
        picked.push({meaning: "Other meaning " + (picked.length+1)});
    }

    return shuffle([{meaning:target.meaning}, ...picked]);
  }

  function renderQuizQuestion(){
    const q=quizQuestionsData[quizIndex];
    const w=q.wordObj;

    questionText.innerHTML = `Meaning of <strong style="color:var(--primary)">${w.word}</strong> ?`;

    optionsContainer.innerHTML='';
    q.options.forEach((opt, idx)=>{
      const div=document.createElement('div');
      div.className='option';
      div.dataset.index=idx;
      div.innerHTML=`<span style="opacity:0.6; margin-right:8px;">${String.fromCharCode(65+idx)}.</span> ${opt.meaning}`;

      div.addEventListener('click', ()=>{
        if(quizFinished) return;
        quizAnswers[quizIndex].selectedIndex=idx;
        
        // Visual feedback
        document.querySelectorAll('.option').forEach(o=>o.classList.remove('selected'));
        div.classList.add('selected');

        setTimeout(()=>{
            if(quizIndex < quizQuestionsData.length-1){
              quizIndex++;
              renderQuizQuestion();
              updateQuizUI();
            } else {
              submitQuiz();
            }
        }, 300);
      });

      optionsContainer.appendChild(div);
    });
  }

  function submitQuiz(){
    const total=quizQuestionsData.length;
    quizFinished=true;

    let score=0;
    const wrongs=[];
    quizQuestionsData.forEach((q,i)=>{
      const sel=quizAnswers[i].selectedIndex;
      if(sel===q.correctIndex) score++;
      else {
          const yourAns = sel!==null ? q.options[sel].meaning : "No Answer";
          wrongs.push({
            idx:i+1, word:q.wordObj.word,
            meaning:q.wordObj.meaning, your:yourAns
          });
      }
    });

    showQuizResult(score,total,wrongs);
  }

  function showQuizResult(score,total,wrongs){
    quizWrap.innerHTML=`
      <div class="quiz-result">
        <h2 style="color:var(--primary); margin-bottom:10px;">üéâ Quiz Completed!</h2>
        <div style="font-size:3rem; font-weight:800; color:var(--dark); margin:10px 0;">
            ${score} <span style="font-size:1.5rem; color:var(--gray); font-weight:500;">/ ${total}</span>
        </div>
        <div style="width:100%; height:8px; background:#eee; border-radius:999px; margin:10px auto; max-width:300px; overflow:hidden;">
            <div style="width:${(score/total)*100}%; background:var(--success); height:100%;"></div>
        </div>
        
        <p style="color:var(--gray); margin-bottom:20px;">
          Accuracy: ${(score/total*100).toFixed(0)}%
        </p>

        ${wrongs.length===0 ? `
          <div style="padding:20px; background:#d4edda; color:#155724; border-radius:12px; margin-bottom:20px;">
            Perfect Score! You are a master! üèÜ
          </div>
        ` : `
          <h3 style="text-align:left; margin-bottom:10px;">Review Mistakes</h3>
          <div class="wrong-list">
            ${wrongs.map(w=>`
              <div class="wrong-item">
                <div class="w-word">${w.word}</div>
                <div style="color:var(--success); font-size:0.9rem;">‚úÖ Correct: ${w.meaning}</div>
                <div style="color:var(--danger); font-size:0.9rem;">‚ùå Yours: ${w.your}</div>
              </div>
            `).join('')}
          </div>
        `}

        <div style="display:flex; gap:12px; margin-top:24px; flex-wrap:wrap; justify-content:center;">
          <button class="nav-btn primary-action" id="restart-quiz-btn"><i class="fa-solid fa-rotate-right"></i> Try Again</button>
          <button class="nav-btn" id="back-quiz-settings-btn"><i class="fa-solid fa-gear"></i> Settings</button>
        </div>
      </div>
    `;

    document.getElementById('restart-quiz-btn').addEventListener('click', ()=>{
      resetQuizWrapDOM();
      startQuiz();
    });

    document.getElementById('back-quiz-settings-btn').addEventListener('click', ()=>{
      quizWrap.classList.remove('active');
      quizSettings.style.display='block';
      resetQuizWrapDOM();
    });
  }

  function resetQuizWrapDOM(){
    quizWrap.innerHTML=`
      <div class="quiz-progress">
        <span id="progress-text">1 / 10</span>
        <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
        <span id="answered-text">0/0</span>
      </div>

      <div class="quiz-question">
        <div class="question-text" id="question-text"></div>
        <div class="options-container" id="options-container"></div>
      </div>
    `;
    // rebind refs
    window.progressText  = document.getElementById('progress-text');
    window.answeredText  = document.getElementById('answered-text');
    window.progressFill  = document.getElementById('progress-fill');
    window.questionText  = document.getElementById('question-text');
    window.optionsContainer = document.getElementById('options-container');
  }

  function updateQuizUI(){
    const total=quizQuestionsData.length;
    const answered=quizAnswers.filter(a=>a.selectedIndex!==null).length;

    progressText.textContent=`Question ${quizIndex+1} / ${total}`;
    answeredText.textContent=`${answered} Answered`;
    progressFill.style.width=`${((quizIndex)/total)*100}%`;
  }

  // ================= MODE / NAV =================
  function switchMode(mode){
    currentMode=mode;
    modeBtns.forEach(b=>b.classList.remove('active'));
    document.querySelector(`.btn[data-mode="${mode}"]`)?.classList.add('active');

    studyArea.classList.remove('active');
    reviewArea.classList.remove('active');
    quizArea.classList.remove('active');

    if(mode==='study'){
      studyArea.classList.add('active');
      if(currentWords.length) renderStudyCard();
    } else if(mode==='review'){
      reviewArea.classList.add('active');
      if(currentWords.length){
        renderReviewCard();
        if(!isSearchMode) updateReviewStatsUI();
      }
    } else {
      quizArea.classList.add('active');
      renderQuizChapterOptions();
      quizWrap.classList.remove('active');
      quizSettings.style.display='block';
      handleQuizModeChange();
      handleQuizChapterChange();
    }
  }

  // ================= EVENTS / UTILS =================
  function setupEvents(){
    modeBtns.forEach(btn=>{
      btn.addEventListener('click', ()=> switchMode(btn.dataset.mode));
    });

    backHomeBtn.addEventListener('click', renderHome);
    searchInput.addEventListener('input', handleSearch);

    // study interactions
    studyCard.addEventListener('click', ()=> studyCard.classList.toggle('flipped'));
    studyFlipBtn.addEventListener('click', (e)=>{ e.stopPropagation(); studyCard.classList.toggle('flipped'); });
    studyPrevBtn.addEventListener('click', studyPrev);
    studyNextBtn.addEventListener('click', studyNext);

    // review interactions
    reviewCard.addEventListener('click', ()=> reviewCard.classList.toggle('flipped'));
    reviewFlipBtn.addEventListener('click', (e)=>{ e.stopPropagation(); reviewCard.classList.toggle('flipped'); });
    reviewPrevBtn.addEventListener('click', reviewPrev);
    reviewNextBtn.addEventListener('click', reviewNext);
    knowBtn.addEventListener('click', (e)=>{ e.stopPropagation(); markKnow(); });
    unsureBtn.addEventListener('click', (e)=>{ e.stopPropagation(); markUnsure(); });

    // quiz settings
    quizModeSelect.addEventListener('change', handleQuizModeChange);
    quizChapterSelect.addEventListener('change', handleQuizChapterChange);
    startQuizBtn.addEventListener('click', startQuiz);
  }

  function speak(text){
    if(!('speechSynthesis' in window)) return;
    window.speechSynthesis.cancel();
    const u=new SpeechSynthesisUtterance(text);
    u.lang='en-US'; u.rate=0.85;
    window.speechSynthesis.speak(u);
  }

  function shuffle(arr){
    const a=[...arr];
    for(let i=a.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  function getChapterEmoji(title){
    const t=title.toLowerCase();
    if(t.includes('admin')||t.includes('Ë°åÊîø')) return 'üóÇÔ∏è';
    if(t.includes('financ')||t.includes('Ë≤°Âãô')||t.includes('budget')) return 'üí∞';
    if(t.includes('market')||t.includes('Ë°åÈä∑')) return 'üì£';
    if(t.includes('meet')||t.includes('ÊúÉË≠∞')) return 'ü§ù';
    if(t.includes('travel')||t.includes('ÊóÖË°å')) return '‚úàÔ∏è';
    if(t.includes('office')||t.includes('Ëæ¶ÂÖ¨ÂÆ§')) return 'üè¢';
    if(t.includes('hr')||t.includes('‰∫∫‰∫ã')||t.includes('person')) return 'üë•';
    return 'üìò';
  }

  init();
</script>
</body>
</html>

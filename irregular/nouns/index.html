<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ä¸è¦å‰‡åè©äº’å‹•å­¸ç¿’å¹³å°</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    *{box-sizing:border-box;margin:0;padding:0}

    :root{
      /* èˆ‡ä¸è¦å‰‡å‹•è©å€éš”çš„é…è‰²ï¼šç¶ +æ©˜ */
      --primary:#16a085;      /* ç¶  */
      --primary-dark:#0e6f5f; /* æ·±ç¶  */
      --accent:#f39c12;       /* æ©˜ */
      --bg:#f4f7f6;
      --card:#ffffff;
      --muted:#6b7d84;
      --line:#e6eceb;
    }

    body{
      font-family:'Noto Sans TC',sans-serif;
      color:#223;
      background: linear-gradient(135deg, #f2fbf8 0%, #d8efe9 100%);
      min-height:100vh;
      padding:10px;
      line-height:1.5;
    }

    .container{max-width:1100px;margin:0 auto}

    header{
      text-align:center;
      margin-bottom:10px;
      padding:10px 12px;
      background:rgba(255,255,255,.95);
      border-radius:8px;
      box-shadow:0 2px 6px rgba(0,0,0,.06);
    }
    h1{
      font-size:1.35rem;
      color:#0a3d34;
      margin-bottom:4px;
      font-weight:700;
    }
    .description{
      font-size:.9rem;color:var(--muted)
    }

    .mode-selector{
      display:flex;justify-content:center;gap:6px;flex-wrap:wrap;margin:8px 0 10px;
    }
    .mode-btn{
      padding:6px 12px;
      background:var(--primary);
      color:#fff;border:0;border-radius:16px;
      cursor:pointer;font-size:.9rem;font-weight:600;
      transition:.2s;box-shadow:0 1px 3px rgba(0,0,0,.12);
    }
    .mode-btn:hover{transform:translateY(-1px)}
    .mode-btn.active{background:var(--primary-dark)}

    .content-area{
      background:var(--card);
      border-radius:8px;
      padding:10px;
      box-shadow:0 3px 10px rgba(0,0,0,.08);
      min-height:360px;
    }

    .section{display:none}
    .section.active{display:block}

    .section h2{
      font-size:1.15rem;margin-bottom:4px;color:#0a3d34;
    }
    .section p{
      font-size:.9rem;color:var(--muted);margin-bottom:8px;
    }

    .filter-options{
      display:flex;flex-wrap:wrap;gap:6px;margin:6px 0 8px;
    }
    .filter-btn{
      padding:5px 10px;background:#eef3f2;border:0;border-radius:12px;
      cursor:pointer;font-size:.85rem;transition:.2s;color:#244;
      white-space:nowrap;
    }
    .filter-btn.active{
      background:var(--primary);color:#fff;
    }

    .noun-list{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
      gap:6px;
      margin-bottom:8px;
    }
    .noun-item{
      padding:8px;background:#f8fbfa;border-radius:6px;cursor:pointer;text-align:center;
      border-left:3px solid var(--primary);
      transition:.2s;min-height:52px;display:flex;flex-direction:column;justify-content:center;
    }
    .noun-item:hover{background:#eef7f5;transform:translateY(-1px)}
    .noun-item small{color:var(--muted);font-size:.8rem;margin-top:2px}

    .noun-card{
      background:#fff;border-radius:8px;padding:10px;margin-top:6px;
      border-left:4px solid var(--primary);
      box-shadow:0 1px 4px rgba(0,0,0,.08);
    }
    .noun-header{
      display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;gap:8px;
    }
    .noun-header h3{font-size:1.1rem}
    .noun-category{
      padding:2px 8px;border-radius:10px;color:#fff;font-size:.75rem;font-weight:700;
      background:var(--accent);
      flex-shrink:0;
    }

    .noun-forms{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      gap:6px;margin-bottom:6px;
    }
    .noun-form{
      padding:6px;background:#f7faf9;border-radius:6px;
    }
    .noun-form h4{font-size:.8rem;color:var(--muted);margin-bottom:2px}
    .noun-form p{font-weight:700;font-size:.95rem;color:#0e2f2a;display:flex;align-items:center;gap:6px}

    .mask{
      display:inline-block;
      padding:2px 6px;border-radius:4px;background:#e9f3f1;color:#1b3b35;
      font-weight:700;letter-spacing:.5px;
    }

    .pronunciation-btn{
      background:none;border:none;color:var(--primary);cursor:pointer;font-size:.95rem;
    }

    .examples{margin-top:6px}
    .example-toggle{
      background:var(--primary);color:#fff;border:0;padding:5px 10px;border-radius:6px;
      cursor:pointer;font-size:.8rem;
    }
    .example{
      margin-top:6px;padding:6px;background:#f7faf9;border-radius:6px;font-size:.85rem;font-style:italic;
      display:flex;justify-content:space-between;gap:8px;align-items:flex-start;
    }
    .example strong{font-style:normal}

    /* Review: input row */
    .review-row{
      display:flex;gap:6px;align-items:center;flex-wrap:wrap;
      margin-top:4px;
    }
    .review-input{
      padding:6px 8px;border:1px solid #cfd9d6;border-radius:6px;font-size:.95rem;
      min-width:140px;
    }
    .review-btn{
      padding:6px 10px;border:0;border-radius:6px;cursor:pointer;font-size:.85rem;font-weight:600;
      background:#e9f3f1;color:#0f3a33;
    }
    .review-btn.primary{background:var(--primary);color:#fff}
    .review-feedback{
      font-size:.85rem;margin-top:4px;font-weight:700;
    }
    .ok{color:#1e7f4b}
    .bad{color:#c0392b}

    /* Quiz compact */
    .quiz-start{padding:8px;text-align:center}
    .quiz-container{padding:4px}
    .quiz-grid{
      display:grid;grid-template-columns:1fr;gap:6px;margin-top:6px;
    }
    .quiz-item{
      border:1px solid var(--line);border-radius:8px;padding:8px;background:#fbfdfc;
      display:grid;grid-template-columns:1fr auto;gap:6px;align-items:center;
    }
    .quiz-q{
      font-size:.95rem;font-weight:700;color:#113a33;
    }
    .quiz-q small{display:block;font-weight:500;color:var(--muted);margin-top:2px}
    .quiz-input{
      padding:6px 8px;border:1px solid #cfd9d6;border-radius:6px;font-size:.95rem;width:140px;
    }
    .quiz-submit{
      padding:8px 14px;background:var(--primary);color:#fff;border:0;border-radius:8px;
      cursor:pointer;font-size:.95rem;font-weight:700;margin-top:8px;
    }

    .quiz-result{
      margin-top:8px;padding:10px;background:#f7faf9;border-radius:8px;
    }
    .result-score{
      font-size:1.4rem;font-weight:800;color:#0b2d27;margin:6px 0;
    }
    .result-details{margin-top:8px}
    .result-item{
      padding:6px;border-bottom:1px dashed var(--line);font-size:.9rem;
    }
    .result-item.correct{background:#e7f7ef}
    .result-item.incorrect{background:#fdebec}

    .hidden{display:none}

    @media (min-width: 900px){
      .quiz-grid{grid-template-columns:1fr 1fr}
    }
    @media (max-width: 600px){
      .noun-list{grid-template-columns:repeat(auto-fill,minmax(120px,1fr))}
      .quiz-item{grid-template-columns:1fr}
      .quiz-input{width:100%}
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>Shirley's Irregular Nouns Learning Platform</h1>
      <p class="description">ä¸è¦å‰‡åè©äº’å‹•å­¸ç¿’å¹³å°ï¼šå­¸ç¿’ã€è¤‡ç¿’èˆ‡æ¸¬é©—åè©å–®è¤‡æ•¸ï¼ˆå«ç™¼éŸ³èˆ‡ä¾‹å¥ï¼‰</p>
    </header>

    <div class="mode-selector">
      <button class="mode-btn active" data-mode="learn">Study Mode å­¸ç¿’æ¨¡å¼</button>
      <button class="mode-btn" data-mode="review">Review Mode è¤‡ç¿’æ¨¡å¼</button>
      <button class="mode-btn" data-mode="quiz">Quiz Mode æ¸¬é©—æ¨¡å¼</button>
    </div>

    <div class="content-area">
      <!-- Learn -->
      <div class="section active" id="learn-section">
        <h2>å­¸ç¿’ä¸è¦å‰‡åè©</h2>
        <p>é»æ“Šåè©æŸ¥çœ‹ç´°ç¯€ï¼›ğŸ”Šå¯æ’­æ”¾ç™¼éŸ³</p>
        <div class="filter-options" id="learn-filters"></div>
        <div class="noun-list" id="learn-noun-list"></div>
        <div id="learn-noun-detail"></div>
      </div>

      <!-- Review -->
      <div class="section" id="review-section">
        <h2>è¤‡ç¿’ä¸è¦å‰‡åè©</h2>
        <p>Plural å…ˆé®ä½ï¼Œè«‹å…ˆè‡ªå·±å¯«ï¼Œå†ç¿»ç­”æ¡ˆ</p>
        <div class="filter-options" id="review-filters"></div>
        <div class="noun-list" id="review-noun-list"></div>
        <div id="review-noun-detail"></div>
      </div>

      <!-- Quiz -->
      <div class="section" id="quiz-section">
        <h2>ä¸è¦å‰‡åè©æ¸¬é©—</h2>

        <div class="quiz-start" id="quiz-start">
          <p>æ¸¬é©—èªªæ˜ï¼šè«‹å¯«å‡ºæ‰€çµ¦åè©çš„<strong>è¤‡æ•¸å½¢å¼</strong></p>
          <p>ç³»çµ±å°‡éš¨æ©ŸæŒ‘é¸ 10 é¡Œï¼Œæ¯é¡Œ 10 åˆ†ï¼Œæ»¿åˆ† 100 åˆ†</p>
          <button class="quiz-submit" id="start-quiz-btn">é–‹å§‹æ¸¬é©—</button>
        </div>

        <div class="quiz-container hidden" id="quiz-container">
          <div id="quiz-hint" class="quiz-q"></div>
          <div class="quiz-grid" id="quiz-grid"></div>
          <button class="quiz-submit" id="submit-quiz-btn">ä¸€æ¬¡æäº¤ç­”æ¡ˆ</button>
          <div class="quiz-result hidden" id="quiz-result"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* =======================
   CSV LOADER + PARSER
======================= */
const CSV_URL = "https://ducj-creator.github.io/Shirley-Grammar/irregular/nouns.csv";
let nouns = [];
let categoriesMap = new Map(); // num -> label

function parseCSV(text){
  // robust CSV parser (supports quotes)
  const rows = [];
  let i=0, field="", row=[], inQuotes=false;
  while(i < text.length){
    const c = text[i];
    if(inQuotes){
      if(c === '"' && text[i+1] === '"'){ field+='"'; i+=2; continue; }
      if(c === '"'){ inQuotes=false; i++; continue; }
      field += c; i++; continue;
    }else{
      if(c === '"'){ inQuotes=true; i++; continue; }
      if(c === ","){ row.push(field); field=""; i++; continue; }
      if(c === "\n"){
        row.push(field); field="";
        if(row.some(v=>v.trim()!=="")) rows.push(row);
        row=[]; i++; continue;
      }
      if(c === "\r"){ i++; continue; }
      field += c; i++; continue;
    }
  }
  row.push(field);
  if(row.some(v=>v.trim()!=="")) rows.push(row);
  return rows;
}

function findCol(headers, candidates){
  const lower = headers.map(h=>h.toLowerCase());
  for(const cand of candidates){
    const c = cand.toLowerCase();
    const idx = lower.findIndex(h=>h.includes(c));
    if(idx !== -1) return idx;
  }
  return -1;
}

async function loadNouns(){
  const res = await fetch(CSV_URL, {cache:"no-store"});
  if(!res.ok) throw new Error("CSV è®€å–å¤±æ•—ï¼š" + res.status);
  const text = await res.text();
  const table = parseCSV(text);
  if(table.length < 2) throw new Error("CSV å…§å®¹ç©ºç™½æˆ–æ ¼å¼ä¸ç¬¦");

  const headers = table[0];
  const idxCategory = findCol(headers, ["category", "åˆ†é¡"]);
  const idxSingular = findCol(headers, ["singular", "å–®æ•¸"]);
  const idxTC = findCol(headers, ["traditional chinese", "ä¸­æ–‡", "chinese"]);
  const idxSingSent = findCol(headers, ["singular sentence", "å–®æ•¸ä¾‹å¥", "v1 ä¾‹å¥"]);
  const idxPlural = findCol(headers, ["plural", "è¤‡æ•¸"]);
  const idxPluralSent = findCol(headers, ["plural sentence", "è¤‡æ•¸ä¾‹å¥"]);

  if([idxCategory, idxSingular, idxTC, idxPlural].some(i=>i===-1)){
    throw new Error("CSV æ¬„ä½åç¨±æ‰¾ä¸åˆ°ï¼Œè«‹ç¢ºèª header æ˜¯å¦ç‚º Category/Singular/Traditional Chinese/Plural ç­‰");
  }

  nouns = table.slice(1).map(r=>{
    const categoryRaw = (r[idxCategory] || "").trim();
    const numMatch = categoryRaw.match(/\d+/);
    const categoryNum = numMatch ? numMatch[0] : categoryRaw;

    // è¨˜ä½é¦–æ¬¡å‡ºç¾çš„ label
    if(categoryNum && !categoriesMap.has(categoryNum)){
      categoriesMap.set(categoryNum, categoryRaw || ("é¡åˆ¥ " + categoryNum));
    }

    return {
      categoryNum,
      categoryLabel: categoryRaw || ("é¡åˆ¥ " + categoryNum),
      singular: (r[idxSingular]||"").trim(),
      singular_chinese: (r[idxTC]||"").trim(),
      singular_sentence: (r[idxSingSent]||"").trim(),
      plural: (r[idxPlural]||"").trim(),
      plural_sentence: (r[idxPluralSent]||"").trim(),
    };
  }).filter(n=>n.singular && n.plural);
}

/* =======================
   APP INIT
======================= */
document.addEventListener("DOMContentLoaded", async () => {
  bindModeSwitch();

  try{
    await loadNouns();
    buildFilters();
    initLearnMode();
  }catch(err){
    showLoadError(err.message);
  }

  document.getElementById("start-quiz-btn").addEventListener("click", startQuiz);
  document.getElementById("submit-quiz-btn").addEventListener("click", submitQuiz);
});

function showLoadError(msg){
  const area = document.querySelector(".content-area");
  area.innerHTML = `
    <div style="padding:12px;color:#b3261e;font-weight:700;">
      è®€å– CSV å¤±æ•—ï¼š${msg}<br/>
      è«‹ç¢ºèª CSV ç¶²å€å¯é–‹å•Ÿã€æˆ–ç¨å¾Œå†è©¦ã€‚
    </div>
  `;
}

function bindModeSwitch(){
  const modeButtons = document.querySelectorAll(".mode-btn");
  const sections = document.querySelectorAll(".section");

  modeButtons.forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const mode = btn.dataset.mode;

      modeButtons.forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");

      sections.forEach(s=>s.classList.remove("active"));
      document.getElementById(`${mode}-section`).classList.add("active");

      if(mode==="learn") initLearnMode();
      if(mode==="review") initReviewMode();
      if(mode==="quiz") initQuizMode();
    });
  });
}

/* =======================
   FILTERS (dynamic)
======================= */
function buildFilters(){
  const learnFilters = document.getElementById("learn-filters");
  const reviewFilters = document.getElementById("review-filters");

  const orderedNums = Array.from(categoriesMap.keys()).sort((a,b)=>Number(a)-Number(b));

  const makeBtn = (num,label,container,mode)=>{
    const b=document.createElement("button");
    b.className="filter-btn";
    b.dataset.category=num;
    b.textContent=label;
    b.addEventListener("click", ()=>{
      container.querySelectorAll(".filter-btn").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      applyFilter(mode, num);
    });
    return b;
  };

  const allBtnL = document.createElement("button");
  allBtnL.className="filter-btn active";
  allBtnL.dataset.category="all"; allBtnL.textContent="å…¨éƒ¨";
  allBtnL.addEventListener("click", ()=>{
    learnFilters.querySelectorAll(".filter-btn").forEach(x=>x.classList.remove("active"));
    allBtnL.classList.add("active");
    applyFilter("learn","all");
  });
  learnFilters.innerHTML=""; learnFilters.appendChild(allBtnL);

  const allBtnR = allBtnL.cloneNode(true);
  allBtnR.addEventListener("click", ()=>{
    reviewFilters.querySelectorAll(".filter-btn").forEach(x=>x.classList.remove("active"));
    allBtnR.classList.add("active");
    applyFilter("review","all");
  });
  reviewFilters.innerHTML=""; reviewFilters.appendChild(allBtnR);

  orderedNums.forEach(num=>{
    const label = categoriesMap.get(num) || ("é¡åˆ¥ " + num);
    learnFilters.appendChild(makeBtn(num,label,learnFilters,"learn"));
    reviewFilters.appendChild(makeBtn(num,label,reviewFilters,"review"));
  });
}

function applyFilter(mode, category){
  const list = document.getElementById(`${mode}-noun-list`);
  list.querySelectorAll(".noun-item").forEach(item=>{
    const c = item.dataset.category;
    item.hidden = !(category==="all" || c===category);
  });
}

/* =======================
   LEARN MODE
======================= */
function initLearnMode(){
  const nounList = document.getElementById("learn-noun-list");
  nounList.innerHTML="";
  document.getElementById("learn-noun-detail").innerHTML="";

  nouns.forEach(noun=>{
    const item=document.createElement("div");
    item.className="noun-item";
    item.dataset.category=noun.categoryNum;
    item.innerHTML=`<div>${noun.singular}</div><small>${noun.singular_chinese}</small>`;
    item.addEventListener("click", ()=>showNounDetail("learn", noun));
    nounList.appendChild(item);
  });

  applyFilter("learn", document.querySelector("#learn-filters .filter-btn.active").dataset.category);
}

function showNounDetail(mode, noun){
  const detail=document.getElementById(`${mode}-noun-detail`);

  if(mode==="learn"){
    detail.innerHTML = makeLearnCard(noun);
    bindCardEvents(detail);
    return;
  }

  if(mode==="review"){
    detail.innerHTML = makeReviewCard(noun);
    bindCardEvents(detail);
    bindReviewEvents(detail, noun);
    return;
  }
}

function makeLearnCard(noun){
  return `
  <div class="noun-card">
    <div class="noun-header">
      <h3>${noun.singular} - ${noun.singular_chinese}</h3>
      <span class="noun-category">${noun.categoryLabel}</span>
    </div>

    <div class="noun-forms">
      <div class="noun-form">
        <h4>å–®æ•¸ (Singular)</h4>
        <p>${noun.singular}
          <button class="pronunciation-btn" data-word="${noun.singular}">ğŸ”Š</button>
        </p>
      </div>
      <div class="noun-form">
        <h4>è¤‡æ•¸ (Plural)</h4>
        <p>${noun.plural}
          <button class="pronunciation-btn" data-word="${noun.plural}">ğŸ”Š</button>
        </p>
      </div>
    </div>

    <div class="examples">
      <button class="example-toggle">é¡¯ç¤ºä¾‹å¥</button>
      <div class="example-content" style="display:none;">
        <div class="example">
          <div><strong>å–®æ•¸ä¾‹å¥:</strong> ${noun.singular_sentence || "â€”"}</div>
          <button class="pronunciation-btn" data-sentence="${noun.singular_sentence}">ğŸ”Š</button>
        </div>
        <div class="example">
          <div><strong>è¤‡æ•¸ä¾‹å¥:</strong> ${noun.plural_sentence || "â€”"}</div>
          <button class="pronunciation-btn" data-sentence="${noun.plural_sentence}">ğŸ”Š</button>
        </div>
      </div>
    </div>
  </div>`;
}

/* =======================
   REVIEW MODE (é®ç­”æ¡ˆ + è¼¸å…¥)
======================= */
function initReviewMode(){
  const nounList = document.getElementById("review-noun-list");
  nounList.innerHTML="";
  document.getElementById("review-noun-detail").innerHTML="";

  nouns.forEach(noun=>{
    const item=document.createElement("div");
    item.className="noun-item";
    item.dataset.category=noun.categoryNum;
    item.innerHTML=`<div>${noun.singular}</div><small>${noun.singular_chinese}</small>`;
    item.addEventListener("click", ()=>showNounDetail("review", noun));
    nounList.appendChild(item);
  });

  applyFilter("review", document.querySelector("#review-filters .filter-btn.active").dataset.category);
}

function makeReviewCard(noun){
  return `
  <div class="noun-card">
    <div class="noun-header">
      <h3>${noun.singular} - ${noun.singular_chinese}</h3>
      <span class="noun-category">${noun.categoryLabel}</span>
    </div>

    <div class="noun-forms">
      <div class="noun-form">
        <h4>å–®æ•¸ (Singular)</h4>
        <p>${noun.singular}
          <button class="pronunciation-btn" data-word="${noun.singular}">ğŸ”Š</button>
        </p>
      </div>

      <div class="noun-form">
        <h4>è¤‡æ•¸ (Plural) å…ˆè‡ªå·±å¯«</h4>
        <p>
          <span class="mask" id="plural-mask">â€¢â€¢â€¢â€¢â€¢â€¢</span>
          <button class="pronunciation-btn hidden" id="plural-audio" data-word="${noun.plural}">ğŸ”Š</button>
        </p>

        <div class="review-row">
          <input class="review-input" id="plural-input" placeholder="è¼¸å…¥ä½ çš„è¤‡æ•¸ç­”æ¡ˆ"/>
          <button class="review-btn primary" id="check-btn">æª¢æŸ¥</button>
          <button class="review-btn" id="toggle-btn">é¡¯ç¤ºç­”æ¡ˆ</button>
        </div>
        <div class="review-feedback" id="review-feedback"></div>
      </div>
    </div>

    <div class="examples">
      <button class="example-toggle">é¡¯ç¤ºä¾‹å¥</button>
      <div class="example-content" style="display:none;">
        <div class="example">
          <div><strong>å–®æ•¸ä¾‹å¥:</strong> ${noun.singular_sentence || "â€”"}</div>
          <button class="pronunciation-btn" data-sentence="${noun.singular_sentence}">ğŸ”Š</button>
        </div>
        <div class="example">
          <div><strong>è¤‡æ•¸ä¾‹å¥:</strong> ${noun.plural_sentence || "â€”"}</div>
          <button class="pronunciation-btn" data-sentence="${noun.plural_sentence}">ğŸ”Š</button>
        </div>
      </div>
    </div>
  </div>`;
}

function bindReviewEvents(detail, noun){
  const input = detail.querySelector("#plural-input");
  const mask = detail.querySelector("#plural-mask");
  const toggle = detail.querySelector("#toggle-btn");
  const check = detail.querySelector("#check-btn");
  const feedback = detail.querySelector("#review-feedback");
  const pluralAudio = detail.querySelector("#plural-audio");

  let revealed = false;

  check.addEventListener("click", ()=>{
    const user = (input.value||"").trim().toLowerCase();
    if(!user){
      feedback.textContent="è«‹å…ˆè¼¸å…¥ç­”æ¡ˆ";
      feedback.className="review-feedback bad";
      return;
    }
    const ok = user === noun.plural.toLowerCase();
    feedback.textContent = ok ? "âœ“ æ­£ç¢ºï¼" : `âœ— å†æƒ³æƒ³ï½ï¼ˆå¯æŒ‰ã€Œé¡¯ç¤ºç­”æ¡ˆã€ï¼‰`;
    feedback.className = "review-feedback " + (ok ? "ok" : "bad");
  });

  toggle.addEventListener("click", ()=>{
    revealed = !revealed;
    if(revealed){
      mask.textContent = noun.plural;
      pluralAudio.classList.remove("hidden");
      toggle.textContent="éš±è—ç­”æ¡ˆ";
    }else{
      mask.textContent="â€¢â€¢â€¢â€¢â€¢â€¢";
      pluralAudio.classList.add("hidden");
      toggle.textContent="é¡¯ç¤ºç­”æ¡ˆ";
      feedback.textContent="";
    }
  });
}

/* =======================
   QUIZ MODE (10é¡Œä¸€èµ· + ä¸€æ¬¡æäº¤)
======================= */
let quizNouns=[], quizAnswers=[];

function initQuizMode(){
  document.getElementById("quiz-start").classList.remove("hidden");
  document.getElementById("quiz-container").classList.add("hidden");
  document.getElementById("quiz-result").classList.add("hidden");
  document.getElementById("quiz-grid").innerHTML="";
  document.getElementById("quiz-hint").innerHTML="";
}

function startQuiz(){
  quizNouns = [...nouns].sort(()=>Math.random()-0.5).slice(0,10);
  quizAnswers = new Array(quizNouns.length).fill("");

  document.getElementById("quiz-start").classList.add("hidden");
  document.getElementById("quiz-container").classList.remove("hidden");
  document.getElementById("quiz-result").classList.add("hidden");

  document.getElementById("quiz-hint").innerHTML =
    `é¡Œå‹æç¤ºï¼šå¯«å‡º<strong>è¤‡æ•¸ (Plural)</strong>`;

  const grid = document.getElementById("quiz-grid");
  grid.innerHTML="";

  quizNouns.forEach((noun,i)=>{
    const item=document.createElement("div");
    item.className="quiz-item";
    item.innerHTML=`
      <div class="quiz-q">
        ${i+1}. ${noun.singular}
        <small>ä¸­æ–‡ï¼š${noun.singular_chinese || "â€”"}</small>
      </div>
      <input class="quiz-input" data-idx="${i}" placeholder="Plural"/>
    `;
    grid.appendChild(item);
  });
}

function submitQuiz(){
  const inputs = document.querySelectorAll(".quiz-input");
  inputs.forEach(inp=>{
    const idx = Number(inp.dataset.idx);
    quizAnswers[idx] = (inp.value||"").trim().toLowerCase();
  });

  // è‹¥æœ‰ç©ºç™½å°±æé†’ï¼Œä½†ä¸é˜»æ­¢æäº¤ï¼ˆå¯ä¾ä½ ç¿’æ…£æ”¹ï¼‰
  const hasEmpty = quizAnswers.some(a=>!a);
  if(hasEmpty && !confirm("æœ‰é¡Œç›®æœªä½œç­”ï¼Œä»è¦æäº¤å—ï¼Ÿ")) return;

  showQuizResult();
}

function showQuizResult(){
  const resultDiv = document.getElementById("quiz-result");
  resultDiv.classList.remove("hidden");

  let score=0, detailHTML="";

  quizNouns.forEach((noun,i)=>{
    const user = quizAnswers[i] || "";
    const ok = user === noun.plural.toLowerCase();
    if(ok) score += 10;

    detailHTML += `
      <div class="result-item ${ok?'correct':'incorrect'}">
        <strong>${i+1}. ${noun.singular}</strong>ï¼ˆ${noun.singular_chinese || "â€”"}ï¼‰<br/>
        ä½ çš„ç­”æ¡ˆï¼š${user || "ï¼ˆç©ºç™½ï¼‰"}<br/>
        æ­£ç¢ºç­”æ¡ˆï¼š${noun.plural}<br/>
        ${ok ? "âœ“ æ­£ç¢º" : "âœ— éŒ¯èª¤"}
      </div>
    `;
  });

  resultDiv.innerHTML = `
    <h3>æ¸¬é©—çµæœ</h3>
    <div class="result-score">${score} / 100</div>
    <p>${score>=60 ? "æ­å–œï¼è¡¨ç¾ä¸éŒ¯ï¼" : "éœ€è¦æ›´å¤šç·´ç¿’ï¼ŒåŠ æ²¹ï¼"}</p>
    <div class="result-details">${detailHTML}</div>
    <button class="quiz-submit" onclick="initQuizMode()">é‡æ–°æ¸¬é©—</button>
  `;
}

/* =======================
   CARD COMMON EVENTS
======================= */
function bindCardEvents(container){
  // pronunciation
  container.querySelectorAll(".pronunciation-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const w = btn.dataset.word;
      const s = btn.dataset.sentence;
      playAudio(w || s);
    });
  });

  // example toggle
  const toggle = container.querySelector(".example-toggle");
  const content = container.querySelector(".example-content");
  if(toggle && content){
    toggle.addEventListener("click", ()=>{
      const show = content.style.display === "none";
      content.style.display = show ? "block":"none";
      toggle.textContent = show ? "éš±è—ä¾‹å¥":"é¡¯ç¤ºä¾‹å¥";
    });
  }
}

/* =======================
   SPEECH
======================= */
function playAudio(text){
  if(!text) return;
  if("speechSynthesis" in window){
    const u=new SpeechSynthesisUtterance(text);
    u.lang="en-US";
    u.rate=0.85;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
  }else{
    alert("ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åˆæˆ");
  }
}
</script>
</body>
</html>
